<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup OS Pro Commander v7.4.0 - Hybrid Kernel Edition</title>
    <link rel="icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        window.BP_LANG = "{{ lang }}";
        window.BP_CONFIG = {{ config | tojson }};
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;600;700&display=swap');
        :root {
            --bg: #0a0b10;
            --card: #11141d;
            --accent: #0084ff;
            --border: #1f2430;
            --glow: 0 0 15px rgba(0, 132, 255, 0.3);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #c0c8d6; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .commander-module { background-color: var(--card); border: 1px solid var(--border); border-radius: 12px; transition: all 0.3s; }
        .commander-module:hover { border-color: #30374a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        
        .sidebar-item { border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s; }
        .sidebar-item:hover { background-color: rgba(0, 132, 255, 0.05); border-left: 4px solid var(--accent); }
        .sidebar-item.active { background-color: rgba(0, 132, 255, 0.1); border-left: 4px solid var(--accent); color: var(--accent); }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1f2430; border-radius: 10px; }
        
        .health-score { font-size: 2.5rem; font-weight: 800; text-shadow: 0 0 15px rgba(0, 132, 255, 0.2); }
        .score-good { color: #00ff88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
        .score-warn { color: #f59e0b; }
        .score-crit { color: #ef4444; }

        .btn-pro { background: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s; box-shadow: var(--glow); }
        .btn-pro:hover { filter: brightness(1.2); transform: translateY(-1px); }

        #hash-modal { background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(12px); display: none; }
        #hash-modal.flex { display: flex; }
        .modal-content { animation: modalIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes modalIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .terminal-log div { margin-bottom: 2px; border-left: 2px solid transparent; padding-left: 10px; }
        .log-success { border-color: #10b981 !important; color: #34d399; }
        .log-error { border-color: #ef4444 !important; color: #f87171; background: rgba(239, 68, 68, 0.05); }
        .log-warn { border-color: #f59e0b !important; color: #fbbf24; }
        .log-info { border-color: #3b82f6 !important; color: #60a5fa; }
        
        .health-mini-bar { height: 3px; background: #1f2430; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .health-mini-fill { height: 100%; background: var(--accent); transition: width 0.5s ease-out; }

        .commander-tooltip { background-color: #1a1b26; border-color: rgba(37, 99, 235, 0.2); color: #e5e7eb; }
        .commander-tooltip strong { color: #60a5fa; }
        .commander-tooltip ul { color: #9ca3af; }
        .commander-tooltip .tooltip-arrow { background-color: #1a1b26; border-left-color: rgba(37, 99, 235, 0.2); border-top-color: rgba(37, 99, 235, 0.2); }

        .delta-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .delta-neutral { background: #1a1e2a; color: #64748b; }
        .delta-plus { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        .delta-minus { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }

        .handbook-item h3 { color: #fff; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 14px; letter-spacing: 0.05em; border-left: 3px solid var(--accent); padding-left: 10px; }
        .handbook-item p { font-size: 14px; line-height: 1.6; margin-bottom: 1.5rem; color: #94a3b8; }
        .handbook-tag { background: rgba(0, 132, 255, 0.15); color: #0084ff; padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 10px; margin-right: 5px; }

        .unit-switch { background: #08090d; border: 1px solid var(--border); padding: 2px; border-radius: 6px; display: flex; gap: 2px; }
        .unit-btn { padding: 4px 10px; font-size: 10px; font-weight: 900; border-radius: 4px; cursor: pointer; transition: all 0.2s; color: #64748b; }
        .unit-btn.active { background: var(--accent); color: white; box-shadow: 0 0 10px rgba(0, 132, 255, 0.3); }
        .unit-btn:not(.active):hover { background: rgba(255,255,255,0.05); color: #c0c8d6; }

        /* --- Klipper-Style Loader --- */
        #startup-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #050505;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .loader-content {
            width: 300px;
            text-align: center;
        }
        .loader-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse-glow 2s infinite;
        }
        .loader-bar-bg {
            width: 100%;
            height: 4px;
            background: #1f2430;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
            position: relative;
        }
        .loader-bar-fill {
            height: 100%;
            background: #0084ff;
            width: 0%;
            animation: load-progress 2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            box-shadow: 0 0 10px #0084ff;
        }
        .loader-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #0084ff;
            margin-top: 0.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        @keyframes pulse-glow {
            0% { filter: drop-shadow(0 0 5px rgba(0,132,255,0.4)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 15px rgba(0,132,255,0.8)); opacity: 1; }
            100% { filter: drop-shadow(0 0 5px rgba(0,132,255,0.4)); opacity: 0.8; }
        }
        @keyframes load-progress {
            0% { width: 0%; }
            30% { width: 40%; }
            70% { width: 80%; }
            100% { width: 100%; }
        }
        
        /* Modal Tabs */
        .modal-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .modal-tab { 
            padding: 10px 20px; 
            font-size: 11px; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: #64748b; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            transition: all 0.2s;
        }
        .modal-tab:hover { color: #94a3b8; }
        .modal-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        
        .file-list { max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .file-list-item { 
            padding: 6px 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 10px; 
            color: #cbd5e1; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-list-item:last-child { border-bottom: none; }
        .file-icon { color: #3b82f6; font-size: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-300" id="bp-root">

    <!-- Startup Loader -->
    <div id="startup-loader">
        <div class="loader-content">
            <img src="/favicon.ico" class="loader-logo" style="width: 130px; height: 130px; object-fit: contain; display: block; margin: 0 auto 20px auto;">
            <div class="text-xl font-black text-white tracking-[0.3em] uppercase mb-1">BACKUP<span class="text-blue-500">OS</span></div>
            <div class="text-[9px] text-slate-500 uppercase tracking-widest mb-6">Hybrid Kernel v7.4</div>
            
            <div class="loader-bar-bg">
                <div class="loader-bar-fill"></div>
            </div>
            <div class="flex justify-between items-center mt-2 w-64">
                 <div class="loader-text" id="loader-msg">INITIALIZING...</div>
                 <div class="loader-text text-blue-500" id="loader-percent">0%</div>
            </div>
            <div id="loader-console" class="text-[9px] font-mono text-slate-600 mt-2 h-4 overflow-hidden text-center uppercase tracking-wider"></div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="hash-modal" class="fixed inset-0 z-[999] items-center justify-center p-4 hidden">
        <div class="modal-content bg-[#11141d] border border-[#0084ff55] w-full max-w-4xl rounded-2xl p-8 relative shadow-2xl text-slate-200 flex flex-col max-h-[90vh]">
            <button onclick="closeHashModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors z-10">‚úï</button>
            
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-blue-500/20 rounded text-blue-400">
                    <img src="/favicon.ico" class="w-6 h-6">
                </div>
                <h3 class="text-lg font-black uppercase tracking-widest text-white">Snapshot Inspektor</h3>
                <div id="lock-badge" class="hidden bg-amber-500/10 text-amber-500 border border-amber-500/20 px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest flex items-center gap-1">
                    <span>üîí</span> RETENTION LOCK
                </div>
            </div>

            <!-- Integrity Result (Prominent) -->
            <div id="integrity-result" class="mb-4 hidden p-3 rounded-lg text-center font-bold text-xs tracking-wide border"></div>

            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchModalTab('meta')">Metadaten</div>
                <div class="modal-tab" onclick="switchModalTab('content')">Inhalt (Dateien)</div>
            </div>

            <div id="tab-meta" class="modal-tab-content space-y-6 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[11px] text-slate-500 uppercase font-black mb-2 block tracking-widest">Dateiname</label>
                        <div id="modal-filename" class="bg-black/40 p-3 rounded border border-white/5 text-sm font-bold text-blue-400 mono truncate">--</div>
                    </div>
                    <div>
                        <label class="text-[11px] text-slate-500 uppercase font-black mb-2 block tracking-widest">Status</label>
                        <div class="flex gap-2">
                            <div class="bg-green-500/10 p-3 rounded border border-green-500/20 text-xs font-bold text-green-500 uppercase flex items-center gap-2 flex-1">
                                <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Verifiziert
                            </div>
                            <button id="btn-lock" onclick="toggleLock()" class="bg-amber-500/10 p-3 rounded border border-amber-500/20 text-amber-500 hover:bg-amber-500/20 transition-colors" title="Retention Lock umschalten">
                                üîì
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="text-[11px] text-slate-500 uppercase font-black mb-2 block tracking-widest">Kommentar</label>
                    <div class="flex gap-2">
                        <input type="text" id="modal-comment" class="flex-1 bg-black/40 border border-white/5 rounded p-3 text-xs text-white outline-none focus:border-blue-500 transition-colors" placeholder="Kein Kommentar...">
                        <button onclick="saveComment()" class="px-4 bg-blue-600/20 border border-blue-600/40 text-blue-400 rounded hover:bg-blue-600/30 transition-colors text-[10px] font-black uppercase tracking-widest">Save</button>
                    </div>
                </div>

                <div>
                    <label class="text-[11px] text-slate-500 uppercase font-black mb-2 block tracking-widest">SHA256 Signatur</label>
                    <div id="modal-hash" class="bg-black/40 p-4 rounded border border-white/5 text-[11px] mono text-white break-all leading-relaxed shadow-inner"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-6 bg-black/20 p-4 rounded-xl">
                    <div><label class="text-[11px] text-slate-500 uppercase font-black block mb-1">Zeitpunkt</label><div id="modal-ts" class="text-sm font-bold text-white"></div></div>
                    <div><label class="text-[11px] text-slate-500 uppercase font-black block mb-1">Gr√∂√üe</label><div id="modal-size" class="text-sm font-bold text-white"></div></div>
                </div>

                <div class="border-t border-white/5 pt-6">
                    <label class="text-[11px] text-slate-500 uppercase font-black mb-4 block tracking-widest">Erweiterte Aktionen</label>
                    <div class="flex gap-4">
                        <button onclick="verifyIntegrity()" id="btn-integrity" class="flex-1 bg-emerald-900/10 py-3 rounded text-[11px] font-black uppercase tracking-widest hover:bg-emerald-900/20 transition-all text-emerald-500 border border-emerald-500/20 flex items-center justify-center gap-2">
                            <span>‚ö°</span> Integrit√§t Pr√ºfen (Deep Scan)
                        </button>
                        <button id="modal-delete-btn" class="flex-1 bg-red-900/10 py-3 rounded text-[11px] font-black uppercase tracking-widest hover:bg-red-900/20 transition-all text-red-500 border border-red-500/20 flex items-center justify-center gap-2">
                            <span>‚úï</span> Snapshot L√∂schen
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-content" class="modal-tab-content hidden flex-1 flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-[11px] text-slate-500 uppercase font-black tracking-widest">Enthaltene Dateien</span>
                    <span id="file-count-badge" class="text-[10px] bg-white/10 px-2 py-1 rounded text-white font-mono">-- Files</span>
                </div>
                <div id="zip-file-list" class="file-list flex-1">
                    <div class="p-8 text-center text-slate-500 text-xs uppercase tracking-widest animate-pulse">Lade Dateistruktur...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Shutdown Modal Removed -->

    <!-- Sidebar -->
    <!-- Mobile Sidebar Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
    <aside id="main-sidebar" class="fixed inset-y-0 left-0 w-64 bg-[#0d0f16] border-r border-[#1a1e2a] flex flex-col z-50 transform transition-transform duration-300 -translate-x-full md:relative md:translate-x-0">
        <div class="p-6 border-b border-[#1a1e2a] flex items-center gap-3">
            <div>
                <img src="/favicon.ico" class="w-10 h-10 object-contain">
            </div>
            <div class="flex flex-col">
                <span class="font-black text-white leading-none">BACKUP OS</span>
                <span class="text-[10px] text-[#0084ff] font-bold tracking-widest uppercase">Commander Pro</span>
            </div>
        </div>

        <nav class="flex-1 mt-6">
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active px-6 py-4 flex items-center gap-4">
                <span class="text-sm font-bold text-white font-mono" data-i18n="nav.dashboard">01 ZENTRALE</span>
            </div>
            <div onclick="switchTab('restore')" id="nav-restore" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500">
                <span class="text-sm font-bold font-mono" data-i18n="nav.restore">02 RESTORE</span>
            </div>
            <div onclick="switchTab('cloud')" id="nav-cloud" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500">
                <span class="text-sm font-bold font-mono" data-i18n="nav.cloud">03 CLOUD</span>
            </div>
            <div onclick="switchTab('duplicates')" id="nav-duplicates" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500">
                <span class="text-sm font-bold font-mono" data-i18n="nav.duplicates">04 ANALYSE</span>
            </div>
            <div onclick="switchTab('settings')" id="nav-settings" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500">
                <span class="text-sm font-bold font-mono" data-i18n="nav.settings">05 PARAMETER</span>
            </div>
            <div onclick="switchTab('tasks')" id="nav-tasks" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500">
                <span class="text-sm font-bold font-mono" data-i18n="nav.tasks">06 TASKS</span>
            </div>
            <div onclick="switchTab('help')" id="nav-help" class="sidebar-item px-6 py-4 flex items-center gap-4 text-slate-500 border-t border-white/5 mt-4">
                <span class="text-sm font-bold font-mono text-blue-400" data-i18n="nav.help">?? HANDBUCH</span>
            </div>
            
            <div onclick="openBugReportModal()" class="sidebar-item px-6 py-4 flex items-center gap-3 text-slate-500 cursor-pointer hover:bg-white/5 transition-colors" title="Bug auf GitHub melden" data-i18n-title="nav.bugreportTitle">
                <span class="text-[11px] text-red-400">üêú</span>
                <span class="text-sm font-bold font-mono text-slate-300" data-i18n="nav.bugreport">Fehler melden</span>
            </div>
        </nav>

        <div class="p-6 bg-[#08090d] border-t border-[#1a1e2a]">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[10px] uppercase font-black text-slate-500 tracking-tighter">Drive Telemetrie</span>
                <span id="disk-percent" class="text-[11px] font-bold text-blue-400">--%</span>
            </div>
            <div class="w-full bg-[#1a1e2a] h-2 rounded-full overflow-hidden mb-2 relative">
                <div id="disk-bar" class="bg-blue-500 h-full w-0 transition-all duration-1000 shadow-[0_0_8px_rgba(0,132,255,0.4)] relative z-10"></div>
                <!-- Tech Stripe Pattern -->
                <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(45deg, #000 25%, transparent 25%, transparent 50%, #000 50%, #000 75%, transparent 75%, transparent); background-size: 4px 4px;"></div>
            </div>
            
            <div id="disk-details" class="grid grid-cols-3 gap-1 text-[9px] font-bold mono text-slate-600 uppercase mb-4 text-center">
                 <div class="flex flex-col items-start">
                     <span class="text-[8px] text-slate-700 tracking-wider">Belegt</span>
                     <span id="disk-used-val" class="text-blue-400">--</span>
                 </div>
                 <div class="flex flex-col items-center">
                     <span class="text-[8px] text-slate-700 tracking-wider">Frei</span>
                     <span id="disk-free-val" class="text-slate-400">--</span>
                 </div>
                 <div class="flex flex-col items-end">
                     <span class="text-[8px] text-slate-700 tracking-wider">Total</span>
                     <span id="disk-total-val" class="text-slate-400">--</span>
                 </div>
            </div>
            
            <div id="disk-warning" class="hidden mb-4 p-2 bg-red-500/10 border border-red-500/20 rounded text-center animate-pulse">
                <span class="text-[9px] font-black text-red-500 uppercase tracking-widest">‚ö† Speicher kritisch</span>
            </div>
            
            <!-- Copyright Safe Zone -->
            <div class="pt-3 border-t border-white/5 text-center">
                <p class="text-[9px] font-black text-slate-700 uppercase tracking-widest hover:text-slate-500 transition-colors cursor-default">
                    &copy; 2025 Exulizer
                </p>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-14 bg-[#0d0f16] border-b border-[#1a1e2a] flex items-center justify-between px-4 md:px-8">
            <div class="flex items-center gap-3 md:gap-4">
                <!-- Hamburger Menu -->
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white transition-colors p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#10b981]"></span>
                <span class="text-[12px] font-black uppercase tracking-widest text-white">v7.4 <span class="hidden sm:inline">Hybrid Kernel</span><span class="hidden xl:inline"> | Creator: Exulizer</span></span>
            </div>
            <div class="flex items-center gap-2 md:gap-6">
                <div class="flex items-center gap-2 md:gap-4 mr-2 md:mr-4">
                    <span class="text-[10px] font-black uppercase text-slate-500 tracking-widest hidden md:block">Unit Engine</span>
                    <div class="unit-switch" id="global-unit-switch">
                        <div onclick="setGlobalUnit('MB')" id="unit-mb" class="unit-btn active">MB</div>
                        <div onclick="setGlobalUnit('GB')" id="unit-gb" class="unit-btn">GB</div>
                    </div>
                </div>
                <div class="flex flex-col items-end border-l border-white/5 pl-3 md:pl-6">
                    <span id="header-date" class="text-[11px] font-bold text-slate-400 mono">--.--.----</span>
                    <span id="header-time" class="text-[14px] font-black text-blue-400 mono">00:00:00</span>
                </div>
            </div>
        </header>

        <!-- Tab: Dashboard -->
        <section id="tab-dashboard" class="tab-content flex-1 overflow-y-auto p-8">
            <div id="dashboard-modules" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Module: Health -->
                <div id="module-health" class="commander-module p-5 relative group" data-id="health">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="absolute top-full left-0 mt-2 w-full border text-[10px] px-3 py-3 rounded shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 text-left leading-relaxed backdrop-blur-sm transform translate-y-2 group-hover:translate-y-0 commander-tooltip">
                        <strong class="text-blue-400 block mb-1" data-i18n="dashboard.healthTitle">‚ÑπÔ∏è System Health Score</strong>
                        <p class="mb-1" data-i18n="dashboard.healthDesc">Berechnet den Gesundheitszustand basierend auf Backup-Konsistenz und Speicherplatz. (Drag & Drop m√∂glich)</p>
                        <ul class="list-disc list-inside space-y-0.5">
                            <li><span class="font-bold">COV:</span> <span data-i18n="dashboard.covDesc">Coverage (Abdeckung/H√§ufigkeit)</span></li>
                            <li><span class="font-bold">REC:</span> <span data-i18n="dashboard.recDesc">Recoverability (Wiederherstellbarkeit)</span></li>
                            <li><span class="font-bold">DSK:</span> <span data-i18n="dashboard.diskDesc">Disk Space (Speicherplatz)</span></li>
                        </ul>
                        <div class="absolute -top-1 left-8 w-2 h-2 rotate-45 tooltip-arrow"></div>
                    </div>

                    <div class="flex justify-between items-start mb-2">
                         <span class="text-[11px] uppercase font-black text-slate-500 tracking-widest cursor-help" data-i18n="dashboard.healthLabel">System Health</span>
                         <span id="health-label" class="text-[9px] font-black text-blue-400 uppercase tracking-tighter">--</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="health-score" id="score-val">--</span>
                        <span class="text-[12px] font-black text-slate-600">%</span>
                    </div>
                    <div id="health-breakdown" class="mt-4 grid grid-cols-3 gap-3 border-t border-white/5 pt-3">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-[9px] uppercase text-slate-500 font-bold">COV</span>
                                <span id="val-cov" class="text-[9px] font-mono text-blue-400">0%</span>
                            </div>
                            <div class="health-mini-bar"><div id="bar-cov" class="health-mini-fill" style="width: 0%"></div></div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-[9px] uppercase text-slate-500 font-bold">REC</span>
                                <span id="val-rec" class="text-[9px] font-mono text-blue-400">0%</span>
                            </div>
                            <div class="health-mini-bar"><div id="bar-rec" class="health-mini-fill" style="width: 0%"></div></div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-[9px] uppercase text-slate-500 font-bold">DSK</span>
                                <span id="val-disk" class="text-[9px] font-mono text-blue-400">0%</span>
                            </div>
                            <div class="health-mini-bar"><div id="bar-disk" class="health-mini-fill" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-[9px] uppercase text-slate-500 font-bold" data-i18n="dashboard.integrityLabel">System Integrit√§t</span>
                        <div class="flex items-center gap-2">
                            <span id="integrity-dot" class="w-2 h-2 rounded-full bg-slate-600"></span>
                            <span id="integrity-text" class="text-[10px] font-mono text-slate-400">--</span>
                        </div>
                    </div>
                </div>

                <!-- Module: Volume -->
                <div id="module-volume" class="commander-module p-5 relative group" data-id="volume">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="absolute top-full left-0 mt-2 w-full border text-[10px] px-3 py-3 rounded shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 text-left leading-relaxed backdrop-blur-sm transform translate-y-2 group-hover:translate-y-0 commander-tooltip">
                        <strong class="text-blue-400 block mb-1" data-i18n="dashboard.volumeTitle">‚ÑπÔ∏è Archive Volume Stats</strong>
                        <p class="mb-1" data-i18n="dashboard.volumeDesc">Zeigt den gesamten Speicherplatzverbrauch aller gespeicherten Backups sowie die Anzahl der Snapshots. (Drag & Drop m√∂glich)</p>
                        <ul class="list-disc list-inside space-y-0.5">
                            <li><span class="font-bold" data-i18n="dashboard.snapshotsLabel">Snapshots:</span> <span data-i18n="dashboard.snapDesc">Anzahl der Sicherungspunkte.</span></li>
                            <li><span class="font-bold" data-i18n="dashboard.volumeLabel">Volume:</span> <span data-i18n="dashboard.volDesc">Physischer Speicher auf dem Datentr√§ger.</span></li>
                        </ul>
                        <div class="absolute -top-1 left-8 w-2 h-2 rotate-45 tooltip-arrow"></div>
                    </div>

                    <span class="text-[11px] uppercase font-black text-slate-500 block mb-2 tracking-widest cursor-help" data-i18n="dashboard.volumeLabel">Archive Volume</span>
                    <div class="flex items-baseline gap-1 mt-4">
                        <span class="text-3xl font-black text-white card-number" id="total-val-display">0.00</span>
                        <span class="text-[12px] font-bold text-slate-600" id="total-unit-display">MB</span>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/5">
                        <span class="text-[9px] uppercase text-slate-500 font-bold tracking-wider" data-i18n="dashboard.snapshotsLabel">Snapshots</span>
                        <span id="total-snapshots-display" class="text-[10px] font-mono text-blue-400">0</span>
                    </div>
                </div>

                <!-- Module: Delta -->
                <div id="module-delta" class="commander-module p-5 relative group" data-id="delta">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="absolute top-full left-0 mt-2 w-full border text-[10px] px-3 py-3 rounded shadow-2xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 text-left leading-relaxed backdrop-blur-sm transform translate-y-2 group-hover:translate-y-0 commander-tooltip">
                        <strong class="text-blue-400 block mb-1" data-i18n="dashboard.deltaTitle">‚ÑπÔ∏è Workspace Delta Monitor</strong>
                        <p class="mb-1" data-i18n="dashboard.deltaDesc">Vergleicht live den Inhalt Ihres lokalen Ordners mit dem letzten Backup desselben Ordners. (Drag & Drop m√∂glich)</p>
                        <ul class="list-disc list-inside space-y-0.5">
                            <li><span class="font-bold">Initial:</span> <span data-i18n="dashboard.deltaInitial">Noch kein Vergleich m√∂glich (erster Snapshot).</span></li>
                            <li><span class="font-bold">Remote:</span> <span data-i18n="dashboard.deltaRemote">Zeigt Cloud-Daten im Download-Modus.</span></li>
                        </ul>
                        <div class="absolute -top-1 left-8 w-2 h-2 rotate-45 tooltip-arrow"></div>
                    </div>

                    <span class="text-[11px] uppercase font-black text-slate-500 block mb-3 tracking-widest flex justify-between items-center cursor-help">
                        <span class="border-b border-dashed border-slate-700" data-i18n="dashboard.deltaLabel">Workspace Delta</span>
                        <span id="delta-mode-badge" class="text-[9px] px-1.5 py-0.5 rounded bg-white/5 text-slate-500">LOCAL</span>
                    </span>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-[9px] uppercase text-slate-600 font-bold block mb-1" data-i18n="dashboard.sizeLabel">Gr√∂√üe</span>
                            <div class="flex items-baseline gap-1">
                                <span id="delta-size-val" class="text-xl font-black text-white card-number">--</span>
                            </div>
                            <span id="delta-size-badge" class="text-[10px] font-bold text-slate-500 block mt-1">--</span>
                        </div>
                        <div class="pl-4 border-l border-white/5">
                            <span class="text-[9px] uppercase text-slate-600 font-bold block mb-1" data-i18n="dashboard.filesLabel">Dateien</span>
                            <div class="flex items-baseline gap-1">
                                <span id="delta-files-val" class="text-xl font-black text-white card-number">--</span>
                            </div>
                            <span id="delta-files-badge" class="text-[10px] font-bold text-slate-500 block mt-1">--</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/5">
                        <span class="text-[9px] uppercase text-slate-500 font-bold tracking-wider" data-i18n="dashboard.refLabel">Ref</span>
                        <span id="delta-ref-info" class="text-[9px] font-mono text-slate-400 truncate max-w-[120px]" title="Vergleichsbasis" data-i18n-title="dashboard.refLabel">--</span>
                    </div>
                </div>

                <!-- Module: Action (Backup Button) -->
                <div id="module-action" class="commander-module relative p-5 bg-blue-500/5 border-blue-500/20 group text-center flex items-center justify-center" data-id="action">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <button onclick="runBackup()" id="main-action" class="w-full h-full flex flex-col items-center justify-center gap-3">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-xl shadow-blue-500/20 text-xl">‚ö°</div>
                        <span class="text-[11px] font-black uppercase text-blue-400 tracking-widest" data-i18n="dashboard.createSnapshot">Snapshot anlegen</span>
                    </button>
                </div>

                <!-- Module: Chart -->
                <div id="module-chart" class="commander-module relative p-6 lg:col-span-4" data-id="chart">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="text-sm font-black uppercase text-slate-400 tracking-widest" data-i18n="dashboard.chartTitle">Backup Verlauf & Aktivit√§t</h3>
                            <p class="text-xs text-slate-500 mt-1" data-i18n="dashboard.chartDesc">Visuelle Darstellung der Backup-Integrit√§t und Volumina √ºber die Zeit. (Drag & Drop m√∂glich)</p>
                        </div>
                        <div class="flex gap-2 text-[10px] font-bold text-slate-500 uppercase">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> <span data-i18n="dashboard.legendVol">Volumen</span></span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> <span data-i18n="dashboard.legendBackup">Tag mit Backup</span></span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full border border-red-500 bg-transparent"></span> <span data-i18n="dashboard.legendNoBackup">Kein Backup</span></span>
                        </div>
                    </div>

                    <!-- Live Stats Bar -->
                    <div id="activity-stats-bar" class="grid grid-cols-3 gap-4 mb-4 opacity-50">
                        <!-- Will be populated by JS -->
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="relative h-48 w-full bg-black/20 rounded-lg border border-white/5 overflow-hidden group" id="activity-chart-container">
                        <!-- SVG will be injected here -->
                        <div class="absolute inset-0 flex items-center justify-center text-xs text-slate-600 font-mono">
                            Lade Statistik...
                        </div>
                    </div>
                </div>

                <!-- Module: Planer -->
                <div id="module-planer" class="commander-module p-5 relative overflow-hidden lg:col-span-4" data-id="planer">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <div>
                            <span class="text-[11px] uppercase font-black text-slate-500 tracking-widest flex items-center gap-2">
                                <span data-i18n="dashboard.planTitle">Backup-Planer</span>
                                <span class="px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 text-[9px]" id="plan-count-badge">0</span>
                            </span>
                            <p class="text-[10px] text-slate-500 mt-1" data-i18n="dashboard.planDesc">N√§chste geplante Ausf√ºhrungen. (Drag & Drop m√∂glich)</p>
                        </div>
                    </div>
                    
                    <div id="backup-plan-list" class="space-y-2 max-h-[120px] overflow-y-auto custom-scrollbar relative z-10 pr-1">
                        <!-- List Items Injected via JS -->
                        <div class="text-[10px] text-slate-600 italic text-center py-4" data-i18n="dashboard.planEmpty">Keine aktiven Pl√§ne</div>
                    </div>
                </div>

                <!-- Module: Manual Snapshot -->
                <div id="module-manual" class="commander-module relative p-6 lg:col-span-2 space-y-6" data-id="manual">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <h2 class="text-sm font-black uppercase tracking-widest text-slate-400 border-b border-white/5 pb-3" data-i18n="dashboard.manualSnapshotTitle">Manueller Snapshot</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[11px] font-black uppercase text-slate-500 mb-1 block tracking-widest" data-i18n="dashboard.sourceLabel">Quelle</label>
                                <input type="text" id="source" readonly class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-blue-300 outline-none">
                            </div>
                            <div>
                                <label class="text-[11px] font-black uppercase text-slate-500 mb-1 block tracking-widest" data-i18n="dashboard.targetLabel">Ziel</label>
                                <input type="text" id="dest" readonly class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-emerald-300 outline-none">
                            </div>
                            <div>
                                <label class="text-[11px] font-black uppercase text-slate-500 mb-1 block tracking-widest" data-i18n="dashboard.commentLabel">Kommentar</label>
                                <input type="text" id="snap-comment" placeholder="Zweck der Sicherung..." data-i18n-placeholder="dashboard.commentPlaceholder" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500">
                            </div>
                        </div>
                        <div class="bg-[#08090d] p-6 rounded-xl border border-white/5">
                            <span class="text-[11px] font-black uppercase text-slate-600 mb-2 block tracking-widest" data-i18n="dashboard.sourceState">Quell-Zustand</span>
                            <div id="src-size" class="text-3xl font-black text-white">--</div>
                            <div id="src-files" class="text-[11px] mono text-blue-500 font-bold mt-2 uppercase tracking-widest">-- FILES</div>
                            
                            <!-- Progress Area moved to Terminal -->
                        </div>
                    </div>
                </div>

                <!-- Module: Terminal -->
                <div id="module-terminal" class="commander-module relative p-6 flex flex-col h-full min-h-[250px] lg:col-span-2" data-id="terminal">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-3">
                        <h2 class="text-sm font-black uppercase tracking-widest text-slate-400" data-i18n="dashboard.terminalTitle">Command Terminal</h2>
                        <div class="flex gap-2">
                             <button onclick="document.getElementById('log').innerHTML=''" class="text-[9px] font-black uppercase text-slate-500 hover:text-white transition-colors" title="Log leeren" data-i18n-title="dashboard.clearLog" data-i18n="dashboard.clearBtn">CLEAR</button>
                             <button onclick="cancelBackup()" class="text-[9px] font-black uppercase text-red-500 hover:text-red-400 transition-colors border border-red-500/20 px-2 rounded hover:bg-red-500/10" title="Laufenden Prozess abbrechen" data-i18n-title="dashboard.cancelBackup" data-i18n="dashboard.cancelBtn">ABBRECHEN</button>
                        </div>
                    </div>
                    <div id="log" class="terminal-log h-[200px] bg-[#050608] p-4 rounded-lg mono text-[11px] space-y-1 overflow-y-auto border border-white/10 mb-4 shadow-inner"></div>

                    <!-- Permanent Console Status & Progress -->
                    <div id="console-status-area" class="bg-[#08090d] p-4 rounded-lg border border-blue-500/20 shadow-lg shadow-blue-900/10">
                        <div class="flex justify-between items-center mb-2">
                             <div class="flex items-center gap-2">
                                 <div id="status-indicator" class="w-2 h-2 rounded-full bg-slate-600 transition-colors duration-300"></div>
                                 <span id="console-status-text" class="text-[10px] font-black uppercase tracking-widest text-slate-400" data-i18n="dashboard.systemReady">System Bereit</span>
                             </div>
                             <span id="zipPercent" class="text-[10px] font-mono text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-[#0a0b10] h-2 rounded-full overflow-hidden border border-white/5 relative">
                            <div id="zipBar" class="bg-blue-500 h-full w-0 transition-all duration-300 relative"></div>
                        </div>
                    </div>
                </div>

                <!-- Module: Telemetry -->
                <div id="module-telemetry" class="commander-module relative p-6 lg:col-span-4" data-id="telemetry">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-sm font-black uppercase tracking-widest text-slate-400" data-i18n="dashboard.telemetryTitle">Wachstums-Telemetrie (Historisch)</h2>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center gap-2 bg-black/20 px-2 py-1 rounded border border-white/5">
                                <input type="checkbox" id="chart-log-scale" onchange="toggleChartScale()" class="w-3 h-3 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                <label for="chart-log-scale" class="text-[9px] font-black uppercase text-slate-500 cursor-pointer select-none tracking-wider hover:text-blue-400 transition-colors" data-i18n="dashboard.logScale">Log-Skala</label>
                             </div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full relative">
                        <canvas id="storageChart"></canvas>
                    </div>
                    <div class="mt-1 flex justify-end">
                        <div class="bg-black/70 px-2 py-1 rounded border border-white/10 text-[9px] text-slate-400 flex items-center gap-2">
                            <span class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full" style="background-color: hsl(200,80%,70%);"></span>
                                <span class="uppercase tracking-wider" data-i18n="dashboard.legendNew">Neu</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="w-3 h-3 rounded-full" style="background-color: hsl(280,80%,40%);"></span>
                                <span class="uppercase tracking-wider" data-i18n="dashboard.legendOld">Alt</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Module: History -->
                <div id="module-history" class="commander-module relative p-6 lg:col-span-4" data-id="history">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <h2 class="text-[12px] text-slate-500 uppercase font-bold mb-6 tracking-widest">
                        <span data-i18n="dashboard.historyTitle">Snapshot Historie</span>
                        <span id="total-snaps-badge" class="ml-2 bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded text-[10px] border border-blue-500/20">0</span>
                    </h2>
                    
                    <div class="flex gap-2 mb-4 items-center">
                        <button onclick="window.clearHistory()" class="text-[10px] font-black uppercase bg-red-500/10 border border-red-500/20 px-3 py-1 rounded text-red-400 hover:bg-red-500/20 transition-all tracking-widest" data-i18n="dashboard.clearHistoryBtn">
                            Historie leeren
                        </button>
                        <button onclick="window.toggleSort()" id="btn-sort" class="text-[10px] font-black uppercase bg-blue-500/10 border border-blue-500/20 px-3 py-1 rounded text-blue-400 hover:bg-blue-500/20 transition-all tracking-widest min-w-[140px]" data-i18n="dashboard.sortBtn">
                            Sort: Datum (Neu)
                        </button>
                        <button onclick="window.refreshHistory()" title="Aktualisieren" data-i18n-title="dashboard.refreshBtn" class="text-[10px] font-black uppercase bg-emerald-500/10 border border-emerald-500/20 px-2 py-1 rounded text-emerald-400 hover:bg-emerald-500/20 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" id="btn-refresh-hist" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                        <div class="ml-auto flex items-center gap-2">
                             <span class="text-[10px] font-black uppercase text-slate-500 tracking-widest" data-i18n="dashboard.limitLabel">Limit:</span>
                             <select id="history-limit" onchange="window.updateHistoryLimit()" class="bg-[#08090d] border border-white/5 rounded px-2 py-1 text-[10px] font-black uppercase text-blue-400 outline-none">
                                 <option value="5">5</option>
                                 <option value="10" selected>10</option>
                                 <option value="25">25</option>
                                 <option value="50">50</option>
                                 <option value="100">100</option>
                                 <option value="all" data-i18n="dashboard.limitAll">Alle</option>
                             </select>
                             <button onclick="window.prevHistoryPage()" class="text-[10px] font-black uppercase bg-white/5 border border-white/10 px-2 py-1 rounded text-slate-300 hover:bg-white/10 transition-all">&lt;</button>
                             <span id="history-page-label" class="text-[10px] font-mono text-slate-500 min-w-[40px] text-center"></span>
                             <button onclick="window.nextHistoryPage()" class="text-[10px] font-black uppercase bg-white/5 border border-white/10 px-2 py-1 rounded text-slate-300 hover:bg-white/10 transition-all">&gt;</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm">
                            <thead><tr class="text-slate-500 uppercase text-[10px] font-black"><th class="px-4 py-3">Datum</th><th class="px-4 py-3">Datei</th><th class="px-4 py-3 text-right" id="history-size-header">Gr√∂√üe</th></tr></thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Restore -->
        <section id="tab-restore" class="tab-content flex-1 overflow-y-auto p-8 space-y-6 hidden">
            <div class="commander-module p-6">
                <h2 class="text-sm font-black uppercase tracking-widest text-slate-400 border-b border-white/5 pb-3 mb-6" data-i18n="restore.title">Wiederherstellungs-Zentrum</h2>
                <div class="overflow-x-auto text-slate-200">
                    <table class="min-w-full text-left text-sm">
                        <thead><tr class="bg-[#0d0f16]"><th class="px-4 py-3" data-i18n="restore.tableTime">Zeitpunkt</th><th class="px-4 py-3" data-i18n="restore.tableArchive">Archiv</th><th class="px-4 py-3" data-i18n="restore.tableAction">Aktion</th></tr></thead>
                        <tbody id="restore-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab: Cloud -->
        <section id="tab-cloud" class="tab-content flex-1 overflow-y-auto hidden text-slate-200" style="scrollbar-gutter: stable;">
            <div class="max-w-5xl mx-auto p-8 space-y-12">
                
                <!-- MODULE 1: CLOUD STORAGE TARGET -->
                <div id="module-cloud-tresor" class="commander-module relative overflow-hidden group">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <!-- Decorator Line Removed -->
                    
                    <div class="p-8 space-y-8">
                        <div class="flex items-center justify-between border-b border-white/5 pb-6">
                            <div>
                                <h2 class="text-lg font-black uppercase text-slate-200 tracking-wide" data-i18n="cloud.tresorTitle">Cloud Tresor</h2>
                                <p class="text-xs text-slate-500 mt-1" data-i18n="cloud.tresorSubtitle">Sichere deine Backups verschl√ºsselt auf externen Servern.</p>
                                <button onclick="saveProfile()" class="mt-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 rounded px-2 py-1 text-[9px] font-black uppercase transition-colors" title="Speichert Status" data-i18n="cloud.saveButton" data-i18n-title="cloud.saveButtonTitle">üíæ Speichern</button>
                            </div>
                            <div class="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-lg border border-white/5">
                                <input type="checkbox" id="config-cloud-enabled" onchange="updateCloudTresorUI()" class="w-4 h-4 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                <label for="config-cloud-enabled" class="text-[10px] font-black text-blue-400 uppercase tracking-wider cursor-pointer select-none" data-i18n="cloud.enabledLabel">Aktiviert</label>
                            </div>
                        </div>

                        <!-- Main Configuration Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            <!-- Left Column: Settings -->
                            <div class="lg:col-span-8 space-y-6">
                                
                                <!-- Provider & Path -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-black/20 p-4 rounded-xl border border-white/5">
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.serviceProviderLabel">Service Provider</label>
                                        <select id="config-cloud-provider" onchange="updateCloudTresorUI()" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 transition-colors">
                                            <option>SFTP</option>
                                            <option>FTP</option>
                                            <option>Dropbox</option>
                                            <option>S3 (Amazon)</option>
                                            <option>WebDAV</option>
                                        </select>
                                    </div>
                                    <div class="bg-black/20 p-4 rounded-xl border border-white/5">
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.directionLabel">Backup Richtung</label>
                                        <select id="config-cloud-direction" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 transition-colors">
                                            <option value="upload" data-i18n="cloud.directionUploadOption">Upload (Lokal -> Cloud)</option>
                                            <option value="download" data-i18n="cloud.directionDownloadOption">Download (Cloud -> Lokal)</option>
                                        </select>
                                    </div>
                                    <div class="bg-black/20 p-4 rounded-xl border border-white/5 md:col-span-2">
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.remotePathLabel">Remote Path / Ordner</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="config-cloud-path" placeholder="/backups/pro" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-blue-400 outline-none focus:border-blue-500/50 font-mono transition-colors" data-i18n-placeholder="cloud.remotePathPlaceholder">
                                        </div>
                                    </div>
                                    
                                    <!-- Local Download Path (Hidden by default, shown for Download direction) -->
                                    <div id="cloud-local-path-group" class="bg-black/20 p-4 rounded-xl border border-white/5 md:col-span-2 hidden">
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.localTargetLabel">Lokaler Zielordner (Download)</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="config-cloud-local-path" placeholder="C:/Users/Backups/Download" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-green-400 outline-none focus:border-green-500/50 font-mono transition-colors">
                                            <button onclick="pickFolder('config-cloud-local-path')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Ordner w√§hlen">üìÅ</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Naming Options (NEW) -->
                                <div class="bg-black/20 p-4 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.namingTitle">Backup Name & Optionen</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                             <input type="text" id="cloud-naming-custom" placeholder="backup-name" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono transition-colors">
                                        </div>
                                        <div class="flex items-center gap-3">
                                             <label class="flex items-center gap-2 cursor-pointer">
                                                 <input type="checkbox" id="cloud-naming-date" checked class="w-3 h-3 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                                 <span class="text-[10px] text-slate-400 font-bold uppercase select-none" data-i18n="cloud.namingDateLabel">Datum</span>
                                             </label>
                                             <label class="flex items-center gap-2 cursor-pointer">
                                                 <input type="checkbox" id="cloud-naming-time" checked class="w-3 h-3 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                                 <span class="text-[10px] text-slate-400 font-bold uppercase select-none" data-i18n="cloud.namingTimeLabel">Zeit</span>
                                             </label>
                                             <label class="flex items-center gap-2 cursor-pointer">
                                                 <input type="checkbox" id="cloud-naming-seq" class="w-3 h-3 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                                 <span class="text-[10px] text-slate-400 font-bold uppercase select-none" data-i18n="cloud.namingSeqLabel">Seq</span>
                                             </label>
                                             <label class="flex items-center gap-2 cursor-pointer ml-2 border-l border-white/10 pl-2">
                                                 <input type="checkbox" id="cloud-zip-download" class="w-3 h-3 bg-[#08090d] border-white/10 rounded accent-green-500 cursor-pointer">
                                                 <span class="text-[10px] text-slate-400 font-bold uppercase select-none" data-i18n="cloud.zipDownloadLabel">Zip Download</span>
                                             </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dynamic Auth Fields (JS controlled visibility) -->
                                <div class="bg-black/20 p-6 rounded-xl border border-white/5 space-y-6 relative overflow-hidden">
                                     
                                     <!-- Host Group -->
                                    <div id="cloud-host-group" class="grid grid-cols-4 gap-4">
                                         <div class="col-span-3">
                                             <label id="lbl-cloud-host" class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.hostLabel">Server Host / IP</label>
                                             <input type="text" id="config-cloud-host" placeholder="z.B. 192.168.1.100" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono" data-i18n-placeholder="cloud.hostPlaceholder">
                                         </div>
                                         <div>
                                             <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.portLabel">Port</label>
                                             <input type="number" id="config-cloud-port" placeholder="22" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-slate-400 outline-none focus:border-blue-500/50 font-mono">
                                         </div>
                                    </div>

                                    <!-- S3 Group -->
                                    <div id="cloud-s3-group" class="grid grid-cols-2 gap-4 hidden">
                                         <div>
                                             <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.bucketLabel">S3 Bucket Name</label>
                                             <input type="text" id="config-cloud-bucket" placeholder="my-backup-bucket" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono">
                                         </div>
                                         <div>
                                             <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.regionLabel">Region</label>
                                             <input type="text" id="config-cloud-region" placeholder="eu-central-1" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono">
                                         </div>
                                    </div>

                                    <!-- Auth Group -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="cloud-auth-group">
                                        <div id="cloud-user-wrap">
                                             <label id="lbl-cloud-user" class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.userLabel">Benutzer / Access ID</label>
                                             <input type="text" id="config-cloud-user" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono">
                                        </div>
                                        <div>
                                             <label id="lbl-cloud-pass" class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.passwordLabel">Passwort / Secret / Token</label>
                                             <div class="relative">
                                                <input type="password" id="config-cloud-password" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-yellow-500 outline-none focus:border-yellow-500/50 pr-10 font-mono">
                                                <button onclick="togglePassword('config-cloud-password', this)" class="absolute right-0 top-0 h-full px-3 text-slate-500 hover:text-white focus:outline-none flex items-center justify-center transition-colors" tabindex="-1">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                                </button>
                                             </div>
                                        </div>
                                    </div>
                                    
                                    <!-- API Key -->
                                    <div>
                                         <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.apiKeyLabel">Optionaler API-Key</label>
                                         <div class="relative">
                                            <input type="password" id="config-cloud-api-key" placeholder="Leer lassen falls nicht ben√∂tigt" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-slate-400 outline-none focus:border-blue-500/50 font-mono pr-10" data-i18n-placeholder="cloud.apiKeyPlaceholder">
                                            <button onclick="togglePassword('config-cloud-api-key', this)" class="absolute right-0 top-0 h-full px-3 text-slate-500 hover:text-white focus:outline-none flex items-center justify-center transition-colors" tabindex="-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                            </button>
                                         </div>
                                    </div>

                                    <!-- Actions (Moved) -->
                                    <div class="grid grid-cols-3 gap-2 pt-2">
                                        <button onclick="runCloudBackupNow()" class="w-full bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 border border-blue-500/30 py-3 rounded text-[10px] font-bold uppercase tracking-wide transition-all truncate" title="Backup Jetzt & Upload" data-i18n-title="cloud.backupNowTitle">
                                            <span data-i18n="cloud.backupNowButton">‚ö° Backup</span>
                                        </button>
                                        <button onclick="testCloudConnection()" class="w-full py-3 rounded text-[10px] text-slate-400 bg-white/5 border border-white/10 hover:bg-white/10 transition-colors font-bold uppercase tracking-wide truncate" title="Verbindung Testen" data-i18n="cloud.testButton" data-i18n-title="cloud.testTitle">Testen</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Status & Encryption -->
                            <div class="lg:col-span-4 space-y-6">
                                
                                <!-- Status Card -->
                                <div class="bg-black/40 p-6 rounded-xl border border-white/5 flex flex-col items-center justify-center text-center space-y-3 h-[140px]">
                                    <div class="text-[9px] font-black uppercase text-slate-500 tracking-widest" data-i18n="cloud.statusLabel">Status</div>
                                    <span id="cloud-status-badge" class="px-3 py-1 bg-slate-500/10 border border-slate-500/20 text-slate-500 text-[10px] font-black uppercase rounded" data-i18n="cloud.statusDisabled">Deaktiviert</span>
                                </div>

                                <!-- Encryption -->
                                <div class="bg-black/20 p-6 rounded-xl border border-white/5 space-y-4">
                                    <div class="flex items-center gap-3 border-b border-white/5 pb-3">
                                        <input type="checkbox" id="config-enc-enabled" class="w-4 h-4 bg-[#08090d] border-white/10 rounded accent-emerald-500 cursor-pointer">
                                        <label for="config-enc-enabled" class="text-[10px] font-black text-slate-300 uppercase tracking-wider cursor-pointer select-none" data-i18n="cloud.encToggleLabel">AES-256 Encryption</label>
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="cloud.encPasswordLabel">Archiv Passwort</label>
                                        <div class="relative">
                                            <input type="password" id="config-enc-password" placeholder="Key..." class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-emerald-400 outline-none focus:border-emerald-500/50 pr-10 font-mono" data-i18n-placeholder="cloud.encPasswordPlaceholder">
                                            <button onclick="togglePassword('config-enc-password', this)" class="absolute right-0 top-0 h-full px-3 text-slate-500 hover:text-white focus:outline-none flex items-center justify-center transition-colors" tabindex="-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>



<!-- Cloud Status Area (Updated Design) -->
<div id="status-area-cloud-tresor" class="mt-4 bg-[#08090d] p-4 rounded-lg border border-blue-500/20 shadow-lg shadow-blue-900/10">
    <!-- Console Log Area -->
    <div id="console-cloud-tresor" class="h-[120px] bg-[#050608] p-3 rounded-lg mono text-[10px] text-slate-400 space-y-1 overflow-y-auto border border-white/10 mb-3 shadow-inner">
        <div class="text-slate-600 border-b border-white/5 mb-1 pb-1 font-black tracking-widest uppercase text-[9px]" data-i18n="cloud.terminalTitle">Cloud Terminal</div>
        <div id="console-content-cloud-tresor" class="space-y-1"></div>
    </div>

    <!-- Progress Bar -->
    <div class="flex justify-between items-center mb-2">
         <div class="flex items-center gap-2">
             <div class="w-1.5 h-1.5 rounded-full bg-slate-600" id="status-dot-cloud-tresor"></div>
             <span id="status-msg-cloud-tresor" class="text-[9px] font-black uppercase tracking-widest text-slate-400 truncate max-w-[150px]" data-i18n="cloud.statusWaitingLabel">Warte...</span>
         </div>
         <span id="status-pct-cloud-tresor" class="text-[9px] font-mono text-blue-400">0%</span>
    </div>
    <div class="w-full bg-[#0a0b10] h-1.5 rounded-full overflow-hidden border border-white/5 relative">
        <div id="status-bar-cloud-tresor" class="bg-blue-500 h-full w-0 transition-all duration-300 relative"></div>
    </div>
    
    <div id="status-err-cloud-tresor" class="hidden text-[10px] text-red-400 mt-2 font-mono break-all bg-red-500/10 p-2 rounded border border-red-500/20"></div>
</div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: DATABASE BACKUP -->
                <div id="module-db" class="commander-module relative overflow-hidden group">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <div class="p-8 space-y-8">
                        <div class="flex items-center justify-between border-b border-white/5 pb-6">
                            <div>
                                <h2 class="text-lg font-black uppercase text-slate-200 tracking-wide" data-i18n="db.title">Datenbanken (Cloud Dump)</h2>
                                <p class="text-xs text-slate-500 mt-1" data-i18n="db.subtitle">Automatische Dumps von MySQL/PostgreSQL Datenbanken.</p>
                                <button onclick="saveProfile()" class="mt-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 rounded px-2 py-1 text-[9px] font-black uppercase transition-colors" title="Speichert Status" data-i18n="db.saveButton" data-i18n-title="db.saveButtonTitle">üíæ Speichern</button>
                            </div>
                            <div class="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-lg border border-white/5">
                                <input type="checkbox" id="config-db-enabled" onchange="updateDbUI()" class="w-4 h-4 bg-[#08090d] border-white/10 rounded accent-blue-500 cursor-pointer">
                                <label for="config-db-enabled" class="text-[10px] font-black text-blue-400 uppercase tracking-wider cursor-pointer select-none" data-i18n="db.enabledLabel">Aktiviert</label>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left: Connection Settings -->
                            <div class="space-y-6">
                                <div class="bg-black/20 p-5 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.typeLabel">Datenbank Typ</label>
                                    <select id="config-db-type" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 transition-colors">
                                        <option value="mysql">MySQL / MariaDB</option>
                                        <option value="postgres">PostgreSQL</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-2">
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.hostLabel">Host</label>
                                        <input type="text" id="config-db-host" placeholder="localhost" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono">
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.portLabel">Port</label>
                                        <input type="number" id="config-db-port" placeholder="3306" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-slate-400 outline-none focus:border-blue-500/50 font-mono">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.userLabel">Benutzer</label>
                                        <input type="text" id="config-db-user" placeholder="root" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500/50 font-mono">
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.passwordLabel">Passwort</label>
                                        <input type="password" id="config-db-password" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-yellow-500 outline-none focus:border-yellow-500/50 font-mono">
                                    </div>
                                </div>
                            </div>
                            <!-- Right: Target & Actions -->
                            <div class="space-y-6 flex flex-col justify-between">
                                <div class="bg-black/20 p-5 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="db.namesLabel">Datenbank Name(n)</label>
                                    <input type="text" id="config-db-names" placeholder="db1, db2 (Kommagetrennt) oder *" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-emerald-300 outline-none focus:border-blue-500/50 transition-colors mb-2" data-i18n-placeholder="db.namesPlaceholder">
                                    <p class="text-[9px] text-slate-600" data-i18n="db.namesHelpText">Verwenden Sie * f√ºr alle Datenbanken (nur root).</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="runDbBackupNow(this)" class="py-4 rounded text-xs text-emerald-300 bg-emerald-500/5 border border-emerald-500/10 hover:bg-emerald-500/20 transition-all font-black uppercase tracking-wide" data-i18n="db.dumpNowButton">
                                        ‚ö° Dump Erstellen
                                    </button>
                                </div>


                                <!-- DB Status Area -->
                                <div id="status-area-db" class="hidden mt-4 bg-slate-900/50 rounded p-3 border border-white/5 shadow-inner">
                                    <div class="flex justify-between items-center mb-2">
                                        <span id="status-msg-db" class="text-[10px] text-slate-400 font-mono truncate max-w-[200px]" data-i18n="db.statusWaitingLabel">Warte...</span>
                                        <span id="status-pct-db" class="text-[10px] text-emerald-400 font-bold">0%</span>
                                    </div>
                                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                        <div id="status-bar-db" class="h-full bg-emerald-500 w-0 transition-all duration-300 relative overflow-hidden">
                                            <div class="absolute inset-0 bg-white/20 w-full h-full animate-pulse"></div>
                                        </div>
                                    </div>
                                    <div id="status-err-db" class="hidden text-[10px] text-red-400 mt-2 font-mono break-all bg-red-500/10 p-2 rounded border border-red-500/20"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 2: GITHUB REPOSITORIES -->
                <div id="module-github" class="commander-module relative overflow-hidden group">
                    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-slate-700 hover:text-blue-500 cursor-move z-50 transition-colors p-1 opacity-50 hover:opacity-100" title="Drag to reorder">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="8" cy="9" r="1.5" />
                        <circle cx="16" cy="9" r="1.5" />
                        <circle cx="8" cy="15" r="1.5" />
                        <circle cx="16" cy="15" r="1.5" />
                    </svg>
                </div>
                    <!-- Decorator Line Removed -->

                    <div class="p-8 space-y-8">
                        <div class="flex items-center justify-between border-b border-white/5 pb-6">
                            <div>
                                <h2 class="text-lg font-black uppercase text-slate-200 tracking-wide" data-i18n="github.title">GitHub Sources</h2>
                                <p class="text-xs text-slate-500 mt-1" data-i18n="github.subtitle">Klone und sichere Git-Repositories automatisch.</p>
                                <button onclick="saveProfile()" class="mt-2 bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 border border-purple-500/20 rounded px-2 py-1 text-[9px] font-black uppercase transition-colors" title="Speichert Status" data-i18n="github.saveButton" data-i18n-title="github.saveButtonTitle">üíæ Speichern</button>
                            </div>
                            <div class="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-lg border border-white/5">
                                <input type="checkbox" id="config-github-enabled" onchange="updateGithubUI()" class="w-4 h-4 bg-[#08090d] border-white/10 rounded accent-purple-500 cursor-pointer">
                                <label for="config-github-enabled" class="text-[10px] font-black text-purple-400 uppercase tracking-wider cursor-pointer select-none" data-i18n="github.enabledLabel">Aktiviert</label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left: Connection -->
                            <div class="space-y-6">
                                <div class="bg-black/20 p-5 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="github.repoUrlLabel">Repository URL</label>
                                    <div class="flex gap-2 items-center">
                                        <span class="text-lg opacity-30">üåê</span>
                                        <input type="text" id="config-github-url" placeholder="https://github.com/username/repo" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-purple-300 outline-none focus:border-purple-500/50 font-mono transition-colors">
                                    </div>
                                    <p class="text-[9px] text-slate-600 mt-2 pl-8" data-i18n="github.repoHelpText">Unterst√ºtzt HTTPS URLs √∂ffentlicher und privater Repos.</p>
                                </div>

                                <div class="bg-black/20 p-5 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="github.tokenLabel">Personal Access Token (PAT)</label>
                                    <div class="flex gap-2">
                                        <div class="relative flex-1">
                                            <input type="password" id="config-github-token" placeholder="Nur f√ºr private Repos n√∂tig..." class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-yellow-500 outline-none focus:border-yellow-500/50 pr-10 font-mono" data-i18n-placeholder="github.tokenPlaceholder">
                                            <button onclick="togglePassword('config-github-token', this)" class="absolute right-0 top-0 h-full px-3 text-slate-500 hover:text-white focus:outline-none flex items-center justify-center transition-colors" tabindex="-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                            </button>
                                        </div>
                                        <button onclick="testGithubConnection(this)" class="px-4 py-2 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/20 rounded text-[10px] font-bold uppercase text-purple-300 transition-colors" data-i18n="github.testConnectionButton">Verbindung Testen</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Target & Actions -->
                            <div class="space-y-6 flex flex-col justify-between">
                                <div class="bg-black/20 p-5 rounded-xl border border-white/5">
                                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="github.localTargetLabel">Lokaler Zielordner (Optional)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="config-github-path" placeholder="Standard: /github_backups" class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-slate-300 outline-none focus:border-purple-500/50 transition-colors" data-i18n-placeholder="github.localTargetPlaceholder">
                                        <button onclick="pickFolder('config-github-path')" class="bg-white/5 p-2 rounded text-xs hover:bg-white/10 transition-colors text-slate-400" title="Ordner w√§hlen" data-i18n-title="duplicates.chooseFolderTitle">üìÅ</button>
                                    </div>
                                    <p class="text-[9px] text-slate-600 mt-2" data-i18n="github.localTargetHelpText">L√§sst du dies leer, wird ein Standardordner im Backup-Ziel erstellt.</p>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="runGithubBackupNow(this)" class="py-4 rounded text-xs text-purple-300 bg-purple-500/5 border border-purple-500/10 hover:bg-purple-500/20 transition-all font-black uppercase tracking-wide" data-i18n="github.runNowButton">
                                        ‚ö° Jetzt Ausf√ºhren
                                    </button>
                                </div>

                                <!-- GitHub Status Area -->
                                <div id="status-area-github" class="hidden mt-4 bg-slate-900/50 rounded p-3 border border-white/5 shadow-inner">
                                    <div class="flex justify-between items-center mb-2">
                                        <span id="status-msg-github" class="text-[10px] text-slate-400 font-mono truncate max-w-[200px]" data-i18n="github.statusWaitingLabel">Warte...</span>
                                        <span id="status-pct-github" class="text-[10px] text-purple-400 font-bold">0%</span>
                                    </div>
                                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                        <div id="status-bar-github" class="h-full bg-purple-500 w-0 transition-all duration-300 relative overflow-hidden">
                                            <div class="absolute inset-0 bg-white/20 w-full h-full animate-pulse"></div>
                                        </div>
                                    </div>
                                    <div id="status-err-github" class="hidden text-[10px] text-red-400 mt-2 font-mono break-all bg-red-500/10 p-2 rounded border border-red-500/20"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Tab: Analyse -->
        <section id="tab-duplicates" class="tab-content flex-1 overflow-y-auto p-8 space-y-6 hidden text-slate-200" style="scrollbar-gutter: stable;">
            <div class="commander-module p-6 space-y-6 max-w-3xl mx-auto">
                <div class="flex flex-col gap-4 border-b border-white/5 pb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-black uppercase tracking-widest text-slate-400" data-i18n="duplicates.title">Deep-Scan Duplikatanalyse</h2>
                        <div class="flex gap-2">
                             <button id="btn-cancel-scan" onclick="stopScan()" class="hidden text-[10px] font-black bg-red-500/10 border border-red-500/20 px-4 py-2 rounded text-red-400 hover:bg-red-500/20 transition-all uppercase tracking-widest" data-i18n="duplicates.cancelButton">Abbruch</button>
                             <button id="btn-start-scan" onclick="scanDuplicates()" class="text-[10px] font-black bg-blue-500/10 border border-blue-500/20 px-4 py-2 rounded text-blue-400 hover:bg-blue-500/20 transition-all uppercase tracking-widest" data-i18n="duplicates.startButton">Scan starten</button>
                        </div>
                    </div>

                    <!-- Custom Path -->
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 block mb-1" data-i18n="duplicates.searchPathLabel">Suchpfad (Optional)</label>
                        <div class="flex gap-2">
                            <input type="text" id="scan-path" placeholder="Leer lassen f√ºr Standard-Quellpfad..." class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-slate-300 outline-none focus:border-blue-500/50 transition-colors" data-i18n-placeholder="duplicates.searchPathPlaceholder">
                            <button onclick="pickFolder('scan-path')" class="bg-white/5 p-2 rounded text-xs hover:bg-white/10 transition-colors" title="Ordner w√§hlen" data-i18n-title="duplicates.chooseFolderTitle">üìÅ</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 block mb-1" data-i18n="duplicates.minSizeLabel">Min. Dateigr√∂√üe</label>
                            <select id="scan-min-size" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none">
                                <option value="0" data-i18n="duplicates.sizeAll">Alle Gr√∂√üen</option>
                                <option value="1048576" data-i18n="duplicates.sizeFrom1MB">Ab 1 MB</option>
                                <option value="10485760" data-i18n="duplicates.sizeFrom10MB">Ab 10 MB</option>
                                <option value="104857600" data-i18n="duplicates.sizeFrom100MB">Ab 100 MB</option>
                                <option value="1073741824" data-i18n="duplicates.sizeFrom1GB">Ab 1 GB</option>
                            </select>
                         </div>
                         <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 block mb-1" data-i18n="duplicates.typesLabel">Dateitypen</label>
                            <select id="scan-extensions" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none">
                                <option value="all" data-i18n="duplicates.typesAll">Alle Dateien</option>
                                <option value="images" data-i18n="duplicates.typesImages">Bilder (.jpg, .png, .raw, ...)</option>
                                <option value="videos" data-i18n="duplicates.typesVideos">Videos (.mp4, .mov, .mkv, ...)</option>
                                <option value="docs" data-i18n="duplicates.typesDocs">Dokumente (.pdf, .docx, .txt, ...)</option>
                                <option value="archives" data-i18n="duplicates.typesArchives">Archive (.zip, .rar, .7z, ...)</option>
                            </select>
                         </div>
                    </div>
                </div>
                
                <div id="duplicate-results" class="space-y-4 min-h-[300px]">
                    <div class="text-center py-20 opacity-30 italic text-sm" data-i18n="duplicates.emptyState">Kein Scan aktiv. Starten Sie die Analyse, um redundante Daten aufzusp√ºren.</div>
                </div>
            </div>
        </section>

        <!-- Tab: Parameter -->
        <section id="tab-settings" class="tab-content flex-1 overflow-y-auto p-8 space-y-6 hidden text-slate-200">
            <div class="commander-module p-8 max-w-2xl mx-auto text-slate-200">
                <h2 class="text-sm font-black uppercase text-slate-400 border-b border-white/5 pb-4 mb-4" data-i18n="settings.kernelTitle">Kernel Parameter & Automatisierung</h2>
                <div class="flex items-center justify-between mb-6">
                    <span class="text-[10px] font-black uppercase text-slate-500 tracking-widest" data-i18n="settings.languageLabel">Sprache / Language</span>
                    <button id="config-language-button" class="px-3 py-1 rounded border border-white/10 text-[10px] font-black uppercase tracking-widest text-slate-300 hover:text-white hover:border-blue-500/40 hover:bg-blue-500/10 transition-colors" data-i18n="settings.languageButton">Deutsch / English</button>
                </div>
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                             <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="settings.sourcePathLabel">Source Path</label>
                             <div class="flex gap-2">
                                <input type="text" id="config-source" readonly class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-blue-300">
                                <button onclick="pickFile('config-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Einzelne Datei w√§hlen" data-i18n-title="settings.sourceFileTitle">üìÑ</button>
                                <button onclick="pickFiles('config-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Mehrere Dateien w√§hlen" data-i18n-title="settings.sourceFilesTitle">üìë</button>
                                <button onclick="pickFolder('config-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Ordner w√§hlen" data-i18n-title="settings.sourceFolderTitle">üìÅ</button>
                             </div>
                        </div>
                        <div>
                             <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="settings.targetPathLabel">Target Path</label>
                             <div class="flex gap-2">
                                <input type="text" id="config-dest" readonly class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-emerald-300">
                                <button onclick="pickFolder('config-dest')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" data-i18n="settings.targetFolderButton">Pick</button>
                             </div>
                        </div>
                    </div>

                    <div class="bg-black/20 p-5 rounded-xl border border-white/5 space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="text-[11px] font-black uppercase text-slate-400 tracking-wider" data-i18n="settings.autoSnapshotTitle">Automatischer Snapshot</span>
                                <span class="text-[9px] text-slate-500" data-i18n="settings.autoSnapshotSubtitle">Sichert Daten im gew√§hlten Intervall im Hintergrund.</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-6 bg-slate-800 rounded-full relative cursor-pointer" onclick="toggleAutoBackup()">
                                    <div id="auto-toggle-knob" class="absolute top-1 left-1 w-4 h-4 bg-slate-500 rounded-full transition-all"></div>
                                </div>
                                <button onclick="saveProfile()" class="bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 rounded px-2 py-1 text-[9px] font-black uppercase transition-colors" title="Speichert alle Einstellungen" data-i18n-title="settings.saveProfileButtonTitle">üíæ</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="settings.intervalLabel">Intervall (Minuten)</label>
                                <input type="number" id="config-auto-interval" placeholder="z.B. 60" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-blue-400 outline-none" data-i18n-placeholder="settings.intervalPlaceholder">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="settings.retentionLabel">Retention Limit</label>
                                <input type="number" id="config-retention" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none">
                            </div>
                        </div>

                    </div>

                    <div class="bg-black/20 p-5 rounded-xl border border-white/5 space-y-4">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 border-b border-white/5 pb-2" data-i18n="settings.namingTitle">Backup-Benennung</h3>
                        
                        <div>
                             <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest" data-i18n="settings.namingCustomLabel">Eigener Name (Pr√§fix)</label>
                             <input type="text" id="config-naming-custom" placeholder="z.B. projekt_alpha" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-blue-500 mb-2" oninput="updateNamingPreview()" data-i18n-placeholder="settings.namingCustomPlaceholder">
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="config-naming-date" class="w-3 h-3 bg-[#08090d] border-white/10 rounded" onchange="updateNamingPreview()">
                                <label for="config-naming-date" class="text-[10px] font-bold text-slate-400 uppercase" data-i18n="settings.namingDateLabel">Datum</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="config-naming-time" class="w-3 h-3 bg-[#08090d] border-white/10 rounded" onchange="updateNamingPreview()">
                                <label for="config-naming-time" class="text-[10px] font-bold text-slate-400 uppercase" data-i18n="settings.namingTimeLabel">Zeit</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="config-naming-seq" class="w-3 h-3 bg-[#08090d] border-white/10 rounded" onchange="updateNamingPreview()">
                                <label for="config-naming-seq" class="text-[10px] font-bold text-slate-400 uppercase" data-i18n="settings.namingSeqLabel">Laufende Nr.</label>
                                <input type="number" id="config-naming-seq-val" class="w-12 bg-[#08090d] border border-white/5 rounded p-1 text-[10px] text-center text-blue-400 outline-none" value="1" min="1" oninput="updateNamingPreview()" title="Aktueller Z√§hlerstand (Startwert)" data-i18n-title="settings.namingSeqTitle">
                            </div>
                        </div>

                        <div class="pt-2 border-t border-white/5">
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-black uppercase text-slate-500" data-i18n="settings.namingPreviewLabel">Vorschau:</span>
                                <span id="naming-preview" class="text-xs mono text-emerald-400" data-i18n="settings.namingPreviewExample">backup_2023-10-27.zip</span>
                            </div>
                        </div>
                    </div>

                    <!-- Erweiterte Optionen -->
                    <div class="bg-black/20 p-5 rounded-xl border border-white/5 space-y-4">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 border-b border-white/5 pb-2" data-i18n="settings.advancedOptionsTitle">Erweiterte Optionen</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="settings.compressionLabel">Komprimierung</label>
                                <select id="config-compression" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none">
                                    <option value="0" data-i18n="settings.compressionNone">Keine (Nur Speichern)</option>
                                    <option value="1" data-i18n="settings.compressionFast">Schnell (Level 1)</option>
                                    <option value="3" selected data-i18n="settings.compressionStandard">Standard (Level 3)</option>
                                    <option value="5" data-i18n="settings.compressionStrong">Stark (Level 5)</option>
                                    <option value="9" data-i18n="settings.compressionMax">Maximal (Level 9)</option>
                                </select>
                            </div>
                            <div>
                                 <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="settings.exclusionsLabel">Ausschl√ºsse (Glob Pattern)</label>
                                <input type="text" id="config-exclusions" placeholder="Beispiel: *.tmp, *.log, node_modules" title="Beispiel: *.tmp, *.log, node_modules" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none" data-i18n-placeholder="settings.exclusionsPlaceholder" data-i18n-title="settings.exclusionsTitle">
                            </div>
                        </div>
                    </div>

                    <!-- Benachrichtigungen -->
                    <div class="bg-black/20 p-5 rounded-xl border border-white/5 space-y-4">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 border-b border-white/5 pb-2" data-i18n="settings.notificationsTitle">Benachrichtigungen (Webhooks)</h3>
                        
                        <!-- Trigger -->
                        <div class="flex gap-4 mb-2">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="config-notify-success" class="rounded bg-white/5 border-white/10 text-emerald-500 focus:ring-0">
                                <span class="text-xs text-slate-400 group-hover:text-emerald-400 transition-colors" data-i18n="settings.notifyOnSuccess">Bei Erfolg</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="config-notify-error" class="rounded bg-white/5 border-white/10 text-red-500 focus:ring-0">
                                <span class="text-xs text-slate-400 group-hover:text-red-400 transition-colors" data-i18n="settings.notifyOnError">Bei Fehler</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Discord -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="settings.discordLabel">Discord Webhook URL</label>
                                    <button onclick="testNotification('discord')" class="text-[9px] font-black uppercase bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/20 hover:bg-indigo-500/20" data-i18n="settings.discordTestButton">Test</button>
                                </div>
                                <input type="text" id="config-discord-url" placeholder="https://discord.com/api/webhooks/..." class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-indigo-500/50 transition-colors" data-i18n-placeholder="settings.discordPlaceholder">
                            </div>

                            <!-- Telegram -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="settings.telegramLabel">Telegram Bot</label>
                                    <button onclick="testNotification('telegram')" class="text-[9px] font-black uppercase bg-sky-500/10 text-sky-400 px-2 py-0.5 rounded border border-sky-500/20 hover:bg-sky-500/20" data-i18n="settings.telegramTestButton">Test</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="config-telegram-token" placeholder="Bot Token" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-sky-500/50 transition-colors" data-i18n-placeholder="settings.telegramTokenPlaceholder">
                                    <input type="text" id="config-telegram-chatid" placeholder="Chat ID" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-white outline-none focus:border-sky-500/50 transition-colors" data-i18n-placeholder="settings.telegramChatPlaceholder">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveProfile()" class="btn-pro w-full py-4 rounded text-sm text-white shadow-xl shadow-blue-600/20" data-i18n="settings.saveParametersButton">Parameter persistent speichern</button>
                </div>
            </div>
        </section>

        <!-- Tab: Tasks -->
        <section id="tab-tasks" class="tab-content flex-1 overflow-y-auto p-8 space-y-6 hidden text-slate-200">
             <div class="max-w-6xl mx-auto flex gap-6 h-[calc(100vh-100px)]">
                
                <!-- Left: Task List -->
                <div class="w-1/3 bg-[#11141d] border border-white/5 rounded-xl flex flex-col">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <h2 class="text-xs font-black uppercase text-slate-400" data-i18n="tasks.myTasksTitle">Meine Tasks</h2>
                        <button onclick="createNewTask()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-600/30 text-[10px] font-black uppercase px-2 py-1 rounded transition-all" data-i18n="tasks.newButton">
                            + Neu
                        </button>
                    </div>
                    <div id="task-list-container" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <!-- Task Items injected by JS -->
                        <div class="text-center py-10 opacity-30 italic text-[10px]" data-i18n="tasks.loadingPlaceholder">Lade Tasks...</div>
                    </div>
                </div>

                <!-- Right: Task Editor -->
                <div class="w-2/3 bg-[#11141d] border border-white/5 rounded-xl p-6 overflow-y-auto">
                    <div id="task-editor-empty" class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50">
                        <div class="text-4xl mb-4">üìù</div>
                        <div class="text-sm" data-i18n="tasks.editorEmptyText">W√§hle einen Task oder erstelle einen neuen.</div>
                    </div>

                    <div id="task-editor" class="hidden space-y-6">
                        <div class="flex justify-between items-center border-b border-white/5 pb-4">
                            <input type="text" id="task-name" placeholder="Task Name" class="bg-transparent text-lg font-bold text-white outline-none w-full placeholder-slate-600" data-i18n-placeholder="tasks.namePlaceholder">
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold uppercase text-slate-500" data-i18n="tasks.activeLabel">Aktiv</label>
                                <input type="checkbox" id="task-active" class="w-4 h-4 bg-slate-800 border-white/10 rounded cursor-pointer">
                            </div>
                        </div>

                        <!-- Source & Dest (Borrowed from Parameter) -->
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="tasks.sourcePathLabel">Source Path</label>
                                <div class="flex gap-2">
                                   <input type="text" id="task-source" class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-blue-300 outline-none">
                                   <button onclick="pickFile('task-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Einzelne Datei" data-i18n-title="tasks.singleFileTitle">üìÑ</button>
                                   <button onclick="pickFiles('task-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Mehrere Dateien" data-i18n-title="tasks.multiFileTitle">üìë</button>
                                   <button onclick="pickFolder('task-source')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" title="Ordner" data-i18n-title="tasks.folderTitle">üìÅ</button>
                                </div>
                                <p class="text-[9px] text-slate-500 mt-1" data-i18n="tasks.tipPaths">Tipp: Mehrere Pfade mit | trennen.</p>
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-500" data-i18n="tasks.targetPathLabel">Target Path</label>
                                <div class="flex gap-2">
                                   <input type="text" id="task-dest" class="flex-1 bg-[#08090d] border border-white/5 rounded p-2 text-xs mono text-emerald-300 outline-none">
                                   <button onclick="pickFolder('task-dest')" class="bg-white/5 p-2 rounded text-[10px] uppercase font-black transition-colors hover:bg-white/10" data-i18n="tasks.targetFolderButton">Pick</button>
                                </div>
                            </div>
                        </div>

                        <!-- Automation Section -->
                        <div class="bg-black/20 p-5 rounded-xl border border-white/5 space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-black uppercase text-slate-400 tracking-wider" data-i18n="tasks.automationTitle">Automatisierung</span>
                                    <span class="text-[9px] text-slate-500" data-i18n="tasks.automationSubtitle">F√ºhrt diesen Task automatisch aus.</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="tasks.intervalLabel">Intervall (Minuten)</label>
                                    <input type="number" id="task-interval" placeholder="0 = Manuell" class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-blue-400 outline-none" data-i18n-placeholder="tasks.intervalPlaceholder">
                                </div>
                                <div>
                                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block" data-i18n="tasks.lastRunLabel">Letzter Lauf</label>
                                    <input type="text" id="task-last-run" readonly class="w-full bg-[#08090d] border border-white/5 rounded p-2 text-xs text-slate-500 outline-none cursor-not-allowed">
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-4 border-t border-white/5 flex justify-between">
                            <button onclick="deleteCurrentTask()" class="text-red-400 hover:text-red-300 text-xs font-bold uppercase transition-colors" data-i18n="tasks.deleteButton">L√∂schen</button>
                            <div class="flex gap-3">
                                <button onclick="runTaskNow()" class="bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-600/30 text-xs font-black uppercase px-4 py-2 rounded transition-all" data-i18n="tasks.runNowButton">
                                    Jetzt Ausf√ºhren
                                </button>
                                <button onclick="saveCurrentTask()" class="bg-blue-600 text-white shadow-lg shadow-blue-600/20 text-xs font-black uppercase px-6 py-2 rounded transition-all hover:bg-blue-500" data-i18n="tasks.saveButton">
                                    Speichern
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Handbook (Optimiert v7.4) -->
        <section id="tab-help" class="tab-content flex-1 overflow-y-auto p-8 hidden text-slate-200">
            <div class="max-w-5xl mx-auto pb-24">
                
                <!-- Header -->
                <header class="text-center space-y-4 mb-10 pt-4">
                    <h1 class="text-3xl font-black text-white tracking-widest uppercase italic" data-i18n="handbook.title">Benutzerhandbuch</h1>
                    <div class="h-1 w-16 bg-emerald-500 mx-auto rounded-full"></div>
                    <p class="text-slate-500 max-w-lg mx-auto text-sm leading-relaxed" data-i18n="handbook.subtitle">Einfache Anleitung f√ºr Backup Pro.</p>
                </header>

                <!-- 00 Erste Schritte (User Requested Style) -->
                <div class="commander-module p-8 bg-emerald-500/5 border border-emerald-500/20 rounded-xl mb-12 shadow-lg shadow-emerald-500/5" data-i18n="handbook.section00">
                    <h3 class="text-xl font-black text-emerald-400 mb-6 uppercase tracking-wider flex items-center gap-3">
                        <span class="text-2xl">üöÄ</span> 00 Erste Schritte & Workflow
                    </h3>
                    <div class="space-y-6 text-sm text-slate-300 leading-relaxed">
                        <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                            <p class="mb-2"><strong class="text-white">Willkommen!</strong> Backup Pro ist so aufgebaut, dass Sie alles Wichtige sofort finden. Links im Men√º sehen Sie die 5 Bereiche:</p>
                            <ul class="list-disc pl-5 space-y-1 text-xs text-slate-400 marker:text-emerald-500">
                                <li><strong class="text-white">01 ZENTRALE:</strong> Ihre Haupt√ºbersicht. Hier starten Sie Backups und sehen, ob alles okay ist.</li>
                                <li><strong class="text-white">02 RESTORE:</strong> "Wiederherstellen". Hier holen Sie gel√∂schte Dateien zur√ºck.</li>
                                <li><strong class="text-white">03 CLOUD:</strong> Wenn Sie Ihre Daten auch im Internet sichern wollen (optional).</li>
                                <li><strong class="text-white">04 ANALYSE:</strong> Hilft beim Aufr√§umen von doppelten Dateien.</li>
                                <li><strong class="text-white">05 PARAMETER:</strong> Die Einstellungen. Hier legen Sie fest, WAS und WOHIN gesichert wird.</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-white text-base mb-3 border-b border-white/10 pb-2">Ihr erstes Backup in 3 Minuten:</h4>
                            <ol class="list-decimal pl-5 space-y-3 text-sm text-slate-300 marker:text-emerald-500 marker:font-bold">
                                <li>Klicken Sie links auf <strong class="text-emerald-400">05 PARAMETER</strong>.</li>
                                <li>Bei "Source Path" (Quelle): W√§hlen Sie einen <strong>Ordner</strong> (üìÅ), eine <strong>einzelne Datei</strong> (üìÑ) oder <strong>mehrere Dateien</strong> (üìë) aus.</li>
                                <li>Bei "Target Path" (Ziel): W√§hlen Sie den Ort, wo die Sicherung hin soll (z.B. USB-Stick).</li>
                                <li>Klicken Sie unten auf den gro√üen Button <strong class="text-white bg-blue-600/20 px-2 py-0.5 rounded border border-blue-500/30">Parameter persistent speichern</strong>.</li>
                                <li>Gehen Sie zur√ºck zur <strong class="text-emerald-400">01 ZENTRALE</strong>.</li>
                                <li>Klicken Sie auf <strong>"Snapshot anlegen"</strong> (Blitz-Symbol). Das war's!</li>
                            </ol>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                            <div class="bg-red-500/5 p-4 rounded border border-red-500/10">
                                <h4 class="font-bold text-red-400 mb-2 text-xs uppercase tracking-wider">‚ö†Ô∏è Daten wiederherstellen (Restore)</h4>
                                <p class="text-xs text-slate-400">Wenn eine Datei fehlt, gehen Sie zu <strong>02 RESTORE</strong>. W√§hlen Sie das Datum und klicken Sie auf "Restore". <br><br><strong>ACHTUNG:</strong> Der gesamte Ordner wird auf diesen alten Stand zur√ºckgesetzt. Neue Dateien k√∂nnten dabei verloren gehen!</p>
                            </div>
                            <div class="bg-blue-500/5 p-4 rounded border border-blue-500/10">
                                <h4 class="font-bold text-blue-400 mb-2 text-xs uppercase tracking-wider">üí° Platz sparen mit Analyse</h4>
                                <p class="text-xs text-slate-400">Unter <strong>04 ANALYSE</strong> sucht das Programm nach doppelten Dateien. Wenn Sie diese vor dem Backup l√∂schen, geht das Backup schneller und braucht weniger Platz.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="flex items-center gap-4 mb-12 opacity-30" data-i18n="handbook.sectionDivider">
                    <div class="h-px bg-white flex-1"></div>
                    <span class="text-xs uppercase tracking-widest">Wissen & Details</span>
                    <div class="h-px bg-white flex-1"></div>
                </div>

                <!-- Detailed Handbook Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12" data-i18n="handbook.sectionDetails">
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">01</span> Was ist ein Snapshot?</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Ein "Snapshot" ist wie ein Foto Ihrer Daten zu einem bestimmten Zeitpunkt. Backup Pro packt alle Ihre Dateien in ein P√§ckchen (ZIP-Datei). So k√∂nnen Sie sp√§ter genau diesen Zustand wiederherstellen.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">02</span> Aufr√§um-Regel (Retention)</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Damit Ihre Festplatte nicht voll wird, l√∂scht Backup Pro automatisch uralte Sicherungen. Unter "Parameter" -> "Retention Limit" stellen Sie ein, wie viele Backups Sie behalten wollen (z.B. die letzten 10). Das √§lteste wird dann automatisch gel√∂scht.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">03</span> Workspace Delta (Neu)</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">In der <strong>01 ZENTRALE</strong> sehen Sie jetzt das "Workspace Delta". Es zeigt Ihnen live, wie viele Dateien und wie viel Speicherplatz (MB/GB) sich im Vergleich zum letzten Backup ge√§ndert haben. Achten Sie auf den Modus oben rechts (LOCAL, UPLOAD, DOWNLOAD).</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">04</span> Cloud Tresor & SFTP</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Unter <strong>03 CLOUD</strong> steuern Sie Ihre Remote-Backups. W√§hlen Sie zwischen "Upload" (Lokal -> Cloud) und "Download" (Cloud -> Lokal). Neu: Bei SFTP k√∂nnen Sie mit "Speicherort anlegen" direkt Ordner auf dem Server erstellen. Beim Download k√∂nnen Sie einen speziellen lokalen Zielordner definieren.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">05</span> Fehlerbehebung</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Wenn ein Backup fehlschl√§gt, ist meistens eine Datei noch ge√∂ffnet (z.B. eine Excel-Tabelle). Schlie√üen Sie alle Programme und versuchen Sie es nochmal. Pr√ºfen Sie auch, ob der USB-Stick voll ist.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">06</span> System Health (Ampel)</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Die "System Health" in der Zentrale ist wie eine Ampel. Gr√ºn ist super. Gelb hei√üt "naja". Rot hei√üt "Achtung!". Wenn sie rot ist, sollten Sie dringend ein Backup machen oder Speicherplatz freigeben.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">07</span> Snapshot Inspektor & Lock</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Klicken Sie in der Liste auf ein Backup, um Details zu sehen. <strong class="text-emerald-400">Neu:</strong> Im Tab "Inhalt" sehen Sie alle Dateien im ZIP, ohne Restore! Mit dem <strong class="text-amber-500">Schloss-Symbol (Lock)</strong> k√∂nnen Sie wichtige Backups sperren ‚Äì sie werden dann nie automatisch gel√∂scht, auch wenn das Limit erreicht ist.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">08</span> Deep Scan (Integrit√§t)</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Im Inspektor finden Sie den Button <strong class="text-emerald-400">INTEGRIT√ÑT PR√úFEN</strong>. Das ist ein Gesundheitscheck: Das Programm berechnet den digitalen Fingerabdruck (Hash) neu und vergleicht ihn. So erkennen Sie sofort, ob Dateien auf der Festplatte besch√§digt wurden (Bit Rot).</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">09</span> Historie & Log-Skala</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Die Historie listet alle Backups auf. Neu: Mit dem Schalter <strong>LOG-SKALA</strong> √ºber dem Diagramm k√∂nnen Sie auch sehr kleine Dateien neben riesigen Backups sichtbar machen. Sortieren Sie die Liste mit dem "Sort"-Button nach Datum oder Gr√∂√üe.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">10</span> Datenbanken (Cloud Dump)</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Im Cloud-Tab k√∂nnen Sie automatische Backups Ihrer MySQL oder PostgreSQL Datenbanken einrichten. Diese werden als SQL-Dateien exportiert und sicher in Ihrem Backup-Ziel abgelegt.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">11</span> Benachrichtigungen</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Backup Pro informiert Sie √ºber wichtige Ereignisse direkt in der Oberfl√§che. Fehler werden rot, erfolgreiche Aktionen gr√ºn markiert. √úberpr√ºfen Sie regelm√§√üig das Protokoll (Terminal) in der Zentrale.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">12</span> System Health Details</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Fahren Sie mit der Maus √ºber die "System Health" Karte, um detaillierte Infos zu sehen. Die neue Anzeige schl√ºsselt Ihren Score exakt in Prozent auf: <strong>COV</strong> (Abdeckung), <strong>REC</strong> (Wiederherstellbarkeit) und <strong>DSK</strong> (Speicherplatz).</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">13</span> Erweiterte Statistiken</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Die Karten "Gesamtvolumen" und "Backups" zeigen jetzt mehr Details: Durchschnittsgr√∂√üe pro Snapshot, Zeit seit dem letzten Backup und die Backup-Frequenz pro Tag. Tooltips erkl√§ren beim Hovern weitere Details.</p>
                    </div>
                    <div class="handbook-item p-6 bg-[#0f111a] rounded-xl border border-white/5 hover:border-blue-500/30 transition-all group">
                        <h3 class="text-lg font-bold text-white mb-3 group-hover:text-blue-400 transition-colors"><span class="text-blue-500/50 mr-2">14</span> Aktivit√§ts-Diagramm</h3>
                        <p class="text-sm text-slate-400 leading-relaxed">Das Diagramm in der Zentrale unterscheidet nun visuell zwischen Tagen mit Backup (gef√ºllte Punkte) und Tagen ohne Backup (leere Punkte). Neue Grid-Linien und verbesserte Achsen helfen Ihnen, L√ºcken in Ihrer Sicherungsstrategie schneller zu erkennen.</p>
                    </div>
                </div>

                <!-- Profi Tipps -->
                <div class="commander-module p-6 bg-blue-500/5 border border-blue-500/20 rounded-xl" data-i18n="handbook.proTips">
                    <h4 class="text-xs font-black uppercase text-blue-400 mb-4 tracking-widest">Profi Tipps</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-[11px] mono text-slate-400">
                        <ul class="space-y-3">
                            <li class="flex gap-2"><span class="text-blue-500">>></span> <span>Machen Sie vor jedem Windows-Update oder gro√üen √Ñnderungen ein Backup. Sicher ist sicher.</span></li>
                            <li class="flex gap-2"><span class="text-blue-500">>></span> <span>Denken Sie daran: Ein Restore macht alles wie fr√ºher. Kopieren Sie wichtige neue Dateien vorher woanders hin!</span></li>
                        </ul>
                        <ul class="space-y-3">
                            <li class="flex gap-2"><span class="text-blue-500">>></span> <span>Sie k√∂nnen unter Parameter ein "Intervall" einstellen (z.B. 60 Minuten). Dann m√ºssen Sie gar nichts mehr dr√ºcken.</span></li>
                            <li class="flex gap-2"><span class="text-blue-500">>></span> <span>Icons: Gelbes Schild = "Datei ge√§ndert", Rotes Kreuz = "Datei gel√∂scht", Gr√ºnes Plus = "Datei neu".</span></li>
                        </ul>
                    </div>
                </div>

                <!-- Support / Buy Me A Coffee -->
                <div class="commander-module p-6 bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-500/20 rounded-xl mt-8 shadow-lg shadow-yellow-500/5" data-i18n="handbook.support">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex-1">
                            <h4 class="text-xs font-black uppercase text-yellow-400 mb-2 tracking-widest flex items-center gap-2">
                                <span>‚òï</span> Support Development
                            </h4>
                            <p class="text-sm text-slate-300 leading-relaxed">
                                Gef√§llt Ihnen <strong>Backup OS Pro</strong>? Helfen Sie mit, die Entwicklung voranzutreiben! 
                                <span class="text-slate-500 block text-xs mt-1">Jede Unterst√ºtzung flie√üt direkt in neue Features und Updates.</span>
                            </p>
                        </div>
                        <a href="https://buymeacoffee.com/exulizer" target="_blank" class="group relative shrink-0">
                            <div class="absolute -inset-1 bg-yellow-400 rounded-lg opacity-20 group-hover:opacity-40 blur transition duration-200"></div>
                            <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" class="relative block h-12 w-auto transform group-hover:scale-105 transition-all duration-200" style="height: 50px !important;">
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global Error Handler for Boot Issues
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('startup-loader');
            if(loader) {
                 const consoleEl = document.getElementById('loader-console');
                 if(consoleEl) consoleEl.innerHTML = `<span style="color:#ef4444">CRITICAL ERROR: ${msg} (Line ${line})</span>`;
                 const msgEl = document.getElementById('loader-msg');
                 if(msgEl) {
                     msgEl.innerText = "SYSTEM HALTED";
                     msgEl.style.color = "#ef4444";
                 }
                 // Auto-hide after 5s to allow user to see UI if partially loaded
                 setTimeout(() => { loader.style.display = 'none'; }, 5000);
            }
        };

        // Failsafe: Force hide loader after 10s
        setTimeout(() => {
            const loader = document.getElementById('startup-loader');
            if(loader) {
                console.warn("Loader timeout - forcing hide.");
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }
        }, 10000);

        // Boot Sequence Simulation
        window.bootInterval = null;
        (function() {
            const msgs = [
                "LOADING KERNEL MODULES...",
                "MOUNTING VIRTUAL FILESYSTEM...",
                "CHECKING INTEGRITY...",
                "LOADING CONFIGURATION...",
                "ESTABLISHING SECURE LINK...",
                "STARTING DAEMON PROCESSES...",
                "SYSTEM READY."
            ];
            let i = 0;
            window.bootInterval = setInterval(() => {
                const consoleEl = document.getElementById('loader-console');
                const percentEl = document.getElementById('loader-percent');
                
                if(i >= msgs.length) {
                    if(window.bootInterval) clearInterval(window.bootInterval);
                    if(consoleEl) consoleEl.innerText = "> WAITING FOR BACKEND...";
                    return;
                }
                
                if(consoleEl) consoleEl.innerText = "> " + msgs[i];
                if(percentEl) percentEl.innerText = Math.round(((i + 1) / msgs.length) * 100) + "%";
                i++;
            }, 200);
        })();

        let storageChart = null;
        let globalHistory = [];
        let currentDiskUsedPercent = 0;
        
        // --- Central Limit & Paging ---
        let currentLimit = 10;
        let currentPage = 1;
        try {
            const saved = localStorage.getItem('backup_pro_limit');
            if(saved) currentLimit = saved === 'all' ? 999999 : parseInt(saved);
        } catch(e) { console.error("LocalStorage Error:", e); }

        let configuredRetention = 10; // For Health Calculation
        let cloudEnabled = false;
        let autoBackupEnabled = false;
        console.log("BACKUP PRO SCRIPT INITIALIZING...");
        let globalUnit = 'MB';

        // --- Sorting & History Logic (Global) ---
        let currentSortMode = 0; // 0=DateDesc, 1=DateAsc, 2=SizeDesc, 3=SizeAsc
        const sortLabels = ["Datum ‚ñº (Neu)", "Datum ‚ñ≤ (Alt)", "Gr√∂√üe ‚ñº", "Gr√∂√üe ‚ñ≤"];

        window.updateHistoryLimit = function() {
            const val = document.getElementById('history-limit').value;
            currentLimit = val === 'all' ? 999999 : parseInt(val);
            localStorage.setItem('backup_pro_limit', val);
            currentPage = 1;
            const label = (val === 'all' ? t("dashboard.limitAll", "Alle") : val);
            addLog(t("console.limitChanged", "Limit ge√§ndert: ") + label, "info");
            updateDashboardDisplays();
        };

        window.nextHistoryPage = function() {
            const totalItems = globalHistory.length;
            if (!totalItems || currentLimit <= 0 || currentLimit === 999999) return;
            const totalPages = Math.max(1, Math.ceil(totalItems / currentLimit));
            if (currentPage < totalPages) {
                currentPage += 1;
                updateDashboardDisplays();
            }
        };

        window.prevHistoryPage = function() {
            if (currentLimit <= 0 || currentLimit === 999999) return;
            if (currentPage > 1) {
                currentPage -= 1;
                updateDashboardDisplays();
            }
        };

        window.applySort = function() {
            if(!globalHistory || globalHistory.length === 0) return;
            
            // FIX: Use Date objects for reliable sorting
            const getTs = (item) => {
                if(!item.timestamp) return 0;
                // Replace German format if present (just in case)
                let s = item.timestamp.replace(/(\d{2})\.(\d{2})\.(\d{4})/, '$3-$2-$1');
                // Replace space with T for ISO compatibility
                s = s.replace(" ", "T");
                return new Date(s).getTime();
            };

            if(currentSortMode === 0) { // Date Desc (Newest First)
                globalHistory.sort((a, b) => getTs(b) - getTs(a));
            } else if(currentSortMode === 1) { // Date Asc (Oldest First)
                globalHistory.sort((a, b) => getTs(a) - getTs(b));
            } else if(currentSortMode === 2) { // Size Desc
                globalHistory.sort((a, b) => b.size - a.size);
            } else if(currentSortMode === 3) { // Size Asc
                globalHistory.sort((a, b) => a.size - b.size);
            }
        };

        window.toggleSort = function() {
            currentSortMode = (currentSortMode + 1) % 4;
            const btn = document.getElementById('btn-sort');
            if(btn) btn.innerText = "Sort: " + sortLabels[currentSortMode];
            
            window.applySort();
            updateDashboardDisplays();
        };

        window.clearHistory = async function() {
            if(!confirm("Historie wirklich leeren? (Dateien bleiben erhalten)")) return;
            try {
                const resp = await fetch('/api/clear_history', { method: 'POST' });
                const data = await resp.json();
                if(data.status === 'success') {
                    addLog(t("console.historyCleared", "Historie geleert."), "success");
                    loadData();
                } else {
                    addLog(t("console.errorPrefix", "Fehler: ") + data.message, "error");
                }
            } catch(e) {
                addLog(t("console.connectionError", "Verbindungsfehler."), "error");
            }
        };

        window.refreshHistory = async function() {
            const btn = document.getElementById('btn-refresh-hist');
            if(btn) btn.classList.add('animate-spin');
            
            try {
                const hResp = await fetch('/api/get_history');
                globalHistory = await hResp.json();
                window.applySort();
                updateDashboardDisplays();
                addLog(t("console.historyUpdated", "Historie aktualisiert."), "info");
            } catch(e) {
                addLog(t("console.historyUpdateError", "Fehler beim Aktualisieren der Historie."), "error");
                console.error(e);
            } finally {
                if(btn) btn.classList.remove('animate-spin');
            }
        };

        function updateAutoToggleUI() {
            const knob = document.getElementById('auto-toggle-knob');
            if(autoBackupEnabled) {
                knob.style.left = '24px';
                knob.style.backgroundColor = '#0084ff';
            } else {
                knob.style.left = '4px';
                knob.style.backgroundColor = '#64748b';
            }
        }

        function toggleAutoBackup() {
            autoBackupEnabled = !autoBackupEnabled;
            updateAutoToggleUI();
        }

        function updateNamingPreview() {
            try {
                const elCustom = document.getElementById('config-naming-custom');
                const elDate = document.getElementById('config-naming-date');
                const elTime = document.getElementById('config-naming-time');
                const elSeq = document.getElementById('config-naming-seq');
                const elSeqVal = document.getElementById('config-naming-seq-val');
                const elPreview = document.getElementById('naming-preview');

                if (!elPreview) return;

                const custom = elCustom ? elCustom.value : "";
                const incDate = elDate ? elDate.checked : true;
                const incTime = elTime ? elTime.checked : true;
                const incSeq = elSeq ? elSeq.checked : false;

                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');

                let parts = [];
                if (custom) parts.push(custom);
                if (incDate) parts.push(dateStr);
                if (incTime) parts.push(timeStr);
                if (incSeq) {
                    const rawSeq = elSeqVal ? elSeqVal.value : "1";
                    const seqVal = rawSeq || "1";
                    let s = seqVal.toString();
                    while (s.length < 3) s = "0" + s;
                    parts.push(s);
                }

                if (parts.length === 0) {
                    parts.push("backup");
                    parts.push(dateStr + "_" + timeStr);
                }

                elPreview.innerText = parts.join('_') + ".zip";
            } catch (e) {
                console.error("Naming Preview Error:", e);
            }
        }

        async function loadConfigUI() {
            const resp = await fetch('/api/get_config');
            const conf = await resp.json();
            
            // Bestehende Felder
            if(document.getElementById('config-source')) document.getElementById('config-source').value = conf.default_source || "";
            if(document.getElementById('config-dest')) document.getElementById('config-dest').value = conf.default_dest || "";
            if(document.getElementById('config-retention')) document.getElementById('config-retention').value = conf.retention_count || 10;
            if(document.getElementById('config-auto-interval')) document.getElementById('config-auto-interval').value = conf.auto_interval || 0;
            
            // Naming Felder
            if(document.getElementById('config-naming-custom')) document.getElementById('config-naming-custom').value = conf.naming_custom_text || "backup";
            if(document.getElementById('config-naming-date')) document.getElementById('config-naming-date').checked = (conf.naming_include_date !== undefined) ? conf.naming_include_date : true;
            if(document.getElementById('config-naming-time')) document.getElementById('config-naming-time').checked = (conf.naming_include_time !== undefined) ? conf.naming_include_time : true;
            if(document.getElementById('config-naming-seq')) document.getElementById('config-naming-seq').checked = (conf.naming_include_seq !== undefined) ? conf.naming_include_seq : false;
            if(document.getElementById('config-naming-seq-val')) document.getElementById('config-naming-seq-val').value = conf.naming_seq_counter || 1;
            
            updateNamingPreview();

            // Advanced Felder
            if(document.getElementById('config-compression')) document.getElementById('config-compression').value = (conf.compression_level !== undefined) ? conf.compression_level : 3;
            if(document.getElementById('config-exclusions')) document.getElementById('config-exclusions').value = conf.exclusions || "";

            // Notifications
            if(document.getElementById('config-notify-success')) document.getElementById('config-notify-success').checked = conf.notify_on_success || false;
            if(document.getElementById('config-notify-error')) document.getElementById('config-notify-error').checked = conf.notify_on_error || false;
            if(document.getElementById('config-discord-url')) document.getElementById('config-discord-url').value = conf.discord_webhook_url || "";
            if(document.getElementById('config-telegram-token')) document.getElementById('config-telegram-token').value = conf.telegram_token || "";
            if(document.getElementById('config-telegram-chatid')) document.getElementById('config-telegram-chatid').value = conf.telegram_chat_id || "";

            autoBackupEnabled = conf.auto_backup_enabled || false;
            updateAutoToggleUI();

            // Cloud Felder
            if(document.getElementById('config-cloud-enabled')) document.getElementById('config-cloud-enabled').checked = conf.cloud_sync_enabled || false;
            if(document.getElementById('config-cloud-provider')) document.getElementById('config-cloud-provider').value = conf.cloud_provider || "SFTP";
            if(document.getElementById('config-cloud-direction')) document.getElementById('config-cloud-direction').value = conf.cloud_direction || "upload";
            if(document.getElementById('config-cloud-host')) document.getElementById('config-cloud-host').value = conf.cloud_host || "";
            if(document.getElementById('config-cloud-port')) document.getElementById('config-cloud-port').value = conf.cloud_port || "22";
            if(document.getElementById('config-cloud-bucket')) document.getElementById('config-cloud-bucket').value = conf.cloud_bucket || "";
            if(document.getElementById('config-cloud-region')) document.getElementById('config-cloud-region').value = conf.cloud_region || "";
            if(document.getElementById('config-cloud-path')) document.getElementById('config-cloud-path').value = conf.cloud_target_path || "";
            if(document.getElementById('config-cloud-local-path')) document.getElementById('config-cloud-local-path').value = conf.cloud_local_path || "";
            if(document.getElementById('cloud-zip-download')) document.getElementById('cloud-zip-download').checked = conf.cloud_zip_download || false;
            if(document.getElementById('config-cloud-user')) document.getElementById('config-cloud-user').value = conf.cloud_user || "";
            if(document.getElementById('config-cloud-password')) document.getElementById('config-cloud-password').value = conf.cloud_password || "";
            if(document.getElementById('config-cloud-api-key')) document.getElementById('config-cloud-api-key').value = conf.cloud_api_key || "";
            
            // DB Backup Felder
            if(document.getElementById('config-db-enabled')) document.getElementById('config-db-enabled').checked = conf.db_backup_enabled || false;
            if(document.getElementById('config-db-type')) document.getElementById('config-db-type').value = conf.db_type || "mysql";
            if(document.getElementById('config-db-host')) document.getElementById('config-db-host').value = conf.db_host || "";
            if(document.getElementById('config-db-port')) document.getElementById('config-db-port').value = conf.db_port || "";
            if(document.getElementById('config-db-user')) document.getElementById('config-db-user').value = conf.db_user || "";
            if(document.getElementById('config-db-password')) document.getElementById('config-db-password').value = conf.db_password || "";
            if(document.getElementById('config-db-names')) document.getElementById('config-db-names').value = conf.db_names || "";

            // GitHub Felder
            if(document.getElementById('config-github-enabled')) document.getElementById('config-github-enabled').checked = conf.github_backup_enabled || false;
            if(document.getElementById('config-github-url')) document.getElementById('config-github-url').value = conf.github_url || "";
            if(document.getElementById('config-github-path')) document.getElementById('config-github-path').value = conf.github_path || "";
            if(document.getElementById('config-github-token')) document.getElementById('config-github-token').value = conf.github_token || "";
            
            updateCloudTresorUI();
            updateGithubUI();
            updateDbUI();

            // Encryption Felder
            if(document.getElementById('config-enc-enabled')) document.getElementById('config-enc-enabled').checked = conf.encryption_enabled || false;
            if(document.getElementById('config-enc-password')) document.getElementById('config-enc-password').value = conf.encryption_password || "";
        }

        function updateHeaderClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('de-DE', { hour12: false });
            const dateStr = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            if(document.getElementById('header-time')) document.getElementById('header-time').innerText = timeStr;
            if(document.getElementById('header-date')) document.getElementById('header-date').innerText = dateStr;
        }
        setInterval(updateHeaderClock, 1000);
        updateHeaderClock();

        function setGlobalUnit(unit) {
            globalUnit = unit;
            document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('unit-' + unit.toLowerCase()).classList.add('active');
            const header = document.getElementById('history-size-header');
            if(header) header.innerText = `Gr√∂√üe`; // Einheit wird jetzt pro Zeile angezeigt
            updateDashboardDisplays();
        }

        /**
         * Formatiert Byte-Werte intelligent.
         * Beachtet die globale Einheit (GB/MB), schaltet aber bei kleinen Werten automatisch runter,
         * um "0,00 GB" zu vermeiden (z.B. 500 KB statt 0,00 GB).
         */
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return "0,00 " + globalUnit;
            
            const G = 1024**3;
            const M = 1024**2;
            const K = 1024;
            
            // Wenn GB als Basis gew√§hlt ist
            if (globalUnit === 'GB') {
                // Unter 10 MB -> Anzeige in MB oder KB
                if (bytes < 0.01 * G) { 
                    if (bytes < 0.1 * M) { // Unter 100 KB -> Anzeige in KB
                        return (bytes / K).toFixed(2).replace('.', ',') + " KB";
                    }
                    return (bytes / M).toFixed(2).replace('.', ',') + " MB";
                }
                return (bytes / G).toFixed(2).replace('.', ',') + " GB";
            }
            
            // Wenn MB als Basis gew√§hlt ist
            if (globalUnit === 'MB') {
                 if (bytes < 0.1 * M) { // Unter 100 KB -> Anzeige in KB
                    return (bytes / K).toFixed(2).replace('.', ',') + " KB";
                }
                return (bytes / M).toFixed(2).replace('.', ',') + " MB";
            }
            
            return (bytes / M).toFixed(2).replace('.', ',') + " MB"; // Fallback
        }

        function toggleSidebar() {
            const sb = document.getElementById('main-sidebar');
            const bd = document.getElementById('sidebar-backdrop');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                bd.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                bd.classList.add('hidden');
            }
        }

        function switchTab(tabId) {
            // Close sidebar on mobile if open
            if(window.innerWidth < 768) {
                const sb = document.getElementById('main-sidebar');
                if(sb && !sb.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }

            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('nav-' + tabId).classList.add('active');
            if(tabId === 'dashboard' && storageChart) {
                setTimeout(() => { storageChart.resize(); storageChart.update(); }, 100);
            }
        }

        function openBugReportModal() {
            try {
                window.open('https://github.com/Exulizer/Backup_Pro/issues', '_blank');
            } catch (e) {
                console.error("BugReport Open Error:", e);
            }
        }

        function calculateHealth() {
            let score = 0;
            let covPts = 0, recPts = 0, dskPts = 0;
            const healthEl = document.getElementById('score-val');
            const labelEl = document.getElementById('health-label');
            
            // COV: Based on configured retention, not display limit
            covPts = Math.min(40, (globalHistory.length / configuredRetention) * 40);
            score += covPts;

            if (globalHistory.length > 0) {
                // Find actual latest backup (independent of sort)
                const timestamps = globalHistory.map(h => new Date(h.timestamp.replace(' ', 'T')).getTime());
                const latestTs = Math.max(...timestamps);
                const diffHours = (Date.now() - latestTs) / (1000 * 60 * 60);

                if (diffHours < 24) recPts = 40;
                else if (diffHours < 72) recPts = 20;
                else recPts = 5;
            }
            score += recPts;

            if (currentDiskUsedPercent < 80) dskPts = 20;
            else if (currentDiskUsedPercent < 95) dskPts = 10;
            else dskPts = 2;
            score += dskPts;

            const finalScore = Math.min(100, Math.round(score));
            if(healthEl) healthEl.innerText = finalScore;
            
            if(document.getElementById('bar-cov')) document.getElementById('bar-cov').style.width = (covPts / 40 * 100) + "%";
            if(document.getElementById('bar-rec')) document.getElementById('bar-rec').style.width = (recPts / 40 * 100) + "%";
            if(document.getElementById('bar-disk')) document.getElementById('bar-disk').style.width = (dskPts / 20 * 100) + "%";
            
            // Update percentage texts
            if(document.getElementById('val-cov')) document.getElementById('val-cov').innerText = Math.round(covPts / 40 * 100) + "%";
            if(document.getElementById('val-rec')) document.getElementById('val-rec').innerText = Math.round(recPts / 40 * 100) + "%";
            if(document.getElementById('val-disk')) document.getElementById('val-disk').innerText = Math.round(dskPts / 20 * 100) + "%";

            if(healthEl) {
                healthEl.classList.remove('score-good', 'score-warn', 'score-crit');
                if(finalScore > 80) { healthEl.classList.add('score-good'); labelEl.innerText = "Status: Optimal"; }
                else if(finalScore > 40) { healthEl.classList.add('score-warn'); labelEl.innerText = "Status: Eingeschr√§nkt"; }
                else { healthEl.classList.add('score-crit'); labelEl.innerText = "Status: Kritisch"; }
            }
        }

        function toggleChartScale() {
            if(!storageChart) return;
            const isLog = document.getElementById('chart-log-scale').checked;
            storageChart.options.scales.y.type = isLog ? 'logarithmic' : 'linear';
            storageChart.update();
        }

        function initChart() {
            const ctx = document.getElementById('storageChart').getContext('2d');
            storageChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: 'Snapshot Size', 
                        data: [],
                        filenames: [], 
                        backgroundColor: [], 
                        borderColor: [], 
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.9,
                        categoryPercentage: 0.8,
                        minBarLength: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(17, 20, 29, 0.9)',
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            bodyFont: { family: 'JetBrains Mono' },
                            callbacks: {
                                title: function(context) {
                                    let idx = context[0].dataIndex;
                                    let fname = context[0].dataset.filenames[idx] || "";
                                    return context[0].label + (fname ? " (" + fname + ")" : "");
                                },
                                label: function(context) {
                                    let val = context.parsed.y;
                                    if (val === undefined || val === null) val = context.raw;
                                    return "Gr√∂√üe: " + Number(val).toFixed(2).replace('.', ',') + " " + globalUnit;
                                }
                            }
                        }
                    }, 
                    scales: { 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#64748b', font: { size: 9, family: 'JetBrains Mono' }, maxRotation: 45, minRotation: 45 } 
                        }, 
                        y: { 
                            type: 'linear',
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { 
                                color: '#475569', 
                                font: { size: 9 }, 
                                callback: function(value) { 
                                    return Number(value).toFixed(2).replace('.', ',') + ' ' + globalUnit; 
                                } 
                            } 
                        } 
                    } 
                }
            });
        }



        async function updateDiskStats() {
            const dest = document.getElementById('dest').value;
            if(!dest) return;
            try {
                const resp = await fetch('/api/get_disk_stats', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path: dest}) });
                const data = await resp.json();
                if(data.total > 0) {
                    currentDiskUsedPercent = (data.used / data.total) * 100;
                    
                    const bar = document.getElementById('disk-bar');
                    const pctEl = document.getElementById('disk-percent');
                    const warnEl = document.getElementById('disk-warning');
                    
                    bar.className = "h-full w-0 transition-all duration-1000 relative z-10";
                    pctEl.className = "text-[11px] font-bold";
                    
                    let colorClass = "bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]";
                    let textClass = "text-blue-400";
                    
                    if(currentDiskUsedPercent > 90) {
                        colorClass = "bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]";
                        textClass = "text-red-500";
                        if(warnEl) warnEl.classList.remove('hidden');
                    } else if(currentDiskUsedPercent > 75) {
                        colorClass = "bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.5)]";
                        textClass = "text-yellow-500";
                        if(warnEl) warnEl.classList.add('hidden');
                    } else {
                        if(warnEl) warnEl.classList.add('hidden');
                    }
                    
                    bar.className += " " + colorClass;
                    bar.style.width = currentDiskUsedPercent + '%';
                    pctEl.className += " " + textClass;
                    pctEl.innerText = currentDiskUsedPercent.toFixed(1) + '%';
                    
                    const formatGB = (b) => {
                        if (!b) return "0,00 GB";
                        return (b / (1024**3)).toFixed(2).replace('.', ',') + " GB";
                    };
        
                    if(document.getElementById('disk-used-val')) document.getElementById('disk-used-val').innerText = formatGB(data.used);
                    if(document.getElementById('disk-free-val')) document.getElementById('disk-free-val').innerText = formatGB(data.free);
                    if(document.getElementById('disk-total-val')) document.getElementById('disk-total-val').innerText = formatGB(data.total);
                    
                    calculateHealth();
                }
            } catch(e) {}
        }
        
        function refreshSourceAnalysis() {
            updateDiskStats();
            
            let analysisPath = document.getElementById('source').value;
            if(document.getElementById('config-cloud-enabled') && document.getElementById('config-cloud-enabled').checked) {
                 const dir = document.getElementById('config-cloud-direction') ? document.getElementById('config-cloud-direction').value : 'upload';
                 if(dir === 'download') {
                     analysisPath = document.getElementById('dest').value;
                 }
            }
            
            if(analysisPath) {
                fetch('/api/analyze_source', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path: analysisPath}) })
                    .then(r => r.json())
                    .then(sData => {
                        if(document.getElementById('src-size')) document.getElementById('src-size').innerText = formatSize(sData.size);
                        if(document.getElementById('src-files')) document.getElementById('src-files').innerText = sData.count + " FILES";
        
                        const dSizeVal = document.getElementById('delta-size-val');
                        const dSizeBadge = document.getElementById('delta-size-badge');
                        const dFilesVal = document.getElementById('delta-files-val');
                        const dFilesBadge = document.getElementById('delta-files-badge');
                        const dRefInfo = document.getElementById('delta-ref-info');
                        const dModeBadge = document.getElementById('delta-mode-badge');
        
                        let deltaMode = "LOCAL";
                        if(document.getElementById('config-cloud-enabled') && document.getElementById('config-cloud-enabled').checked) {
                             const dir = document.getElementById('config-cloud-direction') ? document.getElementById('config-cloud-direction').value : 'upload';
                             deltaMode = dir === 'download' ? "DOWNLOAD" : "UPLOAD";
                        }
                        if(dModeBadge) dModeBadge.innerText = deltaMode;
        
                        const normAnalysisPath = analysisPath.replace(/\\\\/g, '/').toLowerCase();
                        
                        let relevantHistory = globalHistory.filter(e => {
                            if(!e.source_path) return false;
                            return e.source_path.replace(/\\\\/g, '/').toLowerCase() === normAnalysisPath;
                        });
        
                        if(dSizeVal && relevantHistory.length > 0) {
                            let lastEntry = relevantHistory[0];
                            for (let i = 1; i < relevantHistory.length; i++) {
                                const entry = relevantHistory[i];
                                if ((entry.timestamp || "") > (lastEntry.timestamp || "")) {
                                    lastEntry = entry;
                                }
                            }
                            
                            const lastCount = lastEntry.file_count || 0;
                            const currentCount = sData.count || 0;
                            const deltaCount = currentCount - lastCount;
                            
                            let deltaSize = 0;
                            let validDelta = false;
        
                            if (lastEntry.source_size) {
                                const lastSize = lastEntry.source_size;
                                const currentSize = sData.size || 0;
                                deltaSize = currentSize - lastSize;
                                validDelta = true;
                            } else {
                                validDelta = false;
                            }
                            
                            if (validDelta) {
                                const sizeFmt = formatSize(Math.abs(deltaSize));
                                dSizeVal.innerText = (deltaSize > 0 ? "+" : (deltaSize < 0 ? "-" : "")) + sizeFmt;
                                
                                if(deltaSize === 0) {
                                    dSizeBadge.innerText = "UNCHANGED";
                                    dSizeBadge.className = "text-[10px] font-bold text-slate-600 block mt-1";
                                } else if(deltaSize > 0) {
                                    dSizeBadge.innerText = "INCREASE";
                                    dSizeBadge.className = "text-[10px] font-bold text-red-400 block mt-1";
                                } else {
                                    dSizeBadge.innerText = "DECREASE";
                                    dSizeBadge.className = "text-[10px] font-bold text-emerald-400 block mt-1";
                                }
                            } else {
                                dSizeVal.innerText = formatSize(sData.size || 0);
                                dSizeBadge.innerText = "BASE UPDATE";
                                dSizeBadge.className = "text-[10px] font-bold text-blue-400 block mt-1";
                            }
                            
                            dFilesVal.innerText = (deltaCount > 0 ? "+" : "") + deltaCount;
                             if(deltaCount === 0) {
                                dFilesBadge.innerText = "UNCHANGED";
                                dFilesBadge.className = "text-[10px] font-bold text-slate-600 block mt-1";
                            } else if(deltaCount > 0) {
                                dFilesBadge.innerText = "INCREASE";
                                dFilesBadge.className = "text-[10px] font-bold text-red-400 block mt-1";
                            } else {
                                dFilesBadge.innerText = "DECREASE";
                                dFilesBadge.className = "text-[10px] font-bold text-emerald-400 block mt-1";
                            }
                            
                            if(dRefInfo) dRefInfo.innerText = lastEntry.timestamp || "Unknown";
                            
                        } else if (dSizeVal) {
                            dSizeVal.innerText = formatSize(sData.size || 0);
                            dSizeBadge.innerText = "INITIAL";
                            dFilesVal.innerText = (sData.count || 0);
                            dFilesBadge.innerText = "INITIAL";
                            if(dRefInfo) dRefInfo.innerText = "Kein Backup";
                        }
                    })
                    .catch(e => console.error("Analyze Source Error:", e));
            }
        }
        
        async function loadData() {
            try {
                // STOP Boot Sequence Simulation if running
                if(window.bootInterval) {
                    clearInterval(window.bootInterval);
                    window.bootInterval = null;
                }

                // UI Felder aus Config laden
                await loadConfigUI();
                
                const cResp = await fetch('/api/get_config');
                const config = await cResp.json();
                configuredRetention = config.retention_count || 10;
                
                document.getElementById('source').value = config.default_source || "";
                document.getElementById('dest').value = config.default_dest || "";
                

                
                if(config.auto_backup_enabled && !autoBackupEnabled) toggleAutoBackup();

                const hResp = await fetch('/api/get_history');
                globalHistory = await hResp.json();
                
                // Ensure default sort (Newest First) is applied immediately
                try { window.applySort(); } catch(e) { console.error("Sort Error:", e); }

                // Force UI Sync for Limit (Do NOT overwrite currentLimit here)
                const limitEl = document.getElementById('history-limit');
                if(limitEl) {
                     limitEl.value = (currentLimit === 999999) ? 'all' : currentLimit;
                }
                
                // addLog("Daten geladen. Eintr√§ge: " + globalHistory.length + " Limit: " + currentLimit, "info");
                try { updateDashboardDisplays(); } catch(e) { console.error("Update Dashboard Error:", e); }

                // Ladeanimation ausblenden - mit simuliertem Progress f√ºr "Lazy Load" Effekt
                const loader = document.getElementById('startup-loader');
                if(loader) {
                    const consoleEl = document.getElementById('loader-console');
                    const percentEl = document.getElementById('loader-percent');
                    const barFill = document.querySelector('.loader-bar-fill');
                    
                    const steps = [
                        { p: 30, msg: "LOADING KERNEL MODULES..." },
                        { p: 55, msg: "CONNECTING TO UI ENGINE..." },
                        { p: 75, msg: "VERIFYING INTEGRITY..." },
                        { p: 90, msg: "STARTING SERVICES..." },
                        { p: 100, msg: "READY." }
                    ];

                    let stepIdx = 0;
                    const stepInterval = setInterval(() => {
                        if(stepIdx >= steps.length) {
                            clearInterval(stepInterval);
                            loader.style.opacity = '0';
                            setTimeout(() => { loader.style.display = 'none'; }, 500);
                            return;
                        }
                        const s = steps[stepIdx];
                        if(consoleEl) consoleEl.innerText = s.msg;
                        if(percentEl) percentEl.innerText = s.p + "%";
                        if(barFill) barFill.style.width = s.p + "%";
                        stepIdx++;
                    }, 300); // Alle 300ms ein Schritt
                }

            } catch(e) { 
                console.error("Load Error:", e);
                // Emergency Hide Loader
                const loader = document.getElementById('startup-loader');
                if(loader) {
                     loader.innerHTML = '<div class="text-red-500 font-mono text-center">SYSTEM BOOT FAILED.<br>' + e + '</div>';
                     setTimeout(() => { loader.style.display = 'none'; }, 3000);
                }
            }
        }

        function renderActivityChart(sourceData = null) {
            const container = document.getElementById('activity-chart-container');
            const statsContainer = document.getElementById('activity-stats-bar');
            if(!container) return;

            // Use provided data (sync with table) or fallback to globalHistory (startup)
            const rawData = sourceData || globalHistory;
            
            // Always sort by Date Ascending for the timeline visualization
            const sortedHistory = [...rawData].sort((a, b) => (a.timestamp || "") > (b.timestamp || "") ? 1 : -1);

            if(sortedHistory.length === 0) {
                container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-xs text-slate-600 font-mono">Keine Daten verf√ºgbar</div>';
                if(statsContainer) statsContainer.innerHTML = '';
                return;
            }

            // We use the full provided dataset (respecting the limit/pagination from the table)
            // No hardcoded limit of 50 anymore, unless we are using the full globalHistory fallback
            let relevantData = sortedHistory;
            
            // Only apply the "last 50" logic if we are falling back to the full global set (e.g. on init)
            // AND if the set is huge. But if sourceData is passed, we trust it.
            if (!sourceData && sortedHistory.length > 50) {
                relevantData = sortedHistory.slice(-50);
            }

            const dailyStats = {};
            let totalSize = 0;
            let totalCount = 0;

            relevantData.forEach(entry => {
                const date = (entry.timestamp || "").split(' ')[0];
                if(!date) return;
                if(!dailyStats[date]) dailyStats[date] = { size: 0, count: 0 };
                dailyStats[date].size += entry.size;
                dailyStats[date].count++;
                
                totalSize += entry.size;
                totalCount++;
            });

            let labels = Object.keys(dailyStats);
            if(labels.length === 0) {
                container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-xs text-slate-600 font-mono">Keine Daten verf√ºgbar</div>';
                if(statsContainer) statsContainer.innerHTML = '';
                return;
            }

            const firstDate = new Date(labels[0] + 'T00:00:00');
            const lastDate = new Date(labels[labels.length - 1] + 'T00:00:00');
            const fullLabels = [];
            const cursor = new Date(firstDate.getTime());
            while(cursor <= lastDate) {
                const y = cursor.getFullYear();
                const m = String(cursor.getMonth() + 1).padStart(2, '0');
                const d = String(cursor.getDate()).padStart(2, '0');
                const key = `${y}-${m}-${d}`;
                if(!dailyStats[key]) dailyStats[key] = { size: 0, count: 0 };
                fullLabels.push(key);
                cursor.setDate(cursor.getDate() + 1);
            }
            labels = fullLabels;

            const dataPoints = labels.map(d => dailyStats[d].size);
            const maxVal = Math.max(...dataPoints, 1);
            
            if(statsContainer) {
                statsContainer.classList.remove('opacity-50');
                const avgSize = totalSize / (labels.length || 1);
                const daysWithBackups = labels.filter(d => dailyStats[d].count > 0).length;
                const avgSizeActiveOnly = daysWithBackups > 0 ? totalSize / daysWithBackups : 0;
                const successRate = labels.length ? Math.round((daysWithBackups / labels.length) * 100) : 0;
                
                const avgPerBackup = totalCount > 0 ? totalSize / totalCount : 0;
                const lastSnapSize = relevantData.length > 0 ? relevantData[relevantData.length - 1].size : 0;
                
                const avgDailyFreq = daysWithBackups > 0 ? (totalCount / daysWithBackups).toFixed(1) : "0.0";
                
                let timeAgoStr = "--";
                if(relevantData.length > 0) {
                     const lastTs = new Date(relevantData[relevantData.length - 1].timestamp.replace(" ", "T"));
                     const now = new Date();
                     const diffMs = now - lastTs;
                     const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                     const diffDays = Math.floor(diffHrs / 24);
                     const lang = window.BP_LANG || 'de';
                     
                     if(lang === 'en') {
                        if(diffDays > 0) timeAgoStr = `${diffDays} day${diffDays!==1?'s':''} ago`;
                        else if(diffHrs > 0) timeAgoStr = `${diffHrs} h ago`;
                        else {
                            const diffMin = Math.floor(diffMs / (1000 * 60));
                            timeAgoStr = `${diffMin} min ago`;
                        }
                     } else {
                        if(diffDays > 0) timeAgoStr = `vor ${diffDays} Tag${diffDays!==1?'en':''}`;
                        else if(diffHrs > 0) timeAgoStr = `vor ${diffHrs} Std.`;
                        else {
                            const diffMin = Math.floor(diffMs / (1000 * 60));
                            timeAgoStr = `vor ${diffMin} Min.`;
                        }
                     }
                }

                statsContainer.innerHTML = `
                    <div class="bg-[#0f111a] p-3 rounded border border-white/5 flex flex-col justify-center relative overflow-hidden group/stat">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover/stat:opacity-20 transition-opacity">
                            <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        </div>
                        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-3" data-i18n="dashboard.totalVolumeCardTitle">Gesamtvolumen</span>
                        <div class="flex flex-col gap-1 mt-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.totalVolumeSumLabel">Summe:</span>
                                <span class="text-sm font-black text-blue-400 font-mono">${formatSize(totalSize)}</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.totalVolumeAvgPerSnapLabel">√ò pro Snap:</span>
                                <span class="text-xs font-bold text-slate-400 font-mono">${formatSize(avgPerBackup)}</span>
                            </div>
                            <div class="flex justify-between items-baseline border-t border-white/5 pt-1 mt-1">
                                <span class="text-[10px] text-slate-500" data-i18n="dashboard.totalVolumeLastLabel">Letzter:</span>
                                <span class="text-xs font-bold text-blue-300 font-mono">${formatSize(lastSnapSize)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#0f111a] p-3 rounded border border-white/5 flex flex-col justify-center relative overflow-hidden group/stat">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover/stat:opacity-20 transition-opacity">
                            <svg class="w-8 h-8 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        </div>
                        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-3" data-i18n="dashboard.dailyVolumeCardTitle">T√§gliches Volumen</span>
                        <div class="flex flex-col gap-1 mt-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.dailyVolumeAvgOverallLabel">√ò Gesamt:</span>
                                <span class="text-sm font-black text-slate-300 font-mono">${formatSize(avgSize)}</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.dailyVolumeAvgActiveLabel">√ò Aktiv:</span>
                                <span class="text-xs font-bold text-slate-400 font-mono">${formatSize(avgSizeActiveOnly)}</span>
                            </div>
                            <div class="flex justify-between items-baseline border-t border-white/5 pt-1 mt-1">
                                <span class="text-[10px] text-slate-500" data-i18n="dashboard.dailyVolumeMaxPeakLabel">Max Peak:</span>
                                <span class="text-xs font-bold text-purple-400 font-mono">${formatSize(maxVal)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#0f111a] p-3 rounded border border-white/5 flex flex-col justify-center relative overflow-hidden group/stat">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover/stat:opacity-20 transition-opacity">
                            <svg class="w-8 h-8 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-3" data-i18n="dashboard.backupStatsCardTitle">Backups</span>
                        <div class="flex flex-col gap-1 mt-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.backupStatsCountLabel">Anzahl:</span>
                                <span class="text-sm font-black text-emerald-400 font-mono">${totalCount}</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] text-slate-400" data-i18n="dashboard.backupStatsFrequencyLabel">Frequenz:</span>
                                <span class="text-xs font-bold text-slate-400 font-mono">~${avgDailyFreq} <span data-i18n="dashboard.backupStatsPerDaySuffix">/ Tag</span></span>
                            </div>
                            <div class="flex justify-between items-baseline border-t border-white/5 pt-1 mt-1">
                                <span class="text-[10px] text-slate-500" data-i18n="dashboard.backupStatsLastLabel">Letztes:</span>
                                <span class="text-xs font-bold text-emerald-300 font-mono">${timeAgoStr}</span>
                            </div>
                        </div>
                    </div>
                `;
                if (window.BP_I18N_DICT) {
                    try { applyTranslations(window.BP_I18N_DICT); } catch(e) {}
                }
            }
            
            const width = container.clientWidth || 800;
            const height = container.clientHeight || 192;
            const padding = 65;
            const chartW = width - (padding * 2);
            const chartH = height - (padding * 2);

            if(labels.length < 2) {
                 container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-xs text-slate-600 font-mono" data-i18n="dashboard.notEnoughData">Nicht gen√ºgend Daten f√ºr Verlauf (min. 2 Tage)</div>';
                 if (window.BP_I18N_DICT) {
                    try { applyTranslations(window.BP_I18N_DICT); } catch(e) {}
                 }
                 return;
            }

            const rnd = (n) => (typeof n === 'number' && !isNaN(n)) ? parseFloat(n.toFixed(2)) : 0;

            const points = labels.map((label, idx) => {
                const val = dataPoints[idx];
                const x = rnd(padding + (idx / Math.max(labels.length - 1, 1)) * chartW);
                // Ensure y is finite. If maxVal is 0, render at baseline (height - padding)
                const ratio = maxVal > 0 ? (val / maxVal) : 0;
                const y = rnd(height - padding - (ratio * chartH));
                
                const stats = dailyStats[label];
                const hasBackup = stats.count > 0;
                let prettyDate = label;
                try {
                    const parts = label.split('-');
                    if (parts.length === 3) {
                        prettyDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                    }
                } catch(e) {}
                return { x, y, val, date: label, prettyDate, count: stats.count, hasBackup };
            });

            let pathD = `M ${points[0].x} ${points[0].y}`;
            
            // Generate smooth curve path
            if (points.length > 2) {
                for(let i=0; i < points.length - 1; i++) {
                    const p0 = points[Math.max(0, i-1)];
                    const p1 = points[i];
                    const p2 = points[i+1];
                    const p3 = points[Math.min(points.length-1, i+2)];
                    
                    const cp1x = rnd(p1.x + (p2.x - p0.x) * 0.15); // Tension factor
                    const cp1y = rnd(p1.y + (p2.y - p0.y) * 0.15);
                    const cp2x = rnd(p2.x - (p3.x - p1.x) * 0.15);
                    const cp2y = rnd(p2.y - (p3.y - p1.y) * 0.15);
                    
                    // Clamp control points to prevent wild loops
                    const clampX = (v, min, max) => Math.min(Math.max(v, min), max);
                    // Use a slightly wider range to allow smooth turns, but prevent extreme artifacts
                    // No clamping for now as it might cause sharp edges, trust the tension factor
                    
                    pathD += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
            } else {
                for(let i = 1; i < points.length; i++) {
                    pathD += ` L ${points[i].x} ${points[i].y}`;
                }
            }

            let areaD = pathD + ` L ${points[points.length-1].x} ${height - padding} L ${points[0].x} ${height - padding} Z`;
            const midY = padding + chartH / 2;
            const gridColor = '#ffffff';
            const textColor = '#94a3b8';

            const lang = (window.BP_LANG || 'de').toLowerCase();
            const xAxisLabel = lang === 'en' ? 'Date' : 'Datum';
            const yAxisLabel = lang === 'en' ? `Volume (${globalUnit})` : `Volumen (${globalUnit})`;

            const xTicksSvg = labels.map((label, idx) => {
                let tickText = label;
                try {
                    const parts = label.split('-');
                    if (parts.length === 3) {
                        tickText = `${parts[2]}.${parts[1]}.`;
                    }
                } catch(e) {}
                const x = rnd(padding + (idx / Math.max(labels.length - 1, 1)) * chartW);
                return `<text x="${x}" y="${height - padding + 18}" fill="${textColor}" font-size="9" text-anchor="middle">${tickText}</text>`;
            }).join('');

            const svg = `
            <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" class="font-sans">
                <defs>
                    <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/>
                        <stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/>
                    </linearGradient>
                    <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <line x1="${padding}" y1="${height-padding}" x2="${width-padding}" y2="${height-padding}" stroke="${gridColor}" stroke-opacity="0.1" stroke-width="1" />
                <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height-padding}" stroke="${gridColor}" stroke-opacity="0.1" stroke-width="1" />
                <line x1="${padding}" y1="${midY}" x2="${width-padding}" y2="${midY}" stroke="${gridColor}" stroke-opacity="0.05" stroke-width="1" stroke-dasharray="4 4" />
                <line x1="${padding}" y1="${padding}" x2="${width-padding}" y2="${padding}" stroke="${gridColor}" stroke-opacity="0.05" stroke-width="1" stroke-dasharray="4 4" />
                
                <text x="${padding - 12}" y="${height - padding + 4}" fill="${textColor}" font-size="10" font-family="Inter, sans-serif" text-anchor="end">0</text>
                <text x="${padding - 12}" y="${midY + 4}" fill="${textColor}" font-size="10" font-family="Inter, sans-serif" text-anchor="end">${formatSize(maxVal/2)}</text>
                <text x="${padding - 12}" y="${padding + 4}" fill="${textColor}" font-size="10" font-family="Inter, sans-serif" text-anchor="end">${formatSize(maxVal)}</text>

                ${xTicksSvg}
                <text x="${width / 2}" y="${height - 8}" fill="${textColor}" font-size="10" font-weight="600" font-family="Inter, sans-serif" text-anchor="middle" class="uppercase tracking-wider opacity-60">${xAxisLabel}</text>
                <text x="${padding - 65}" y="${height / 2}" fill="${textColor}" font-size="10" font-weight="600" font-family="Inter, sans-serif" text-anchor="middle" transform="rotate(-90 ${padding - 65} ${height / 2})" class="uppercase tracking-wider opacity-60">${yAxisLabel}</text>

                <path d="${areaD}" fill="url(#chartGradient)" stroke="none" />
                <path d="${pathD}" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" filter="url(#glow)" />
                ${points.map((p, i) => `
                    <g class="chart-point group/point">
                        <circle cx="${p.x}" cy="${p.y}" r="4" fill="#0f172a" stroke="${p.hasBackup ? '#3b82f6' : '#ef4444'}" stroke-width="2" class="cursor-pointer transition-all duration-300 group-hover/point:r-6 group-hover/point:fill-white group-hover/point:stroke-width-3" />
                        <foreignObject x="${Math.min(Math.max(0, p.x - 80), width - 160)}" y="${Math.max(0, p.y - 100)}" width="160" height="90" class="opacity-0 group-hover/point:opacity-100 transition-opacity duration-200 pointer-events-none overflow-visible z-50">
                            <div xmlns="http://www.w3.org/1999/xhtml" class="bg-[#0f172a]/95 backdrop-blur-md text-xs rounded-lg p-3 border border-blue-500/20 shadow-2xl shadow-black/50 font-sans transform translate-y-2">
                                <div class="font-bold text-white mb-2 pb-2 border-b border-white/10 flex justify-between items-center">
                                    <span>${p.prettyDate}</span>
                                    <span class="${p.hasBackup ? 'text-blue-400' : 'text-red-400'} text-[10px] px-1.5 py-0.5 rounded-full bg-white/5 border border-white/5">${p.hasBackup ? 'Backup' : 'Leer'}</span>
                                </div>
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-center"><span class="text-slate-400 text-[11px]">Volumen</span><span class="text-blue-400 font-mono font-medium">${formatSize(p.val)}</span></div>
                                    <div class="flex justify-between items-center"><span class="text-slate-400 text-[11px]">Anzahl</span><span class="text-emerald-400 font-mono font-medium">${p.count}</span></div>
                                </div>
                            </div>
                        </foreignObject>
                    </g>
                `).join('')}
            </svg>
            `;
            container.innerHTML = svg;
        }

        function updateDashboardDisplays() {
            const table = document.getElementById('history-table-body');
            const restoreTable = document.getElementById('restore-table-body');
            if(!table || !restoreTable) return;
            
            // ALWAYS ensure sort before display to guarantee consistency
            window.applySort();

            // Calculate displayData first so we can pass it to the chart
            const totalItems = globalHistory.length;
            let displayData = globalHistory;
            if (currentLimit > 0 && currentLimit !== 999999 && totalItems > 0) {
                const totalPages = Math.max(1, Math.ceil(totalItems / currentLimit));
                if (currentPage > totalPages) currentPage = totalPages;
                const startIdx = (currentPage - 1) * currentLimit;
                const endIdx = startIdx + currentLimit;
                displayData = globalHistory.slice(startIdx, endIdx);
            } else {
                currentPage = 1;
            }

            // Sync: Render Activity Chart with the SAME data as the table
            renderActivityChart(displayData);

            // Update Total Snaps Badge
            const totalBadge = document.getElementById('total-snaps-badge');
            if(totalBadge) totalBadge.innerText = globalHistory.length;

            // Debug Logging for Limit Issues
            // console.log("Rendering History. Limit:", currentLimit, "Total Items:", globalHistory.length);

            table.innerHTML = ''; restoreTable.innerHTML = '';
            let totalBytes = 0;
            storageChart.data.labels = [];
            storageChart.data.datasets[0].data = [];
            storageChart.data.datasets[0].filenames = [];
            storageChart.data.datasets[0].backgroundColor = [];
            storageChart.data.datasets[0].borderColor = [];

            // Display Data Logic moved up ^^^

            const pageLabel = document.getElementById('history-page-label');
            if (pageLabel) {
                if (currentLimit === 999999 || totalItems === 0) {
                    pageLabel.innerText = "";
                } else {
                    const totalPages = Math.max(1, Math.ceil(totalItems / currentLimit));
                    pageLabel.innerText = currentPage + " / " + totalPages;
                }
            }
            const now = new Date();
            const indexedDisplay = displayData.map(e => ({ entry: e, idx: globalHistory.indexOf(e) }));
            const ageSorted = [...indexedDisplay].sort((a, b) => {
                const da = new Date(a.entry.timestamp);
                const db = new Date(b.entry.timestamp);
                return da - db;
            });
            const rankByIdx = {};
            ageSorted.forEach((it, rank) => { rankByIdx[it.idx] = rank; });
            const maxRank = Math.max(ageSorted.length - 1, 1);

            displayData.forEach((entry, idx) => {
                totalBytes += entry.size;
                const formatted = formatSize(entry.size); // Smart String (z.B. "500 KB" oder "2,5 GB")
                const originalIdx = globalHistory.indexOf(entry);

                // Chart Value STRICT in globalUnit calc
                const isGB = globalUnit === 'GB';
                const chartDivisor = isGB ? (1024**3) : (1024**2);
                const chartVal = entry.size / chartDivisor;

                const rank = rankByIdx[originalIdx] || 0;
                const t = maxRank === 0 ? 0 : rank / maxRank;
                const startHue = 200;
                const endHue = 280;
                const startLight = 70;
                const endLight = 40;
                const sat = 80;
                const hue = startHue + (endHue - startHue) * t;
                const light = startLight + (endLight - startLight) * t;
                const color = `hsl(${hue}, ${sat}%, ${light}%)`;
                const colorTransparent = `hsla(${hue}, ${sat}%, ${light}%, 0.35)`;
                
                const lockIcon = entry.locked ? '<span title="Locked" class="ml-2 text-[10px]">üîí</span>' : '';

                table.insertAdjacentHTML('beforeend', `<tr onclick="showDetails(${originalIdx})" class="bg-white/5 border-b border-white/5 cursor-pointer hover:bg-white/10 transition-all">
                    <td class="px-4 py-3 mono text-[10px] text-slate-400">${entry.timestamp}</td>
                    <td class="px-4 py-3 font-bold text-xs" style="color: ${color}">${entry.filename}${lockIcon}</td>
                    <td class="px-4 py-3 text-right mono text-white text-xs">${formatted}</td>
                </tr>`);
                
                restoreTable.insertAdjacentHTML('beforeend', `<tr><td class="px-4 py-3 text-xs text-slate-400 mono">${entry.timestamp}</td><td class="px-4 py-3 font-bold text-xs" style="color: ${color}">${entry.filename}</td><td class="px-4 py-3 flex gap-2"><button onclick="restoreBackup('${entry.filename}')" class="text-[9px] font-black uppercase text-emerald-500 border border-emerald-500/30 px-3 py-1 rounded hover:bg-emerald-500/10 transition-colors">Restore</button><button onclick="deleteBackupApi('${entry.filename}')" class="text-[9px] font-black uppercase text-red-500 border border-red-500/30 px-3 py-1 rounded hover:bg-red-500/10 transition-colors">Delete</button></td></tr>`);
                
                // Datum sch√∂ner formatieren: "DD.MM. HH:mm"
                let dateLabel = entry.timestamp;
                try {
                    const parts = entry.timestamp.split(' ');
                    const dateParts = parts[0].split('-'); // [YYYY, MM, DD]
                    const timeParts = parts[1].split(':'); // [HH, MM, SS]
                    dateLabel = `${dateParts[2]}.${dateParts[1]}. ${timeParts[0]}:${timeParts[1]}`;
                } catch(e) {}

                storageChart.data.labels.push(dateLabel);
                storageChart.data.datasets[0].data.push(chartVal);
                storageChart.data.datasets[0].filenames.push(entry.filename);
                storageChart.data.datasets[0].backgroundColor.push(colorTransparent); 
                storageChart.data.datasets[0].borderColor.push(color);            
            });
            
            // Chart Direction Correction: If sorted by Date Desc (Newest First), reverse chart to show Time Forward (Old->New)
            if(currentSortMode === 0) {
                 storageChart.data.labels.reverse();
                 storageChart.data.datasets[0].data.reverse();
                 storageChart.data.datasets[0].filenames.reverse();
                 storageChart.data.datasets[0].backgroundColor.reverse();
                 storageChart.data.datasets[0].borderColor.reverse();
            }
            
            const totalFmt = formatSize(totalBytes).split(' ');
            if(document.getElementById('total-val-display')) document.getElementById('total-val-display').innerText = totalFmt[0];
            if(document.getElementById('total-unit-display')) document.getElementById('total-unit-display').innerText = totalFmt[1];
            if(document.getElementById('total-snapshots-display')) document.getElementById('total-snapshots-display').innerText = globalHistory.length + " Snapshots";

            storageChart.data.datasets[0].label = `Gr√∂√üe (${globalUnit})`;
            storageChart.update();
            refreshSourceAnalysis();
        }

        function clearLogs() {
            const log = document.getElementById('log');
            if(log) log.innerHTML = '';
        }

        function addLog(msg, type='info', key=null) {
            const log = document.getElementById('log');
            if(!log) return;
            const div = document.createElement('div');
            div.className = `log-${type}`;
            // Improved display with HTML
            const time = new Date().toLocaleTimeString();
            
            let msgHtml = `<span class="font-medium">${msg}</span>`;
            if (key) {
                msgHtml = `<span class="font-medium" data-i18n="${key}">${msg}</span>`;
            }
            
            div.innerHTML = `<span class="opacity-50 text-[10px] mr-2 font-mono">[${time}]</span>${msgHtml}`;
            log.appendChild(div);
            
            // Limit to 100 lines buffer (scrolling enabled, ~25 visible)
            if(log.children.length > 100) {
                log.removeChild(log.firstChild);
            }

            log.scrollTop = log.scrollHeight;
        }

        async function runBackup() {
            if (isBackupActive) return addLog(t("console.backupInProgress", "Backup l√§uft bereits!"), "warning");

            const source = document.getElementById('source').value;
            const dest = document.getElementById('dest').value;
            if(!source || !dest) return addLog(t("console.pathsMissing", "Pfade fehlen!"), "error");
            
            clearLogs();
            addLog(t("console.kernelInit", "Kernel: Initiiere Hintergrund-Job..."), "info");
            
            // Set Initial Status
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('console-status-text');
            if(ind) ind.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse transition-colors duration-300";
            if(txt) {
                txt.innerText = "INITIALISIERE...";
                txt.className = "text-[10px] font-black uppercase tracking-widest text-blue-400";
            }
            
            document.getElementById('zipPercent').innerText = "0%";
            document.getElementById('zipBar').style.width = "0%";
            isBackupActive = true;
            
            // Reset Module Status Areas
            ['status-area-github', 'status-area-db', 'status-area-cloud-tresor'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // Gather Options (Snapshot + UI Checkboxes)
            const modules = ['snapshot'];
            const cloudCb = document.getElementById('config-cloud-enabled');
            if(cloudCb && cloudCb.checked) modules.push('cloud');
            
            const dbCb = document.getElementById('config-db-enabled');
            if(dbCb && dbCb.checked) modules.push('db');
            
            const ghCb = document.getElementById('config-github-enabled');
            if(ghCb && ghCb.checked) modules.push('github');

            const task_options = {
                modules: modules,
                naming_custom_text: document.getElementById('cloud-naming-custom') ? document.getElementById('cloud-naming-custom').value : "",
                naming_include_date: document.getElementById('cloud-naming-date') ? document.getElementById('cloud-naming-date').checked : true,
                naming_include_time: document.getElementById('cloud-naming-time') ? document.getElementById('cloud-naming-time').checked : true,
                naming_include_seq: document.getElementById('cloud-naming-seq') ? document.getElementById('cloud-naming-seq').checked : false
            };
            
            try {
                // Robustere Fehlerbehandlung f√ºr Fetch
                const resp = await fetch('/api/start_backup', { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({
                        source, 
                        dest, 
                        comment: document.getElementById('snap-comment').value,
                        task_options: task_options
                    }) 
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP Error: ${resp.status}`);
                }

                const data = await resp.json();
                
                if(data.status === 'error') {
                     addLog(t("console.startError", "Start Fehler: ") + data.message, "error");
                     // Reset Status
                     if(ind) ind.className = "w-2 h-2 rounded-full bg-red-500 transition-colors duration-300";
                     if(txt) {
                        txt.innerText = "FEHLER";
                        txt.className = "text-[10px] font-black uppercase tracking-widest text-red-400";
                     }
                     isBackupActive = false;
                     return;
                }
                
                // Polling wird nun global erledigt (globalPoll)
                // Wir zeigen nur den Start an.
                addLog(t("console.backupStarted", "Backup Prozess im Hintergrund gestartet..."), "info");

            } catch(e) {
                console.error(e);
                addLog(t("console.networkError", "Netzwerk Fehler: ") + e.message, "error");
                // Reset Status
                 if(ind) ind.className = "w-2 h-2 rounded-full bg-red-500 transition-colors duration-300";
                 if(txt) {
                    txt.innerText = "NETZWERK FEHLER";
                    txt.className = "text-[10px] font-black uppercase tracking-widest text-red-400";
                 }
                isBackupActive = false;
            }
        }

        async function cancelBackup() {
            try {
                addLog(t("console.sendingAbort", "Sende Abbruch-Signal..."), "info");
                const resp = await fetch('/api/cancel_backup');
                const data = await resp.json();
                if(data.status !== 'success') {
                    addLog(t("console.abortFailed", "Abbruch fehlgeschlagen: ") + data.message, "error");
                }
            } catch(e) {
                addLog(t("console.abortSignalError", "Fehler beim Senden des Abbruch-Signals."), "error");
            }
        }

        async function restoreBackup(filename) {
            const dest = document.getElementById('dest').value;
            const source = document.getElementById('source').value;
            addLog(t("console.kernelRestoreStart", "Kernel: Starte Wiederherstellung..."), "info");
            const resp = await fetch('/api/restore_backup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ filename, dest, target: source }) });
            if((await resp.json()).status === 'success') addLog(t("console.kernelRestoreSuccess", "Kernel: Daten erfolgreich rekonstruiert!"), "success");
            else addLog(t("console.restoreFailed", "Restore fehlgeschlagen."), "error");
        }

        async function deleteBackupApi(filename) {
            if(!confirm(`Backup ${filename} wirklich l√∂schen?`)) return;
            const resp = await fetch('/api/delete_backup', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ filename }) });
            const result = await resp.json();
            if(result.status === 'success') {
                addLog(t("console.backupDeleted", "Backup gel√∂scht."), "info");
                loadData();
            } else addLog(t("console.deleteFailed", "L√∂schen fehlgeschlagen."), "error");
        }

        let currentModalFilename = "";

        function showDetails(idx) {
            const entry = globalHistory[idx];
            currentModalFilename = entry.filename;
            
            // Basic Meta
            document.getElementById('modal-filename').innerText = entry.filename;
            document.getElementById('modal-hash').innerText = entry.sha256;
            document.getElementById('modal-ts').innerText = entry.timestamp;
            document.getElementById('modal-size').innerText = formatSize(entry.size);
            
            // Comment
            document.getElementById('modal-comment').value = entry.comment || "";
            
            // Lock Status UI
            updateLockUI(entry.locked || false);
            
            // Integrity Reset
            document.getElementById('integrity-result').classList.add('hidden');
            
            // Actions
            document.getElementById('modal-delete-btn').onclick = () => { closeHashModal(); deleteBackupApi(entry.filename); };
            
            // Reset Tabs
            switchModalTab('meta');
            document.getElementById('zip-file-list').innerHTML = '<div class="p-8 text-center text-slate-500 text-xs uppercase tracking-widest animate-pulse">Lade Dateistruktur...</div>';
            document.getElementById('file-count-badge').innerText = "-- Files";
            
            // Show Modal
            const modal = document.getElementById('hash-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHashModal() { 
            const modal = document.getElementById('hash-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function switchModalTab(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.add('hidden'));
            
            if(tab === 'meta') {
                document.querySelector('.modal-tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-meta').classList.remove('hidden');
            } else {
                document.querySelector('.modal-tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-content').classList.remove('hidden');
                loadZipContent();
            }
        }
        
        async function loadZipContent() {
            if(!currentModalFilename) return;
            // Nur laden wenn noch nicht geladen? Nein, immer laden um aktuell zu sein (obwohl Zip sich nicht √§ndert)
            // Cache k√∂nnte man machen, aber wir lassen es simpel.
            
            const listContainer = document.getElementById('zip-file-list');
            try {
                const resp = await fetch('/api/get_zip_content', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({filename: currentModalFilename}) });
                const data = await resp.json();
                
                document.getElementById('file-count-badge').innerText = data.files.length + " Files";
                
                let html = '';
                data.files.forEach(f => {
                    html += `<div class="file-list-item"><span class="file-icon">üìÑ</span> ${f}</div>`;
                });
                listContainer.innerHTML = html;
            } catch(e) {
                listContainer.innerHTML = '<div class="p-4 text-red-500 text-xs">Fehler beim Laden der Dateiliste.</div>';
            }
        }
        
        async function toggleLock() {
            if(!currentModalFilename) return;
            try {
                const resp = await fetch('/api/toggle_lock', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({filename: currentModalFilename}) });
                const data = await resp.json();
                if(data.status === 'success') {
                    // Update Global History locally
                    const entry = globalHistory.find(h => h.filename === currentModalFilename);
                    if(entry) entry.locked = data.locked;
                    
                    updateLockUI(data.locked);
                    updateDashboardDisplays(); // Refresh Table Icons
                    addLog(data.locked ? t("console.backupLocked", "Backup gesperrt (Locked).") : t("console.backupUnlocked", "Backup entsperrt (Unlocked)."), "info");
                }
            } catch(e) { console.error(e); }
        }
        
        function updateLockUI(isLocked) {
            const badge = document.getElementById('lock-badge');
            const btn = document.getElementById('btn-lock');
            
            if(isLocked) {
                badge.classList.remove('hidden');
                btn.innerHTML = 'üîí';
                btn.classList.add('bg-amber-500/20');
                btn.title = "Unlock";
            } else {
                badge.classList.add('hidden');
                btn.innerHTML = 'üîì';
                btn.classList.remove('bg-amber-500/20');
                btn.title = "Lock (Vor L√∂schung sch√ºtzen)";
            }
        }
        
        async function saveComment() {
            const comment = document.getElementById('modal-comment').value;
            if(!currentModalFilename) return;
            try {
                const resp = await fetch('/api/update_comment', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({filename: currentModalFilename, comment}) });
                const data = await resp.json();
                if(data.status === 'success') {
                    const entry = globalHistory.find(h => h.filename === currentModalFilename);
                    if(entry) entry.comment = comment;
                    addLog(t("console.commentSaved", "Kommentar gespeichert."), "success");
                }
            } catch(e) { addLog(t("console.saveError", "Fehler beim Speichern."), "error"); }
        }
        
        async function verifyIntegrity() {
            const resDiv = document.getElementById('integrity-result');
            resDiv.classList.remove('hidden');
            // Reset & Loading Style
            resDiv.className = 'mb-4 p-3 rounded-lg text-center font-bold text-xs tracking-wide border bg-blue-500/10 border-blue-500/20 text-blue-400 animate-pulse';
            resDiv.innerHTML = '‚ö° BERECHNE HASH & VERGLEICHE... BITTE WARTEN...';
            
            try {
                const resp = await fetch('/api/verify_integrity', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({filename: currentModalFilename}) });
                const data = await resp.json();
                
                resDiv.classList.remove('animate-pulse');

                if(data.status === 'success') {
                    resDiv.className = 'mb-4 p-3 rounded-lg text-center font-bold text-xs tracking-wide border bg-emerald-500/10 border-emerald-500/20 text-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.2)]';
                    resDiv.innerHTML = `‚úì ${data.message}`;
                } else if(data.status === 'mismatch') {
                    resDiv.className = 'mb-4 p-3 rounded-lg text-center font-bold text-xs tracking-wide border bg-red-500/10 border-red-500/20 text-red-500 shadow-[0_0_15px_rgba(239,68,68,0.2)]';
                    resDiv.innerHTML = `‚ö†Ô∏è ${data.message}`;
                } else {
                    resDiv.className = 'mb-4 p-3 rounded-lg text-center font-bold text-xs tracking-wide border bg-red-900/10 border-red-500/20 text-red-400';
                    resDiv.innerHTML = `Fehler: ${data.message}`;
                }
            } catch(e) {
                resDiv.className = 'mb-4 p-3 rounded-lg text-center font-bold text-xs tracking-wide border bg-red-900/10 border-red-500/20 text-red-400';
                resDiv.innerHTML = `Systemfehler.`;
            }
        }
        async function pickFolder(id) {
            const resp = await fetch('/api/pick_folder');
            const data = await resp.json();
            if(data.path) {
                document.getElementById(id).value = data.path;
                refreshSourceAnalysis();
            }
        }
        
        async function pickFile(id) {
            const resp = await fetch('/api/pick_file');
            const data = await resp.json();
            if(data.path) {
                document.getElementById(id).value = data.path;
                refreshSourceAnalysis();
            }
        }
        
        async function pickFiles(id) {
            const resp = await fetch('/api/pick_files');
            const data = await resp.json();
            if(data.path) {
                document.getElementById(id).value = data.path;
                refreshSourceAnalysis();
            }
        }

        // onchange handler for direction
        const dirSelect = document.getElementById('config-cloud-direction');
        if(dirSelect) dirSelect.addEventListener('change', updateCloudTresorUI);

        function updateCloudTresorUI() {
            const enabled = document.getElementById('config-cloud-enabled').checked;
            const module = document.getElementById('module-cloud-tresor');
            
            // --- 1. Enable/Disable Inputs ---
            if(module) {
                const inputs = module.querySelectorAll('input:not(#config-cloud-enabled), select, button');
                inputs.forEach(el => {
                    // Skip Save Button to allow saving "disabled" state
                    if(el.getAttribute('onclick') && el.getAttribute('onclick').includes('saveProfile()')) return;

                    el.disabled = !enabled;
                    el.style.opacity = enabled ? "1" : "0.5";
                });
            }

            const provider = document.getElementById('config-cloud-provider').value;
            const direction = document.getElementById('config-cloud-direction').value;
            
            // --- 2. Visibility Logic ---
            const grpHost = document.getElementById('cloud-host-group');
            const grpS3 = document.getElementById('cloud-s3-group');
            const grpAuth = document.getElementById('cloud-auth-group');
            const userWrap = document.getElementById('cloud-user-wrap');
            const lblHost = document.getElementById('lbl-cloud-host');
            const lblUser = document.getElementById('lbl-cloud-user');
            const lblPass = document.getElementById('lbl-cloud-pass');
            const grpLocalPath = document.getElementById('cloud-local-path-group');
            
            grpHost.classList.remove('hidden');
            grpS3.classList.add('hidden');
            grpAuth.classList.remove('hidden');
            userWrap.classList.remove('hidden');
            
            // Direction Logic
            if (direction === 'download') {
                if(grpLocalPath) grpLocalPath.classList.remove('hidden');
            } else {
                if(grpLocalPath) grpLocalPath.classList.add('hidden');
            }
            
            if(provider === 'SFTP') {
                lblHost.innerText = "Server Host";
                lblUser.innerText = "Benutzer";
                lblPass.innerText = "Passwort";
                document.getElementById('config-cloud-port').parentElement.classList.remove('hidden');
            } else if(provider === 'S3 (Amazon)') {
                grpHost.classList.add('hidden');
                grpS3.classList.remove('hidden');
                lblUser.innerText = "Access Key ID";
                lblPass.innerText = "Secret Access Key";
            } else if(provider === 'Dropbox') {
                grpHost.classList.add('hidden');
                grpS3.classList.add('hidden');
                userWrap.classList.add('hidden'); 
                lblPass.innerText = "Access Token";
            } else if(provider === 'WebDAV') {
                lblHost.innerText = "WebDAV URL";
                document.getElementById('config-cloud-port').parentElement.classList.add('hidden');
                lblUser.innerText = "Benutzer";
                lblPass.innerText = "Passwort";
            } else if(provider === 'Local') {
                grpHost.classList.add('hidden');
                grpS3.classList.add('hidden');
                grpAuth.classList.add('hidden');
            }

            // --- 3. Badge Logic ---
            const badge = document.getElementById('cloud-status-badge');
            // Reset Classes
            badge.className = "px-2 py-1 text-[9px] font-black uppercase border";
            
            if(!enabled) {
                badge.innerText = "DEAKTIVIERT";
                badge.classList.add('bg-slate-500/10', 'border-slate-500/20', 'text-slate-500');
            } else {
                // Check completeness
                const host = document.getElementById('config-cloud-host').value;
                const user = document.getElementById('config-cloud-user').value;
                const pass = document.getElementById('config-cloud-password').value;
                const bucket = document.getElementById('config-cloud-bucket').value;
                
                let isComplete = false;
                if(provider === 'SFTP' && host && user && pass) isComplete = true;
                else if(provider === 'S3 (Amazon)' && user && pass && bucket) isComplete = true;
                else if(provider === 'Dropbox' && pass) isComplete = true; 
                else if(provider === 'WebDAV' && host && user && pass) isComplete = true;

                if(isComplete) {
                    badge.innerText = "BEREIT ZUM SYNC";
                    badge.classList.add('bg-emerald-500/10', 'border-emerald-500/20', 'text-emerald-500');
                } else {
                    badge.innerText = "KONFIGURATION ERFORDERLICH";
                    badge.classList.add('bg-yellow-500/10', 'border-yellow-500/20', 'text-yellow-500');
                }
            }
        }

        function updateGithubUI() {
            const enabled = document.getElementById('config-github-enabled').checked;
            const module = document.getElementById('module-github');
            if(module) {
                const inputs = module.querySelectorAll('input:not(#config-github-enabled), button');
                inputs.forEach(el => {
                    // Skip Save Button
                    if(el.getAttribute('onclick') && el.getAttribute('onclick').includes('saveProfile()')) return;

                    el.disabled = !enabled;
                    el.style.opacity = enabled ? "1" : "0.5";
                });
            }
        }

        function updateDbUI() {
            const enabled = document.getElementById('config-db-enabled').checked;
            const module = document.getElementById('module-db');
            if(module) {
                const inputs = module.querySelectorAll('input:not(#config-db-enabled), select, button');
                inputs.forEach(el => {
                    // Skip Save Button
                    if(el.getAttribute('onclick') && el.getAttribute('onclick').includes('saveProfile()')) return;

                    el.disabled = !enabled;
                    el.style.opacity = enabled ? "1" : "0.5";
                });
            }
        }

        async function runCloudBackupNow() {
            // 1. Speichere Config
            addLog(t("console.saveConfigBeforeCloud", "Speichere Konfiguration vor Cloud Backup..."), "info");
            await saveProfile(); 
            await new Promise(r => setTimeout(r, 500)); // Wait a bit
            
            // 2. Lade aktuelle Config um Pfade zu pr√ºfen
            const config = await fetch('/api/get_config').then(resp => resp.json());
            const source = config.default_source;
            const dest = config.default_dest;
            
            if(!source || !dest) {
                addLog(t("console.pathMissingSettings", "Quell- oder Zielpfad fehlt! Bitte in den Einstellungen pr√ºfen."), "error");
                alert(t("dialog.sourceTargetMissing", "Please first define source and target path in settings."));
                return;
            }

            // Get Naming Options
            const custom = document.getElementById('cloud-naming-custom').value;
            const incDate = document.getElementById('cloud-naming-date').checked;
            const incTime = document.getElementById('cloud-naming-time').checked;
            const incSeq = document.getElementById('cloud-naming-seq').checked;
            const zipDownload = document.getElementById('cloud-zip-download') ? document.getElementById('cloud-zip-download').checked : false;
            
            // Get Direction
            const direction = document.getElementById('config-cloud-direction') ? document.getElementById('config-cloud-direction').value : 'upload';

            // Override Dest if Download Mode and Local Path set
            let finalDest = dest;
            if (direction === 'download') {
                const localPathInput = document.getElementById('config-cloud-local-path');
                if (localPathInput && localPathInput.value) {
                    finalDest = localPathInput.value;
                }
            }

            if(!config.cloud_sync_enabled) {
                if(!confirm(t("dialog.cloudSyncDisabled", "Cloud-Sync is disabled. Still start backup (local + attempt)?"))) {
                    return;
                }
            }
            
            addLog(t("console.startManualCloud", "Starte manuelles Cloud Backup..."), "info");
            
            try {
                const resp = await fetch('/api/run_cloud_backup_now', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source: source, 
                        dest: finalDest, 
                        comment: "Manuelles Cloud Backup",
                        naming_custom: custom,
                        naming_date: incDate,
                        naming_time: incTime,
                        naming_seq: incSeq,
                        zip_download: zipDownload,
                        direction: direction
                    })
                });
                
                const res = await resp.json();
                if(res.status === 'started') {
                    addLog(t("console.cloudBackupStarted", "Cloud Backup gestartet."), "success");
                    pollCloudStatus();
                } else {
                    addLog(t("console.startError", "Start Fehler: ") + res.message, "error");
                }
            } catch(e) {
                addLog(t("console.cloudNetworkError", "Netzwerkfehler beim Starten des Cloud Backups."), "error");
            }
        }
        
        async function pollCloudStatus() {
            const statusArea = document.getElementById('status-area-cloud-tresor');
            const statusMsg = document.getElementById('status-msg-cloud-tresor');
            const statusPct = document.getElementById('status-pct-cloud-tresor');
            const statusBar = document.getElementById('status-bar-cloud-tresor');
            const statusErr = document.getElementById('status-err-cloud-tresor');
            
            // Console Elements
            const consoleArea = document.getElementById('console-cloud-tresor');
            const consoleContent = document.getElementById('console-content-cloud-tresor');
            const statusDot = document.getElementById('status-dot-cloud-tresor');
            
            if(statusArea) statusArea.classList.remove('hidden');
            if(statusErr) statusErr.classList.add('hidden');
            
            // Reset & Show Console
            /*
            if(consoleArea) {
                consoleArea.classList.remove('hidden');
                if(consoleContent) consoleContent.innerHTML = '<div class="text-slate-500 italic">Warte auf Logs...</div>';
            }
            */
            if(consoleContent) consoleContent.innerHTML = `<div class="text-slate-500 italic">${t("console.waitingForLogs", "Waiting for logs...")}</div>`;

            const pollInterval = setInterval(async () => {
                try {
                    const resp = await fetch('/api/get_cloud_backup_status');
                    const status = await resp.json();
                    
                    if(statusMsg) {
                        const waitLabel = t("console.statusWaiting", "Waiting...");
                        statusMsg.innerText = status.message || waitLabel;
                    }
                    if(statusPct) statusPct.innerText = status.progress + "%";
                    if(statusBar) statusBar.style.width = status.progress + "%";
                    
                    if(statusDot) {
                        if(status.active) {
                            statusDot.classList.remove('bg-slate-600');
                            statusDot.classList.add('bg-blue-500', 'animate-pulse');
                        } else {
                            statusDot.classList.add('bg-slate-600');
                            statusDot.classList.remove('bg-blue-500', 'animate-pulse');
                        }
                    }

                    // Update Console
                    if(consoleContent && status.logs && Array.isArray(status.logs)) {
                        const logHtml = status.logs.map(line => {
                            let color = "text-slate-400";
                            if(line.includes("[ERROR]")) color = "text-red-400 font-bold";
                            if(line.includes("[WARNING]")) color = "text-yellow-400";
                            if(line.includes("[SUCCESS]")) color = "text-green-400";
                            return `<div class="${color} break-all">${line}</div>`;
                        }).join('');
                        
                        if(consoleContent.innerHTML !== logHtml) {
                            consoleContent.innerHTML = logHtml;
                            consoleArea.scrollTop = consoleArea.scrollHeight;
                        }
                    }
                    
                    if(!status.active) {
                        clearInterval(pollInterval);
                    if(status.result && status.result.status === 'success') {
                             addLog(t("console.cloudSuccess", "Cloud Backup erfolgreich beendet."), "success");
                             if(statusMsg) statusMsg.innerText = "Fertig";
                             
                             // Hide after delay if success
                             /*
                             setTimeout(() => { 
                                 if(statusArea) statusArea.classList.add('hidden'); 
                                 if(consoleArea) consoleArea.classList.add('hidden');
                             }, 5000);
                             */
                        } else {
                             addLog(t("console.cloudFinishedWarn", "Cloud Backup beendet (evtl. Fehler)."), "warning");
                             if(statusErr) {
                                 statusErr.innerText = status.result ? status.result.message : "Unbekannter Fehler";
                                 statusErr.classList.remove('hidden');
                             }
                             // Keep Console Open on Error
                        }
                    }
                } catch(e) {
                    clearInterval(pollInterval);
                }
            }, 1000);
        }

        async function createLocalStorageLocation() {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Erstelle...";
        btn.disabled = true;
        
        const path = document.getElementById('config-cloud-local-path').value;
        if(!path) {
            alert(t("dialog.specifyLocalPath"));
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }
        
        try {
            const resp = await fetch('/api/create_cloud_path', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    provider: 'Local',
                    path: path
                })
            });
            const data = await resp.json();
            
            if(data.status === 'success') {
                addLog(t("console.localFolderCreated", "Lokaler Ordner erstellt!"), "success");
                btn.innerText = "Erfolg ‚úì";
                btn.classList.add('text-green-400', 'border-green-500/30');
            } else {
                addLog(t("console.errorPrefix", "Fehler: ") + data.message, "error");
                btn.innerText = "Fehler ‚úï";
                btn.classList.add('text-red-400', 'border-red-500/30');
            }
        } catch(e) {
            console.error(e);
            btn.innerText = "Error";
        }
        
        setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('text-green-400', 'border-green-500/30', 'text-red-400', 'border-red-500/30');
        }, 3000);
    }

    async function createStorageLocation() {
            const btn = event.target;
            
            // User-Input abfragen
            let currentPath = document.getElementById('config-cloud-path').value;
            const newPath = prompt(t("dialog.createFolderPrompt"), currentPath);
            
            if (newPath === null) return; // Abbrechen
            if (!newPath) {
                 alert(t("dialog.specifyPath"));
                 return;
            }

            const originalText = btn.innerText;
            btn.innerText = "Erstelle...";
            btn.disabled = true;

            // 1. Parameter sammeln
            const provider = document.getElementById('config-cloud-provider').value;
            const host = document.getElementById('config-cloud-host').value;
            const user = document.getElementById('config-cloud-user').value;
            const pass = document.getElementById('config-cloud-password').value;
            // Wir nutzen den Pfad aus dem Prompt
            const path = newPath; 
            const port = document.getElementById('config-cloud-port').value;
            const bucket = document.getElementById('config-cloud-bucket').value;

            try {
                const resp = await fetch('/api/create_cloud_path', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider, host, user, password: pass, path, port, bucket
                    })
                });
                const data = await resp.json();
                
                if(data.status === 'success') {
                    addLog(t("console.remoteLocationCreated", "Speicherort erfolgreich angelegt!"), "success");
                    btn.innerText = "Erfolg ‚úì";
                    btn.classList.add('text-green-400', 'border-green-500/30');
                } else {
                    addLog(t("console.createError", "Fehler beim Anlegen: ") + data.message, "error");
                    btn.innerText = "Fehler ‚úï";
                    btn.classList.add('text-red-400', 'border-red-500/30');
                }
            } catch(e) {
                console.error(e);
                addLog(t("console.createNetworkError", "Netzwerkfehler beim Anlegen."), "error");
                btn.innerText = "Netzwerk Error";
            }

            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('text-green-400', 'border-green-500/30', 'text-red-400', 'border-red-500/30');
            }, 3000);
        }

        async function testCloudConnection() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Verbinde...";
            btn.disabled = true;
            
            const provider = document.getElementById('config-cloud-provider').value;
            const host = document.getElementById('config-cloud-host').value;
            const user = document.getElementById('config-cloud-user').value;
            const pass = document.getElementById('config-cloud-password').value;
            const bucket = document.getElementById('config-cloud-bucket').value;
            const port = document.getElementById('config-cloud-port').value;
            const region = document.getElementById('config-cloud-region').value;
            const path = document.getElementById('config-cloud-path').value;
            
            // Helper to log to Cloud Terminal
            const addCloudLog = (msg, type="info") => {
                const consoleContent = document.getElementById('console-content-cloud-tresor');
                if(!consoleContent) return;
                let color = "text-slate-400";
                if(type === "error") color = "text-red-400 font-bold";
                if(type === "success") color = "text-green-400";
                const line = `<div class="${color} break-all">[TEST] ${msg}</div>`;
                consoleContent.innerHTML += line;
                const consoleArea = document.getElementById('console-cloud-tresor');
                if(consoleArea) consoleArea.scrollTop = consoleArea.scrollHeight;
            };

            try {
                addCloudLog(`Starte Verbindungstest zu ${host}...`);
                const resp = await fetch('/api/test_cloud_connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        host: host,
                        user: user,
                        password: pass,
                        bucket: bucket,
                        port: port,
                        region: region,
                        path: path
                    })
                });
                const res = await resp.json();
                
                if(res.status === 'success') {
                    btn.innerText = "Verbindung OK ‚úì";
                    btn.classList.add('text-green-400', 'border-green-500/30', 'bg-green-500/10');
                    addLog(`Cloud Verbindung (${provider}) erfolgreich.`, "success");
                    addCloudLog(`Verbindung erfolgreich!`, "success");
                } else {
                    btn.innerText = "Fehler ‚úï";
                    btn.classList.add('text-red-400', 'border-red-500/30', 'bg-red-500/10');
                    addLog(`Cloud Verbindung fehlgeschlagen: ${res.message}`, "error");
                    addCloudLog(`Fehler: ${res.message}`, "error");
                }
            } catch(e) {
                btn.innerText = "Netzwerkfehler";
                btn.classList.add('text-red-400', 'border-red-500/30', 'bg-red-500/10');
                addLog("Netzwerkfehler beim Cloud-Test.", "error");
                addCloudLog(`Netzwerkfehler: ${e.message}`, "error");
            }
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('text-green-400', 'border-green-500/30', 'bg-green-500/10', 'text-red-400', 'border-red-500/30', 'bg-red-500/10');
            }, 3000);
        }

        async function testNotification(type) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;
            
            const payload = {
                discord_webhook_url: document.getElementById('config-discord-url').value,
                telegram_token: document.getElementById('config-telegram-token').value,
                telegram_chat_id: document.getElementById('config-telegram-chatid').value
            };
            
            try {
                const resp = await fetch('/api/test_notification', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await resp.json();
                
                if(res.status === 'success') {
                    btn.innerText = "OK ‚úì";
                    btn.classList.add('text-green-400');
                    addLog("Test-Benachrichtigung gesendet.", "success");
                } else {
                    btn.innerText = "Err";
                    btn.classList.add('text-red-400');
                    addLog("Fehler: " + res.message, "error");
                }
            } catch(e) {
                btn.innerText = "Err";
                addLog("Netzwerkfehler.", "error");
            }
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('text-green-400', 'text-red-400');
                btn.disabled = false;
            }, 2000);
        }

        async function saveProfile() {
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
            const getCheck = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
            const getInt = (id, def) => { const val = parseInt(getVal(id)); return isNaN(val) ? def : val; };

            const conf = { 
                default_source: getVal('config-source'), 
                default_dest: getVal('config-dest'), 
                retention_count: getInt('config-retention', 10),
                auto_interval: getInt('config-auto-interval', 0),
                auto_backup_enabled: autoBackupEnabled,
                // Cloud Settings
                cloud_sync_enabled: getCheck('config-cloud-enabled'),
                cloud_provider: getVal('config-cloud-provider'),
                cloud_direction: getVal('config-cloud-direction') || "upload",
                cloud_host: getVal('config-cloud-host'),
                cloud_port: getVal('config-cloud-port'),
                cloud_bucket: getVal('config-cloud-bucket'),
                cloud_region: getVal('config-cloud-region'),
                cloud_target_path: getVal('config-cloud-path'),
                cloud_local_path: getVal('config-cloud-local-path'),
                cloud_zip_download: getCheck('cloud-zip-download'),
                cloud_user: getVal('config-cloud-user'),
                cloud_password: getVal('config-cloud-password'),
                cloud_api_key: getVal('config-cloud-api-key'),
                // GitHub Settings
                github_backup_enabled: getCheck('config-github-enabled'),
                github_url: getVal('config-github-url'),
                github_path: getVal('config-github-path'),
                github_token: getVal('config-github-token'),
                // Database Settings (New)
                db_backup_enabled: getCheck('config-db-enabled'),
                db_type: getVal('config-db-type') || 'mysql',
                db_host: getVal('config-db-host'),
                db_port: getVal('config-db-port'),
                db_user: getVal('config-db-user'),
                db_password: getVal('config-db-password'),
                db_names: getVal('config-db-names'),
                // Naming Settings
                naming_custom_text: getVal('config-naming-custom'),
                naming_include_date: getCheck('config-naming-date'),
                naming_include_time: getCheck('config-naming-time'),
                naming_include_seq: getCheck('config-naming-seq'),
                naming_seq_counter: getInt('config-naming-seq-val', 1),
                // Advanced
                compression_level: getInt('config-compression', 3),
                exclusions: getVal('config-exclusions'),
                // Notifications
                notify_on_success: getCheck('config-notify-success'),
                notify_on_error: getCheck('config-notify-error'),
                discord_webhook_url: getVal('config-discord-url'),
                telegram_token: getVal('config-telegram-token'),
                telegram_chat_id: getVal('config-telegram-chatid'),
                // Encryption
                encryption_enabled: getCheck('config-enc-enabled'),
                encryption_password: getVal('config-enc-password')
            };
            try {
                const mainSaveBtn = document.querySelector('button[data-i18n="settings.saveParametersButton"]');
                let originalText = null;
                let originalColor = null;
                if (mainSaveBtn) {
                    originalText = mainSaveBtn.innerText;
                    originalColor = mainSaveBtn.style.color;
                    const savingText = typeof t === "function" ? t("settings.saveParametersSaving", "Saving...") : "Saving...";
                    mainSaveBtn.innerText = savingText;
                }
                const resp = await fetch('/api/save_config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(conf) });
                const res = await resp.json();
                if (res.status === 'success') {
                    addLog(t("console.kernelParamsSaved", "Kernel: Parameter persistent gespeichert."), "success", "console.kernelParamsSaved");
                    
                    if (mainSaveBtn) {
                        const okText = typeof t === "function" ? t("settings.saveParametersSuccess", "Saved successfully ‚úì") : "Saved successfully ‚úì";
                        mainSaveBtn.innerText = okText;
                        mainSaveBtn.style.color = "#4ade80";
                        setTimeout(() => {
                            mainSaveBtn.innerText = originalText || mainSaveBtn.innerText;
                            mainSaveBtn.style.color = originalColor || "";
                        }, 2000);
                    }

                    // Trigger re-load to update history potentially based on new path
                    await loadData();
                    updateNamingPreview(); // Ensure preview is correct after load
                    
                    if (typeof initBackupPlan === "function") {
                        initBackupPlan();
                    }
                } else {
                    addLog(t("console.saveErrorUnknown", "Fehler beim Speichern: ") + (res.message || "Unbekannt"), "error", "console.saveErrorUnknown");
                    if (mainSaveBtn) {
                        const errText = typeof t === "function" ? t("settings.saveParametersError", "Error while saving") : "Error while saving";
                        mainSaveBtn.innerText = errText;
                        mainSaveBtn.style.color = "#f87171";
                        setTimeout(() => {
                            mainSaveBtn.innerText = originalText || mainSaveBtn.innerText;
                            mainSaveBtn.style.color = originalColor || "";
                        }, 2000);
                    }
                }
            } catch (e) {
                console.error(e);
                addLog(t("console.saveCommError", "Kommunikationsfehler beim Speichern."), "error", "console.saveCommError");
                const mainSaveBtn = document.querySelector('button[data-i18n="settings.saveParametersButton"]');
                if (mainSaveBtn) {
                    const errText = typeof t === "function" ? t("settings.saveParametersError", "Error while saving") : "Error while saving";
                    mainSaveBtn.innerText = errText;
                    mainSaveBtn.style.color = "#f87171";
                    setTimeout(() => {
                        mainSaveBtn.innerText = "Save parameters persistently";
                        mainSaveBtn.style.color = "";
                    }, 2000);
                }
            }
        }

        async function testGithubConnection(btn) {
            // Guard: Prevent execution if disabled (already handled by UI, but good for safety)
            if(btn.disabled) return;
            
            const originalText = btn.innerText;
            btn.innerText = "Pr√ºfe...";
            btn.disabled = true;
            
            const url = document.getElementById('config-github-url').value;
            const token = document.getElementById('config-github-token').value;
            
            try {
                const resp = await fetch('/api/test_github_connection', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ url, token }) 
                });
                const res = await resp.json();
                
                if(res.status === 'success') {
                    btn.innerText = "OK ‚úì";
                    btn.classList.add('text-green-400', 'border-green-500/30', 'bg-green-500/10');
                    // Explicit "Manual" prefix to avoid confusion with automated processes
                    addLog("Manueller GitHub Test: Verbindung erfolgreich.", "success");
                } else {
                    btn.innerText = "Fehler";
                    btn.classList.add('text-red-400', 'border-red-500/30', 'bg-red-500/10');
                    addLog("Manueller GitHub Test fehlgeschlagen: " + res.message, "error");
                }
            } catch(e) {
                btn.innerText = "Error";
                addLog("Netzwerkfehler beim GitHub Test.", "error");
            }
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('text-green-400', 'border-green-500/30', 'bg-green-500/10', 'text-red-400', 'border-red-500/30', 'bg-red-500/10');
            }, 3000);
        }

        async function runGithubBackupNow(btn) {
            const originalText = btn.innerText;
            btn.innerText = "Starte...";
            btn.disabled = true;
            
            // Erst speichern wir die aktuelle Config, damit das Backend die neuesten Werte hat
            await saveProfile();
            
            try {
                const resp = await fetch('/api/run_github_backup_now', { method: 'POST' });
                const res = await resp.json();
                if(res.status === 'started') {
                    addLog("GitHub Backup Job gestartet.", "success");
                } else {
                    addLog("Fehler: " + res.message, "error");
                }
            } catch(e) {
                addLog("Fehler beim Starten des GitHub Backups.", "error");
            }
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 3000);
        }

        async function stopScan() {
            const btn = document.getElementById('btn-cancel-scan');
            if(btn) btn.innerText = "Beende...";
            try { await fetch('/api/stop_scan', { method: 'POST' }); } catch(e) {}
        }

        async function scanDuplicates() {
            const btnStart = document.getElementById('btn-start-scan');
            const btnCancel = document.getElementById('btn-cancel-scan');

            // Priority: 1. Specific Scan Path, 2. Config Source Path
            const scanPath = document.getElementById('scan-path')?.value;
            const configSource = document.getElementById('config-source')?.value;
            const source = scanPath || configSource || document.getElementById('source')?.value;
            if(!source) {
                alert(t("dialog.selectSourcePathFirst", "Please select a source path first."));
                return;
            }

            // Toggle UI
            if(btnStart) btnStart.classList.add('hidden');
            if(btnCancel) {
                btnCancel.classList.remove('hidden');
                btnCancel.innerText = "Abbruch";
            }
            
            // Get Filters
            const minSize = document.getElementById('scan-min-size').value;
            const extType = document.getElementById('scan-extensions').value;
            let extensions = [];
            
            const extMap = {
                'images': ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.raw', '.nef', '.cr2', '.webp', '.svg'],
                'videos': ['.mp4', '.mkv', '.mov', '.avi', '.wmv', '.flv', '.webm', '.m4v'],
                'docs': ['.pdf', '.doc', '.docx', '.txt', '.rtf', '.odt', '.xls', '.xlsx', '.ppt', '.pptx'],
                'archives': ['.zip', '.rar', '.7z', '.tar', '.gz', '.iso']
            };
            
            if(extMap[extType]) extensions = extMap[extType];
            
            const container = document.getElementById('duplicate-results');
            if(container) container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64">
                    <div class="relative w-16 h-16 mb-6">
                        <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
                    </div>
                    <div class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-4">Deep-Scan l√§uft...</div>
                    <div class="w-64 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                        <div id="scan-progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                    </div>
                    <div id="scan-progress-text" class="text-[10px] text-slate-500 mt-3 font-mono">Initialisiere...</div>
                </div>
            `;
            
            const pollInterval = setInterval(async () => {
                try {
                    const r = await fetch('/api/scan_progress');
                    const s = await r.json();
                    const bar = document.getElementById('scan-progress-bar');
                    const txt = document.getElementById('scan-progress-text');
                    if(bar && txt && s.total > 0) {
                        const pct = Math.round((s.current / s.total) * 100);
                        bar.style.width = pct + "%";
                        txt.innerText = `${s.current} / ${s.total} (${pct}%)`;
                    }
                } catch(e) {}
            }, 500);

            try {
                const resp = await fetch('/api/find_duplicates', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({
                        path: source,
                        min_size: minSize,
                        extensions: extensions
                    }) 
                });
                const data = await resp.json();
                clearInterval(pollInterval);

                // Restore UI
                if(btnStart) btnStart.classList.remove('hidden');
                if(btnCancel) btnCancel.classList.add('hidden');
                
                if(!container) return;

                if(data.status === 'aborted') {
                    container.innerHTML = '<div class="text-center py-20 opacity-50 italic text-sm text-red-400 border border-red-500/20 bg-red-500/5 rounded">Scan wurde manuell abgebrochen.</div>';
                    return;
                }

                if(data.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 opacity-50 italic text-sm text-green-400">Keine Duplikate gefunden. Perfekte Effizienz!</div>';
                    return;
                }
                
                let totalWasted = 0;
                data.forEach(g => totalWasted += g.size * (g.files.length - 1));
                
                // Header with Auto-Select Actions
                let html = `
                <div class="bg-amber-500/10 border border-amber-500/20 p-4 rounded mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-amber-400 text-xs font-bold uppercase tracking-widest">Analyse Ergebnis</div>
                            <div class="text-white text-lg font-black mt-1">${formatSize(totalWasted)} <span class="text-xs text-slate-500 font-normal">verschwendet durch ${data.length} redundante Gruppen</span></div>
                        </div>
                        <button onclick="deleteSelectedDuplicates()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded transition-all">
                            Markierte L√∂schen
                        </button>
                    </div>
                    
                    <div class="flex gap-2 border-t border-white/5 pt-3">
                        <span class="text-[10px] uppercase font-black text-slate-500 self-center mr-2">Auto-Select:</span>
                        <button onclick="autoSelectDuplicates('keep-newest')" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 text-[10px] px-3 py-1 rounded transition-all">
                            Behalte Neueste (L√∂sche Alte)
                        </button>
                        <button onclick="autoSelectDuplicates('keep-oldest')" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 text-[10px] px-3 py-1 rounded transition-all">
                            Behalte √Ñlteste (L√∂sche Neue)
                        </button>
                    </div>
                </div>`;
                
                data.forEach((group, idx) => {
                    html += `<div class="bg-black/40 border border-white/5 rounded-lg p-4 mb-4 group-item" data-group-id="${idx}">
                        <div class="flex justify-between mb-2">
                            <div class="text-[10px] font-black uppercase text-slate-500">Gruppe #${idx+1} ‚Ä¢ ${formatSize(group.size)} pro Datei</div>
                            <div class="text-[9px] text-slate-600 font-mono">HASH MATCH</div> 
                        </div>
                        <div class="space-y-1">`;
                        
                    // Backend returns files sorted by mtime DESC (Newest first)
                    group.files.forEach((fObj, fIdx) => {
                        const f = fObj.path;
                        const mtimeDate = new Date(fObj.mtime * 1000).toLocaleString();
                        const isNewest = fIdx === 0; 
                        const isOldest = fIdx === group.files.length - 1;
                        
                        const id = 'dup-' + Math.random().toString(36).substr(2, 9);
                        const safePath = f.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, "\\\\'");
                        const safeVal = f.replace(/"/g, '&quot;');
                        
                        let badge = "";
                        if(isNewest) badge += '<span class="text-[9px] bg-emerald-500/20 text-emerald-400 px-1 rounded ml-2">NEU</span>';
                        if(isOldest) badge += '<span class="text-[9px] bg-slate-500/20 text-slate-400 px-1 rounded ml-2">ALT</span>';

                        html += `<div class="flex items-center gap-3 bg-[#0a0b10] p-2 rounded border border-white/5 hover:border-white/10 transition-colors duplicate-row" data-mtime="${fObj.mtime}">
                            <input type="checkbox" id="${id}" value="${safeVal}" class="dup-check w-4 h-4 bg-slate-800 border-slate-600 rounded cursor-pointer">
                            <div class="flex-1 min-w-0">
                                <label for="${id}" class="text-[10px] mono text-slate-300 truncate block cursor-pointer select-none" title="${safeVal}">${f}</label>
                                <div class="text-[9px] text-slate-600 flex items-center">${mtimeDate} ${badge}</div>
                            </div>
                            <button onclick="deleteFile('${safePath}')" class="text-[9px] font-black uppercase text-slate-600 hover:text-red-500 transition-colors" title="Einzeln l√∂schen">üóëÔ∏è</button>
                        </div>`;
                    });
                    
                    html += `</div></div>`;
                });
                
                container.innerHTML = html;
                
            } catch(e) {
                clearInterval(pollInterval);
                console.error(e);
                // Restore UI on error
                const btnStart = document.getElementById('btn-start-scan');
                const btnCancel = document.getElementById('btn-cancel-scan');
                if(btnStart) btnStart.classList.remove('hidden');
                if(btnCancel) btnCancel.classList.add('hidden');

                if(container) container.innerHTML = '<div class="text-center py-10 text-red-500">Fehler bei der Analyse.</div>';
            }
        }
        
        function autoSelectDuplicates(mode) {
             const groups = document.querySelectorAll('.group-item');
             groups.forEach(g => {
                 const rows = Array.from(g.querySelectorAll('.duplicate-row'));
                 if(rows.length < 2) return;
                 
                 // Reset checks
                 rows.forEach(r => {
                     const cb = r.querySelector('.dup-check');
                     if(cb) cb.checked = false; 
                 });
                 
                 if(mode === 'keep-newest') {
                     // Check all EXCEPT the first (newest)
                     for(let i = 1; i < rows.length; i++) {
                         const cb = rows[i].querySelector('.dup-check');
                         if(cb) cb.checked = true;
                     }
                 } else if(mode === 'keep-oldest') {
                     // Check all EXCEPT the last (oldest)
                     for(let i = 0; i < rows.length - 1; i++) {
                          const cb = rows[i].querySelector('.dup-check');
                          if(cb) cb.checked = true;
                     }
                 }
             });
        }
        
        async function deleteFile(path) {
            if(!confirm(t("dialog.deleteFileConfirm", "Permanently delete file?") + "\\n" + path)) return;
            try {
                const resp = await fetch('/api/delete_file', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({path}) 
                });
                const res = await resp.json();
                if(res.status === 'success') {
                    scanDuplicates(); 
                } else {
                    alert(t("dialog.deleteError", "Error: ") + res.message);
                }
            } catch(e) { alert(t("dialog.deleteFailed", "Deletion failed.")); }
        }
        
        async function deleteSelectedDuplicates() {
            const checked = document.querySelectorAll('.dup-check:checked');
            if(checked.length === 0) return alert(t("dialog.noFilesSelected", "No files selected."));
            
            if(!confirm(`${checked.length} Dateien unwiderruflich l√∂schen?`)) return;
            
            let successCount = 0;
            for(let box of checked) {
                const path = box.value;
                try {
                     const resp = await fetch('/api/delete_file', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({path}) 
                    });
                    if((await resp.json()).status === 'success') successCount++;
                } catch(e) {}
            }
            
            alert(t("dialog.filesDeleted", "{successCount} of {totalCount} files deleted.")
                .replace("{successCount}", successCount)
                .replace("{totalCount}", checked.length));
            scanDuplicates();
        }

        function copyHash() {
            const hash = document.getElementById('modal-hash').innerText;
            const el = document.createElement('textarea');
            el.value = hash; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            addLog(t("console.hashCopied", "System: Hash copied to clipboard."), "info");
        }

        function togglePassword(id, btn) {
            const input = document.getElementById(id);
            if(input.type === "password") {
                input.type = "text";
                btn.style.color = "#4ade80";
            } else {
                input.type = "password";
                btn.style.color = "";
            }
        }

        // --- Tasks Logic ---
        let tasks = [];
        let currentTaskId = null;

        async function loadTasks() {
            try {
                const resp = await fetch('/api/get_config');
                const config = await resp.json();
                tasks = config.tasks || [];
                renderTaskList();
            } catch(e) {
                console.error("Fehler beim Laden der Tasks:", e);
            }
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            if(!container) return;
            container.innerHTML = '';
            
            if(tasks.length === 0) {
                container.innerHTML = '<div class="text-center py-10 opacity-30 italic text-[10px]" data-i18n="tasks.emptyPlaceholder">Keine Tasks vorhanden.</div>';
                if (window.BP_I18N_DICT) {
                    try { applyTranslations(window.BP_I18N_DICT); } catch(e) {}
                }
                return;
            }
            
            tasks.forEach(task => {
                const activeClass = task.id === currentTaskId ? 'bg-blue-600/20 border-blue-600/30' : 'bg-white/5 border-white/5 hover:bg-white/10';
                const statusDot = task.active 
                    ? '<div class="w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981] border border-emerald-400" title="Status: Aktiv" data-i18n-title="tasks.statusActiveTitle"></div>' 
                    : '<div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444] border border-red-400 opacity-80" title="Status: Deaktiviert" data-i18n-title="tasks.statusInactiveTitle"></div>';
                
                const html = `
                <div onclick="selectTask('${task.id}')" class="${activeClass} border rounded p-3 cursor-pointer transition-all group relative">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-bold text-xs truncate pr-2 text-slate-200">${task.name}</div>
                        <div class="text-[10px]">${statusDot}</div>
                    </div>
                    <div class="text-[9px] font-mono text-slate-500 truncate" title="${task.source}">${task.source || '<span data-i18n="tasks.noSourceLabel">Keine Quelle</span>'}</div>
                    <div class="text-[9px] font-mono text-slate-500 truncate" title="${task.dest}">‚ûú ${task.dest || '<span data-i18n="tasks.noTargetLabel">Kein Ziel</span>'}</div>
                    <div class="mt-2 flex justify-between items-end">
                        <div class="text-[9px] text-slate-500">${task.interval > 0 ? task.interval + ' min' : '<span data-i18n="tasks.manualIntervalLabel">Manuell</span>'}</div>
                        <div class="text-[9px] text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity" data-i18n="tasks.editLabel">Bearbeiten</div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            
            if (window.BP_I18N_DICT) {
                try { applyTranslations(window.BP_I18N_DICT); } catch(e) {}
            }
        }

        function selectTask(id) {
            currentTaskId = id;
            const task = tasks.find(t => t.id === id);
            if(!task) return;
            
            renderTaskList(); // Update active state
            
            document.getElementById('task-editor-empty').classList.add('hidden');
            const editor = document.getElementById('task-editor');
            editor.classList.remove('hidden');
            
            const lastRunText = task.last_run ? new Date(task.last_run * 1000).toLocaleString() : '';
            const lastRunPlaceholder = task.last_run ? '' : 'Nie';

            editor.innerHTML = `
                <div class="flex justify-between items-center border-b border-white/5 pb-4">
                    <h3 class="font-bold text-lg text-white" data-i18n="tasks.editorTitle">Task bearbeiten</h3>
                    <div class="flex gap-2">
                        <button onclick="runTaskNow()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded transition-all" data-i18n="tasks.runNowButton">
                            ‚ñ∂ Jetzt Starten
                        </button>
                        <button onclick="deleteCurrentTask()" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 text-xs font-bold px-3 py-1.5 rounded transition-all" data-i18n="tasks.deleteButton">
                            L√∂schen
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.nameLabel">Task Name</label>
                        <input type="text" id="task-name" value="${task.name}" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none transition-colors">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.activeLabel">Aktiv</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="task-active" ${task.active ? 'checked' : ''} class="w-4 h-4 bg-slate-800 border-slate-600 rounded">
                            <label for="task-active" class="text-sm text-slate-300 select-none" data-i18n="tasks.autoBackupHelp">Automatisches Backup aktivieren</label>
                        </div>
                    </div>

                    <div class="col-span-2 space-y-1">
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.namingSuffixLabel">Namensgebung (Suffix)</label>
                        <div class="flex gap-4 p-2 bg-black/20 rounded border border-white/5">
                             <label class="flex items-center gap-2 text-xs text-slate-300 cursor-pointer select-none">
                                 <input type="checkbox" id="task-inc-date" ${(task.naming_include_date !== false) ? 'checked' : ''} class="w-3 h-3 bg-slate-800 border-slate-600 rounded"> <span data-i18n="settings.namingDateLabel">Datum</span>
                             </label>
                             <label class="flex items-center gap-2 text-xs text-slate-300 cursor-pointer select-none">
                                 <input type="checkbox" id="task-inc-time" ${(task.naming_include_time !== false) ? 'checked' : ''} class="w-3 h-3 bg-slate-800 border-slate-600 rounded"> <span data-i18n="settings.namingTimeLabel">Zeit</span>
                             </label>
                             <label class="flex items-center gap-2 text-xs text-slate-300 cursor-pointer select-none">
                                 <input type="checkbox" id="task-inc-seq" ${task.naming_include_seq ? 'checked' : ''} class="w-3 h-3 bg-slate-800 border-slate-600 rounded"> <span data-i18n="settings.namingSeqLabel">Seq. Nr.</span>
                             </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.intervalLabel">Intervall (Minuten)</label>
                        <input type="number" id="task-interval" value="${task.interval}" min="0" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none transition-colors">
                        <div class="text-[9px] text-slate-600 mt-1" data-i18n="tasks.intervalManualHint">0 = Nur Manuell</div>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.lastRunLabel">Letzte Ausf√ºhrung</label>
                        <input type="text" disabled value="${lastRunText}" placeholder="${lastRunPlaceholder}" class="w-full bg-black/10 border border-white/5 rounded px-3 py-2 text-sm text-slate-500 cursor-not-allowed" data-i18n-placeholder="tasks.lastRunNeverLabel">
                    </div>

                    <div class="col-span-2 relative group">
                         <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.sourcePathLabel">Quell-Ordner / Datei</label>
                         <div class="flex gap-2">
                             <input type="text" id="task-source" value="${task.source}" class="flex-1 bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:border-blue-500 focus:outline-none font-mono">
                             <button onclick="selectTaskFile()" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 px-2 rounded" title="Datei" data-i18n-title="tasks.singleFileTitle">üìÑ</button>
                             <button onclick="selectTaskFiles()" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 px-2 rounded" title="Mehrere Dateien" data-i18n-title="tasks.multiFileTitle">üìë</button>
                             <button onclick="selectTaskSource()" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 px-2 rounded" title="Ordner" data-i18n-title="tasks.folderTitle">üìÅ</button>
                         </div>
                         <p class="text-[9px] text-slate-600 mt-1" data-i18n="tasks.tipPaths">F√ºr mehrere Dateien Pfade mit | trennen.</p>
                     </div>

                     <div class="col-span-2 relative group">
                        <label class="block text-[10px] uppercase font-black text-slate-500 mb-1" data-i18n="tasks.targetPathLabel">Ziel-Ordner (Backup)</label>
                        <div class="flex gap-2">
                            <input type="text" id="task-dest" value="${task.dest}" class="flex-1 bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:border-blue-500 focus:outline-none font-mono">
                            <button onclick="selectTaskDest()" class="bg-white/5 hover:bg-white/10 text-slate-300 border border-white/10 px-3 rounded" title="Ordner w√§hlen" data-i18n-title="duplicates.chooseFolderTitle">üìÇ</button>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5 flex justify-end">
                    <button id="btn-save-task" onclick="saveCurrentTask()" class="bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 border border-emerald-500/30 text-xs font-bold uppercase tracking-widest px-6 py-2 rounded transition-all" data-i18n="tasks.saveButton">
                        Speichern
                    </button>
                </div>
            `;

            if (window.BP_I18N_DICT) {
                applyTranslations(window.BP_I18N_DICT);
            }
        }

        function createNewTask() {
            const newId = 'task_' + Date.now();
            let defaultName = 'Neuer Task';
            try {
                if (window.BP_I18N_DICT && window.BP_I18N_DICT["tasks.defaultName"]) {
                    defaultName = window.BP_I18N_DICT["tasks.defaultName"];
                } else if (typeof t === "function") {
                    defaultName = t("tasks.defaultName", defaultName);
                }
            } catch(e) {}
            const newTask = {
                id: newId,
                name: defaultName,
                source: '',
                dest: '',
                active: false,
                interval: 0,
                last_run: 0,
                naming_include_date: true,
                naming_include_time: true,
                naming_include_seq: false
            };
            tasks.push(newTask);
            selectTask(newId);
        }

        async function saveCurrentTask() {
            if(!currentTaskId) return;
            const task = tasks.find(t => t.id === currentTaskId);
            if(!task) return;
            
            // Visual Feedback: Start
            const btn = document.getElementById('btn-save-task');
            if(btn) {
                btn.innerText = t("tasks.savingText", "Speichert...");
                btn.disabled = true;
            }

            // Update values from DOM
            task.name = document.getElementById('task-name').value;
            task.active = document.getElementById('task-active').checked;
            task.interval = parseInt(document.getElementById('task-interval').value) || 0;
            task.source = document.getElementById('task-source').value;
            task.dest = document.getElementById('task-dest').value;
            
            // Save Naming Options
            task.naming_include_date = document.getElementById('task-inc-date').checked;
            task.naming_include_time = document.getElementById('task-inc-time').checked;
            task.naming_include_seq = document.getElementById('task-inc-seq').checked;
            
            try {
                const resp = await fetch('/api/get_config');
                const config = await resp.json();
                config.tasks = tasks;
                
                const saveResp = await fetch('/api/save_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const res = await saveResp.json();
                if(res.status === 'success') {
                    addLog(t("tasks.saveSuccessLog", "Task gespeichert."), "success");
                    renderTaskList();
                    initBackupPlan();
                    
                    // Visual Feedback: Success
                    if(btn) {
                        btn.innerText = t("tasks.saveSuccessText", "Gespeichert!");
                        btn.classList.remove('bg-emerald-500/20', 'text-emerald-400');
                        btn.classList.add('bg-emerald-500', 'text-white');
                        
                        setTimeout(() => {
                            btn.innerText = t("tasks.saveButton", "Speichern");
                            btn.classList.add('bg-emerald-500/20', 'text-emerald-400');
                            btn.classList.remove('bg-emerald-500', 'text-white');
                            btn.disabled = false;
                        }, 2000);
                    }
                } else {
                    addLog(t("tasks.saveErrorLog", "Fehler beim Speichern."), "error");
                    // Visual Feedback: Error
                    if(btn) {
                         btn.innerText = t("tasks.saveErrorText", "Fehler!");
                         btn.classList.add('bg-red-500', 'text-white');
                         setTimeout(() => {
                             btn.innerText = t("tasks.saveButton", "Speichern");
                             btn.classList.remove('bg-red-500', 'text-white');
                             btn.disabled = false;
                         }, 2000);
                    }
                }
            } catch(e) {
                addLog(t("tasks.saveErrorLog", "Fehler beim Speichern."), "error");
                // Visual Feedback: Error
                if(btn) {
                     btn.innerText = t("tasks.saveErrorText", "Fehler!");
                     btn.classList.add('bg-red-500', 'text-white');
                     setTimeout(() => {
                         btn.innerText = t("tasks.saveButton", "Speichern");
                         btn.classList.remove('bg-red-500', 'text-white');
                         btn.disabled = false;
                     }, 2000);
                }
            }
        }

        async function deleteCurrentTask() {
            if(!currentTaskId) return;
            if(!confirm(t("dialog.taskDeleteConfirm", "Really delete task?"))) return;
            
            tasks = tasks.filter(t => t.id !== currentTaskId);
            currentTaskId = null;
            
            document.getElementById('task-editor').classList.add('hidden');
            document.getElementById('task-editor-empty').classList.remove('hidden');
            
            // Persist deletion
            try {
                const resp = await fetch('/api/get_config');
                const config = await resp.json();
                config.tasks = tasks;
                
                await fetch('/api/save_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                renderTaskList();
                initBackupPlan();
                addLog(t("console.taskDeleted", "Task deleted."), "success");
            } catch(e) {
                addLog(t("console.deleteError", "Error while deleting."), "error");
            }
        }

        async function runTaskNow() {
            if(!currentTaskId) return;
            const task = tasks.find(t => t.id === currentTaskId);
            if(!task) return;
            
            if(!task.source || !task.dest) {
                alert("Bitte Source und Target angeben.");
                return;
            }

            // Update Last Run & Save
            task.last_run = Math.floor(Date.now() / 1000);
            await saveCurrentTask();

            addLog(`Starte Task: ${task.name}...`, "info");
            
            // Prepare Task Options
            const taskOpts = {
                naming_include_date: (task.naming_include_date !== undefined) ? task.naming_include_date : true,
                naming_include_time: (task.naming_include_time !== undefined) ? task.naming_include_time : true,
                naming_include_seq: (task.naming_include_seq !== undefined) ? task.naming_include_seq : false
            };

            try {
                const resp = await fetch('/api/start_backup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source: task.source,
                        dest: task.dest,
                        comment: `Manual Task: ${task.name}`,
                        task_options: taskOpts
                    })
                });
                const res = await resp.json();
                if(res.status === 'started') {
                    switchTab('dashboard');
                } else {
                    addLog("Konnte Task nicht starten: " + res.message, "error");
                }
            } catch(e) {
                addLog("Fehler beim Starten.", "error");
            }
        }

        async function selectTaskFile() {
            const resp = await fetch('/api/pick_file');
            const data = await resp.json();
            if(data.path) document.getElementById('task-source').value = data.path;
        }

        async function selectTaskFiles() {
            const resp = await fetch('/api/pick_files');
            const data = await resp.json();
            if(data.path) document.getElementById('task-source').value = data.path;
        }

        async function selectTaskSource() {
            const resp = await fetch('/api/pick_folder');
            const data = await resp.json();
            if(data.path) {
                document.getElementById('task-source').value = data.path;
            }
        }

        async function selectTaskDest() {
            const resp = await fetch('/api/pick_folder');
            const data = await resp.json();
            if(data.path) {
                document.getElementById('task-dest').value = data.path;
            }
        }
        
        let isBackupActive = false;
        
        let eventSource = null;
        let sseRetryCount = 0;
        
        function setSSEStatus(mode, delayMs) {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('console-status-text');
            if(!ind || !txt) return;
            if(isBackupActive) return;
            
            if(mode === 'connected') {
                ind.className = "w-2 h-2 rounded-full bg-emerald-500 transition-colors duration-300";
                txt.innerText = t("console.statusReady", "SYSTEM READY");
                txt.className = "text-[10px] font-black uppercase tracking-widest text-emerald-400";
            } else if(mode === 'reconnecting') {
                ind.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse transition-colors duration-300";
                const seconds = Math.max(0, Math.round((delayMs || 0) / 1000));
                txt.innerText = t("console.connectionLost", "Connection lost. Reconnect in ") + seconds + "s...";
                txt.className = "text-[10px] font-black uppercase tracking-widest text-amber-400";
            } else if(mode === 'disconnected') {
                ind.className = "w-2 h-2 rounded-full bg-red-500 transition-colors duration-300";
                txt.innerText = t("console.connectionError", "Connection error.");
                txt.className = "text-[10px] font-black uppercase tracking-widest text-red-400";
            }
        }
        
        function setupSSE() {
            if(eventSource) eventSource.close();
        
            console.log("Connecting to SSE stream...");
            eventSource = new EventSource('/api/stream');
        
            eventSource.onopen = () => {
                console.log("SSE Connected.");
                sseRetryCount = 0;
                const log = document.getElementById('log');
                if(log && log.lastChild && log.lastChild.innerText.includes("Reconnect")) {
                    addLog(t("console.connectionRestored", "Connection restored."), "success");
                }
                setSSEStatus('connected');
            };

            eventSource.addEventListener('status', (e) => {
                try {
                    lastHeartbeat = Date.now(); // Reset heartbeat
                    const data = JSON.parse(e.data);
                    
                    if(data.log_entry) {
                         // Fallback for combined status+log packets
                         addLog(data.log_entry.replace(/\[.*?\] /, ""), "info"); 
                    }
                    
                    updateStatusUI(data);
                } catch(err) { console.error("SSE Status Parse Error:", err); }
            });

            eventSource.addEventListener('log', (e) => {
                try {
                    lastHeartbeat = Date.now(); // Reset heartbeat
                    const data = JSON.parse(e.data);
                    
                    // Use key for dynamic translation if available
                    if (data.key) {
                        addLog(t(data.key, data.message), data.type, data.key);
                    } else {
                        addLog(t(data.message, data.message), data.type);
                    }

                    // Check for completion messages to trigger reload if needed
                    if (data.message && (data.message.includes("beendet") || data.message.includes("gespeichert"))) {
                        loadData();
                    }
                } catch(err) { console.error("SSE Log Parse Error:", err); }
            });
            
            eventSource.onmessage = (e) => {
                 // Catch keepalives
                 lastHeartbeat = Date.now();
            };

            eventSource.onerror = (err) => {
                if(eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                sseRetryCount++;
                const backoff = [0, 1000, 2000, 5000, 10000, 20000, 30000];
                const idx = Math.min(sseRetryCount - 1, backoff.length - 1);
                const delay = backoff[idx];
                console.log(`Retrying SSE in ${delay}ms (Attempt ${sseRetryCount})...`);
                
                // Don't show UI update for the first instant retry to prevent flickering
                if (sseRetryCount > 1) {
                    if(sseRetryCount > 5) {
                        setSSEStatus('disconnected');
                        const log = document.getElementById('log');
                        if(log && log.lastChild && !log.lastChild.innerText.includes("Reconnect")) {
                            addLog(t("console.connectionLost", "Connection lost. Reconnect in ") + (delay/1000) + "s...", "warn");
                        }
                    } else {
                        setSSEStatus('reconnecting', delay);
                    }
                }
                
                setTimeout(setupSSE, delay);
            };
        }
        
        // Heartbeat Monitor (Fallback if SSE hangs silently)
        let lastHeartbeat = Date.now();
        setInterval(() => {
            if(isBackupActive && (Date.now() - lastHeartbeat > 20000)) {
                 console.warn("SSE Heartbeat missing during backup. Force Reconnecting...");
                 lastHeartbeat = Date.now();
                 setSSEStatus('reconnecting', 0);
                 setupSSE();
            } else if (!isBackupActive && (Date.now() - lastHeartbeat > 45000)) {
                 console.warn("SSE Heartbeat missing (idle). Reconnecting...");
                 lastHeartbeat = Date.now();
                 setSSEStatus('reconnecting', 0);
                 setupSSE();
            }
        }, 5000);

        function updateStatusUI(sData) {
            // --- Module Status Helper ---
            const updateModule = (modName, msg, pct, err) => {
                const area = document.getElementById(`status-area-${modName}`);
                if(area) {
                    area.classList.remove('hidden');
                    const waitLabel = t("console.statusWaiting", "Waiting...");
                    document.getElementById(`status-msg-${modName}`).innerText = msg || waitLabel;
                    document.getElementById(`status-pct-${modName}`).innerText = (pct || 0) + "%";
                    document.getElementById(`status-bar-${modName}`).style.width = (pct || 0) + "%";
                    
                    const errDiv = document.getElementById(`status-err-${modName}`);
                    if(err && err.includes("Fehler")) {
                        errDiv.innerText = err;
                        errDiv.classList.remove('hidden');
                    } else {
                        errDiv.classList.add('hidden');
                    }
                }
            };

            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('console-status-text');

            if (sData.active) {
                isBackupActive = true;
                
                // Update Progress (nur setzen, wenn g√ºltiger Wert vorhanden ist)
                const bar = document.getElementById('zipBar');
                const pctEl = document.getElementById('zipPercent');
                if (typeof sData.progress === "number" && !isNaN(sData.progress)) {
                    const pctVal = sData.progress;
                    if (bar) bar.style.width = pctVal + "%";
                    if (pctEl) pctEl.innerText = pctVal + "%";
                }
                
                // Update Console Status
                if(ind) ind.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse transition-colors duration-300";
                if(txt) {
                    const runningLabel = t("console.statusBackupRunning", "BACKUP RUNNING...");
                    txt.innerText = sData.message ? sData.message.substring(0, 40) : runningLabel;
                    txt.className = "text-[10px] font-black uppercase tracking-widest text-blue-400";
                }
                
                // Update specific module status based on step
                const step = sData.step || "";
                const msg = sData.message || "";
                const pct = sData.progress || 0;
                
                if (step.includes('github')) {
                    updateModule('github', msg, pct, msg.includes("Fehler") ? msg : null);
                } else if (step.includes('database')) {
                    updateModule('db', msg, pct, msg.includes("Fehler") ? msg : null);
                } else if (step.includes('cloud')) {
                    updateModule('cloud-tresor', msg, pct, msg.includes("Fehler") ? msg : null);
                }
                
            } else if (isBackupActive && !sData.active) {
                // Backup gerade beendet - 100% anzeigen
                document.getElementById('zipBar').style.width = "100%";
                document.getElementById('zipPercent').innerText = "100%";
                
                // Update Console Status - Success
                if(ind) ind.className = "w-2 h-2 rounded-full bg-green-500 transition-colors duration-300";
                if(txt) {
                    txt.innerText = t("console.statusDone", "COMPLETED");
                    txt.className = "text-[10px] font-black uppercase tracking-widest text-green-400";
                }
                
                // Update modules to 100% / Done before hiding
                ['github', 'db', 'cloud-tresor'].forEach(m => {
                    const area = document.getElementById(`status-area-${m}`);
                    if(area && !area.classList.contains('hidden')) {
                        document.getElementById(`status-pct-${m}`).innerText = "100%";
                        document.getElementById(`status-bar-${m}`).style.width = "100%";
                        document.getElementById(`status-msg-${m}`).innerText = "Fertig.";
                    }
                });
                
                setTimeout(() => {
                    isBackupActive = false;
                    
                    // Reset Status to Idle
                    if(ind) ind.className = "w-2 h-2 rounded-full bg-slate-600 transition-colors duration-300";
                    if(txt) {
                        txt.innerText = t("console.statusReady", "SYSTEM READY");
                        txt.className = "text-[10px] font-black uppercase tracking-widest text-slate-400";
                    }
                    
                    // Reset Bar
                    document.getElementById('zipBar').style.width = "0%";
                    document.getElementById('zipPercent').innerText = "0%";
                    
                    // Hide module status areas (EXCEPT Cloud, which should stay visible)
                ['github', 'db'].forEach(m => {
                    const area = document.getElementById(`status-area-${m}`);
                    if(area) area.classList.add('hidden');
                });
                    
                    loadData(); // Sicherstellen dass Tabelle aktuell ist
                }, 2000);
            }
        }

        async function globalPoll() {
            return; // DEPRECATED: Replaced by SSE logic (setupSSE)
            try {
                // 1. Events Polling
                const eResp = await fetch('/api/get_events');
                if (eResp.ok) {
                    const events = await eResp.json();
                    events.forEach(e => addLog(e.message, e.type));
                    // Wenn Events da waren, ggf. Daten aktualisieren (z.B. nach Backup)
                    if (events.length > 0 && events.some(e => e.message.includes("beendet") || e.message.includes("gespeichert"))) {
                         loadData(); 
                    }
                }

                // 2. Status Polling
                const sResp = await fetch('/api/get_backup_status');
                if (sResp.ok) {
                    const sData = await sResp.json();
                    
                    updateStatusUI(sData);
                    /*
                    // --- Module Status Helper ---
                    const updateModule = (modName, msg, pct, err) => {
                        const area = document.getElementById(`status-area-${modName}`);
                        if(area) {
                            area.classList.remove('hidden');
                            document.getElementById(`status-msg-${modName}`).innerText = msg || "Warte...";
                            document.getElementById(`status-pct-${modName}`).innerText = (pct || 0) + "%";
                            document.getElementById(`status-bar-${modName}`).style.width = (pct || 0) + "%";
                            
                            const errDiv = document.getElementById(`status-err-${modName}`);
                            if(err && err.includes("Fehler")) {
                                errDiv.innerText = err;
                                errDiv.classList.remove('hidden');
                            } else {
                                errDiv.classList.add('hidden');
                            }
                        }
                    };

                    if (sData.active) {
                        isBackupActive = true;
                        // document.getElementById('zipProgressArea').classList.remove('hidden');
                        // document.getElementById('cancel-btn').classList.remove('hidden');
                        document.getElementById('zipBar').style.width = sData.progress + "%";
                        document.getElementById('zipPercent').innerText = sData.progress + "%";
                        
                        // Update specific module status based on step
                        const step = sData.step || "";
                        const msg = sData.message || "";
                        const pct = sData.progress || 0;
                        
                        if (step.includes('github')) {
                            updateModule('github', msg, pct, msg.includes("Fehler") ? msg : null);
                        } else if (step.includes('database')) {
                            updateModule('db', msg, pct, msg.includes("Fehler") ? msg : null);
                        } else if (step.includes('cloud')) {
                            updateModule('cloud-tresor', msg, pct, msg.includes("Fehler") ? msg : null);
                        }
                        
                    } else if (isBackupActive && !sData.active) {
                        // Backup gerade beendet - 100% anzeigen
                        document.getElementById('zipBar').style.width = "100%";
                        document.getElementById('zipPercent').innerText = "100%";
                        
                        // Update modules to 100% / Done before hiding
                         ['github', 'db', 'cloud-tresor'].forEach(m => {
                            const area = document.getElementById(`status-area-${m}`);
                            if(area && !area.classList.contains('hidden')) {
                                document.getElementById(`status-pct-${m}`).innerText = "100%";
                                document.getElementById(`status-bar-${m}`).style.width = "100%";
                                document.getElementById(`status-msg-${m}`).innerText = "Fertig.";
                            }
                        });
                        
                        setTimeout(() => {
                            isBackupActive = false;
                            // document.getElementById('zipProgressArea').classList.add('hidden');
                            // document.getElementById('cancel-btn').classList.add('hidden');
                            
                            // Hide module status areas
                            ['github', 'db', 'cloud-tresor'].forEach(m => {
                                const area = document.getElementById(`status-area-${m}`);
                                if(area) area.classList.add('hidden');
                            });
                            
                            loadData(); // Sicherstellen dass Tabelle aktuell ist
                        }, 2000);
                    }
                    */
                }
            } catch(e) { console.error("Global Poll Error", e); }
            
            setTimeout(globalPoll, 2000); // 2 Sekunden Intervall
        }

        // --- Startup Check ---
        
        async function initStartupCheck() {
            try {
                const resp = await fetch('/api/get_startup_tasks');
                const data = await resp.json();
                
                if(data.tasks && data.tasks.length > 0) {
                    showStartupModal(data.tasks);
                }
            } catch(e) { console.error("Startup Check Error:", e); }
        }

        async function initBackupPlan() {
            try {
                const listEl = document.getElementById('backup-plan-list');
                const badgeEl = document.getElementById('plan-count-badge');
                if (!listEl || !badgeEl) return;
                
                const resp = await fetch('/api/backup_plan');
                if (!resp.ok) return;
                const data = await resp.json();
                
                if (!data || !data.enabled || !data.events || data.events.length === 0) {
                    listEl.innerHTML = `<div class="text-[10px] text-slate-600 italic text-center py-4" data-i18n="dashboard.planEmpty">${t("dashboard.planEmpty", "Keine aktiven Pl√§ne")}</div>`;
                    badgeEl.innerText = "0";
                    return;
                }
                
                const events = data.events;
                badgeEl.innerText = events.length;
                
                const lang = (window.BP_LANG || 'de').toLowerCase();
                const locale = lang === 'en' ? 'en-GB' : 'de-DE';
                
                let html = '';
                
                events.forEach(ev => {
                    const dt = new Date(ev.ts * 1000);
                    const now = new Date();
                    const diffMs = dt - now;
                    
                    // Format Date
                    const sameDay = dt.toDateString() === now.toDateString();
                    const timeStr = dt.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                    let dateLabel = "";
                    
                    if (sameDay) {
                        const todayWord = t("dashboard.nextBackupToday", lang === 'en' ? "Today" : "Heute");
                        dateLabel = lang === 'en' ? `${todayWord}, ${timeStr}` : `${todayWord}, ${timeStr} Uhr`;
                    } else {
                        const dateStr = dt.toLocaleDateString(locale, { day: '2-digit', month: '2-digit' });
                        dateLabel = lang === 'en' ? `${dateStr} ${timeStr}` : `${dateStr} - ${timeStr} Uhr`;
                    }
                    
                    // Relative Time (e.g. "in 5 min")
                    let relLabel = "";
                    const diffMin = Math.ceil(diffMs / 60000);
                    if (diffMin <= 0) {
                        relLabel = t("dashboard.planNow", "Jetzt");
                    } else if (diffMin < 60) {
                        relLabel = `in ${diffMin} min`;
                    } else {
                        const h = Math.floor(diffMin / 60);
                        const m = diffMin % 60;
                        relLabel = `in ${h}h ${m}min`;
                    }
                    
                    const isGlobal = ev.type === 'global';
                    const icon = isGlobal ? 'üåê' : 'üìã';
                    const name = isGlobal ? t("dashboard.planGlobalName", "Globales Backup") : ev.name;
                    const intervalLabel = ev.interval > 0 ? `(${ev.interval} min)` : '';
                    
                    html += `
                    <div class="flex items-center justify-between p-2 rounded bg-white/5 border border-white/5 hover:border-blue-500/30 transition-colors group">
                        <div class="flex items-center gap-3">
                            <span class="text-sm opacity-50 group-hover:opacity-100 transition-opacity">${icon}</span>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-slate-300">${name} <span class="text-[9px] text-slate-600 font-mono">${intervalLabel}</span></span>
                                <span class="text-[9px] font-mono text-blue-400">${dateLabel}</span>
                            </div>
                        </div>
                        <div class="text-[9px] font-black text-slate-500 bg-black/20 px-1.5 py-0.5 rounded uppercase tracking-wider">
                            ${relLabel}
                        </div>
                    </div>
                    `;
                });
                
                listEl.innerHTML = html;
                
            } catch(e) {
                console.error("Backup plan load failed:", e);
            }
        }

        async function initIntegrityStatus() {
            try {
                const resp = await fetch('/api/integrity_status');
                if (!resp.ok) return;
                const data = await resp.json();
                const dot = document.getElementById('integrity-dot');
                const txt = document.getElementById('integrity-text');
                if (!dot || !txt) return;
                let key = "dashboard.integrityUnknown";
                let dotClass = "w-2 h-2 rounded-full bg-slate-500";
                let textClass = "text-[10px] font-mono text-slate-400";
                if (data && typeof data.missing_files === "number" && typeof data.orphaned_files === "number") {
                    if (data.missing_files > 0) {
                        key = "dashboard.integrityError";
                        dotClass = "w-2 h-2 rounded-full bg-red-500";
                        textClass = "text-[10px] font-mono text-red-400";
                    } else if (data.orphaned_files > 0) {
                        key = "dashboard.integrityWarn";
                        dotClass = "w-2 h-2 rounded-full bg-amber-500";
                        textClass = "text-[10px] font-mono text-amber-400";
                    } else if (typeof data.total_db_entries === "number") {
                        key = "dashboard.integrityOk";
                        dotClass = "w-2 h-2 rounded-full bg-emerald-500";
                        textClass = "text-[10px] font-mono text-emerald-400";
                    }
                }
                dot.className = dotClass;
                txt.className = textClass;
                txt.innerText = t(key, key);
            } catch(e) {
                console.error("Integrity status load failed:", e);
            }
        }
        
        function showStartupModal(tasks) {
            const listHtml = tasks.map(t => `<li class="text-blue-400 font-bold">‚Ä¢ ${t}</li>`).join('');
            const modalHtml = `
            <div id="startup-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm">
                <div class="bg-[#0f111a] border border-blue-500/30 rounded-2xl w-[500px] shadow-[0_0_50px_rgba(59,130,246,0.2)] overflow-hidden animate-bounce-in">
                    <div class="bg-gradient-to-r from-blue-900/20 to-transparent p-6 border-b border-white/5">
                        <h3 class="text-xl font-black text-white flex items-center gap-3">
                            <span class="text-2xl">üöÄ</span>
                            AUTO-TASKS ERKANNT
                        </h3>
                    </div>
                    <div class="p-8">
                        <p class="text-slate-300 mb-4 text-sm leading-relaxed">
                            Es wurden <strong class="text-white">${tasks.length} aktive Tasks</strong> gefunden, die automatisch ausgef√ºhrt werden sollen.
                        </p>
                        <div class="bg-[#08090d] rounded-lg p-4 border border-white/5 mb-6 max-h-40 overflow-y-auto custom-scrollbar">
                            <ul class="space-y-2 text-xs font-mono">
                                ${listHtml}
                            </ul>
                        </div>
                        <p class="text-slate-400 text-xs italic mb-8">
                            M√∂chten Sie diese Backups jetzt sofort starten?
                        </p>
                        
                        <div class="flex gap-4">
                            <button onclick="runStartupTasks()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-blue-500/20 transition-all text-sm uppercase tracking-wider flex justify-center items-center gap-2">
                                <span>Starten</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </button>
                            <button onclick="closeStartupModal()" class="flex-1 bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white font-bold py-3 px-4 rounded-lg border border-white/5 transition-all text-sm uppercase tracking-wider">
                                Nein, sp√§ter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function runStartupTasks() {
            closeStartupModal();
            addLog("Starte automatische Tasks...", "info");
            try {
                const resp = await fetch('/api/run_startup_tasks', { method: 'POST' });
                const data = await resp.json();
                if(data.status === 'started') {
                    addLog("Startup-Tasks initiiert.", "success");
                }
            } catch(e) {
                addLog("Fehler beim Starten der Tasks.", "error");
            }
        }
        
        function closeStartupModal() {
            const m = document.getElementById('startup-modal');
            if(m) m.remove();
        }

        function applyTheme(theme) {
            const root = document.getElementById('bp-root');
            if(!root) return;
            const icon = document.getElementById('theme-icon');
            const label = document.getElementById('theme-label');
            if(theme === 'light') {
                root.classList.add('theme-light');
                if(icon) icon.innerText = '‚òÄÔ∏è';
                if(label) label.innerText = 'Light';
            } else {
                root.classList.remove('theme-light');
                if(icon) icon.innerText = 'üåô';
                if(label) label.innerText = 'Dark';
            }
            try { localStorage.setItem('bp_theme', theme); } catch(e) {}
            try { renderActivityChart(); } catch(e) {}
        }

        function toggleTheme() {
            const root = document.getElementById('bp-root');
            if(!root) return;
            const isLight = root.classList.contains('theme-light');
            applyTheme(isLight ? 'dark' : 'light');
        }

        function t(key, fallback) {
            const dict = window.BP_I18N_DICT || null;
            if (dict && Object.prototype.hasOwnProperty.call(dict, key)) {
                return dict[key];
            }
            return fallback !== undefined ? fallback : key;
        }

        async function initLanguage() {
            const lang = window.BP_LANG || 'de';
            try {
                const resp = await fetch(`/api/lang?code=${encodeURIComponent(lang)}`);
                if (!resp.ok) return;
                const dict = await resp.json();
                window.BP_I18N_DICT = dict;
                applyTranslations(dict);
            } catch(e) {
                console.error("Language init failed:", e);
            }
        }

        function applyTranslations(dict) {
            if (!dict) return;
            // Content
            const nodes = document.querySelectorAll('[data-i18n]');
            nodes.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key || !(key in dict)) return;
                const val = dict[key];
                if (typeof val !== 'string') return;
                if (val.indexOf('<') !== -1) {
                    el.innerHTML = val;
                } else {
                    el.textContent = val;
                }
            });
            // Placeholders
            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (key && (key in dict)) {
                    el.setAttribute('placeholder', dict[key]);
                }
            });
            // Titles
            const titles = document.querySelectorAll('[data-i18n-title]');
            titles.forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (key && (key in dict)) {
                    el.setAttribute('title', dict[key]);
                }
            });
        }

        window.addEventListener('beforeunload', function (e) {
            if(isBackupActive) {
                e.preventDefault();
                e.returnValue = ''; // Standard for Chrome
            }
        });
        
        window.onload = async () => { 
            console.log("Window loaded. Initializing...");
            await initLanguage();
            addLog(t("console.terminalReady", "Terminal initialisiert. System bereit."), "success", "console.terminalReady");

            let storedTheme = 'dark';
            try {
                const t = localStorage.getItem('bp_theme');
                if(t === 'light' || t === 'dark') storedTheme = t;
            } catch(e) {}
            applyTheme(storedTheme);


            // Restore History Limit immediately
            // currentLimit is already set globally

            // Prevent accidental reload if backup is active (Old method cleanup)
            // window.onbeforeunload handled via addEventListener above
            
            // Add click listener to Limit Dropdown to ensure focus
            const limitSel = document.getElementById('history-limit');
            if(limitSel) {
                limitSel.addEventListener('change', window.updateHistoryLimit);
                // Sync UI with global currentLimit immediately
                limitSel.value = (currentLimit === 999999) ? 'all' : currentLimit;
            }
            
            // Attach listeners to cloud tresor inputs for real-time badge update
            const cloudTresorInputs = document.querySelectorAll('#module-cloud-tresor input, #module-cloud-tresor select');
            cloudTresorInputs.forEach(el => {
                el.addEventListener('input', updateCloudTresorUI);
                el.addEventListener('change', updateCloudTresorUI);
            });

            const langBtn = document.getElementById('config-language-button');
            if (langBtn) {
                langBtn.addEventListener('click', async () => {
                    const current = window.BP_LANG || 'de';
                    const next = current === 'de' ? 'en' : 'de';
                    window.BP_LANG = next;
                    try {
                        const resp = await fetch(`/api/lang?code=${encodeURIComponent(next)}`);
                        if (resp.ok) {
                            const dict = await resp.json();
                            window.BP_I18N_DICT = dict;
                            applyTranslations(dict);
                            
                            // Persist language setting
                            fetch('/api/save_config', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ language: next })
                            }).catch(err => console.error("Failed to save language:", err));
                        }
                    } catch(e) {
                        console.error("Language toggle failed:", e);
                    }
                });
            }

            setTimeout(() => {
                try { loadData(); } catch(e) { console.error("LoadData failed:", e); }
                try { loadTasks(); } catch(e) { console.error("LoadTasks failed:", e); }
                try { initIntegrityStatus(); } catch(e) { console.error("Integrity init failed:", e); }
                try { initBackupPlan(); } catch(e) { console.error("Backup plan init failed:", e); }
                
                // Initial Status Sync (f√ºr Tabs/Reloads)
                fetch('/api/get_backup_status')
                    .then(r => r.json())
                    .then(data => {
                        updateStatusUI(data);
                        if(data.active) addLog(t("console.syncActive", "Laufendes Backup erkannt. Synchronisiere..."), "info");
                    })
                    .catch(e => console.error("Initial Status Sync failed:", e));

                setupSSE();
                setTimeout(initStartupCheck, 6000);
            }, 100);

            // --- SortableJS Integration ---
            try {
                const dashboardGrid = document.getElementById('dashboard-modules');
                if (dashboardGrid) {
                    // 1. Determine Order (Server Config > LocalStorage > Default)
                    let order = null;
                    
                    // Try Server Config first
                    if (window.BP_CONFIG && window.BP_CONFIG.dashboard_order && Array.isArray(window.BP_CONFIG.dashboard_order)) {
                        order = window.BP_CONFIG.dashboard_order;
                        // console.log("Restoring layout from Server Config");
                    } 
                    // Fallback to LocalStorage
                    else {
                        const savedOrder = localStorage.getItem('dashboard-order');
                        if (savedOrder) {
                            try {
                                order = JSON.parse(savedOrder);
                                // console.log("Restoring layout from LocalStorage");
                            } catch(e) {}
                        }
                    }

                    // Apply Order
                    if (order) {
                        const currentModules = Array.from(dashboardGrid.children);
                        const moduleMap = {};
                        currentModules.forEach(el => {
                            if(el.dataset.id) moduleMap[el.dataset.id] = el;
                        });
                        
                        // Re-append in saved order
                        order.forEach(id => {
                            if (moduleMap[id]) {
                                dashboardGrid.appendChild(moduleMap[id]);
                            }
                        });
                    }

                    // 2. Init Sortable
                    if(typeof Sortable !== 'undefined') {
                        Sortable.create(dashboardGrid, {
                            animation: 150,
                            // handle: '.cursor-move', // Optional: restrict to handle
                            filter: 'input, button, select, textarea, .no-drag',
                            preventOnFilter: false,
                            ghostClass: 'opacity-50', 
                            onSort: function (evt) {
                                const order = Array.from(dashboardGrid.children)
                                    .map(el => el.dataset.id)
                                    .filter(id => id !== undefined);
                                
                                // Save to LocalStorage
                                localStorage.setItem('dashboard-order', JSON.stringify(order));
                                
                                // Save to Server Config
                                fetch('/api/save_config', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ dashboard_order: order })
                                }).catch(e => console.error("Error saving layout:", e));
                            }
                        });
                    } else {
                        console.warn("SortableJS not loaded.");
                    }
                }
            } catch(e) {
                console.error("SortableJS Init failed:", e);
            }

            // Init chart separately
            try { initChart(); } catch(e) { console.error("Chart Init failed:", e); }
        };
    </script>
</body>
</html>
